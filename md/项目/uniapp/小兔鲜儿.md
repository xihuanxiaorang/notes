## 介绍

> 项目文档地址：[小兔鲜儿小程序 | uniapp+vue3+ts](https://megasu.gitee.io/uni-app-shop-note/)
> 项目代码仓库地址：[小兔鲜儿-vue3+ts-uniapp-2023新版: 小兔鲜儿-vue3+ts-uniapp 项目已上线，小程序搜索《小兔鲜儿》即可体验。🎉🎉🎉 <br/> 配套项目接口文档，配套笔记。](https://gitee.com/Megasu/uniapp-shop-vue3-ts)

- 最新技术栈：基于 uni-app 多端开发框架，采用 Vue3 + TS + Pinia + UniUI 的最新组合开发，编码符合 ESLint + Prettierrc + Git Hooks 团队规范。
- 最佳的实践：Vue3+TS 组合式 API 最佳实践，开发主流微信小程序端并打包上线，同时兼容 H5 端，App 端。
- 最多的业务：涵盖了猜你喜欢、热门推荐、商品分类、商品详情、微信登录、用户管理、地址管理、购物车管理、订单管理等功能。包含微信登录，微信支付等业务。

## 项目起步

### 资料说明

- 📀视频学习：[黑马程序员前端项目uniapp小兔鲜儿微信小程序项目视频教程，基于Vue3+Ts+Pinia+uni-app的最新组合技术栈开发的电商业务全流程\_哔哩哔哩\_bilibili](https://www.bilibili.com/video/BV1Bp4y1379L/)
- 📗接口文档：[apifox.com/apidoc/shared-0e6ee326-d646-41bd-9214-29dbf47648fa/](https://www.apifox.cn/apidoc/shared-0e6ee326-d646-41bd-9214-29dbf47648fa/)
- ✏️在线笔记：[小兔鲜儿小程序 | uniapp+vue3+ts](https://megasu.gitee.io/uni-app-shop-note/)
- 📦项目源码：[小兔鲜儿-vue3+ts-uniapp-2023新版: 小兔鲜儿-vue3+ts-uniapp 项目已上线，小程序搜索《小兔鲜儿》即可体验。🎉🎉🎉 <br/> 配套项目接口文档，配套笔记。](https://gitee.com/Megasu/uniapp-shop-vue3-ts/)

### 拉取项目模板代码

```bash
git clone -b template https://gitee.com/heima-fe/uniapp-shop-vue3-ts.git heima-shop
```

项目模板包含：目录结构，项目素材，代码风格。

> [!attention]
> 小程序真机预览需在 `manifest.json` 中添加微信小程序的 `appid`

---

基于 [uniapp+vue3+ts项目模板搭建](uniapp+vue3+ts项目模板搭建.md) 创建的项目模板进行开发，主要是为了测试一下咱们创建的项目模板是否好用，其实两者之间相差不大，只不过咱们创建的项目模板增加了其他诸如 commitlint、commitizen 等插件，然后拉取下来的模板中包含项目素材，咱们拷贝过来即可。

### uni-request 请求封装

1. uniapp 拦截器： [uni.addInterceptor](https://uniapp.dcloud.net.cn/api/interceptor.html)
   1. 拼接基础地址
   2. 设置超时时间
   3. 添加请求头标识
   4. 添加 token
2. 封装 Promise 请求函数
  1. 返回 Promise 对象，用于处理返回值类型
  2. 成功 resolve
      1. 提取数据
      2. 添加泛型
  3. 失败 reject
      1. 401 错误
      2. 其他错误
      3. 网络错误

具体实现如下所示：

```typescript
import { useMemberStore } from '@/store/modules/member';

// 请求基地址
const baseURL = 'https://pcapi-xiaotuxian-front-devtest.itheima.net';

// 拦截器配置
const httpInterceptor = {
	// 拦截前触发
	invoke(options: UniApp.RequestOptions) {
		// 1. 非 http 开头需拼接地址
		if (!options.url.startsWith('http')) {
			options.url = baseURL + options.url;
		}
		// 2. 请求超时
		options.timeout = 10000;
		// 3. 添加小程序端请求头标识
		options.header = {
			'source-client': 'miniapp',
			...options.header,
		};
		// 4. 添加 token 请求头标识
		const memberStore = useMemberStore();
		const token = memberStore.profile?.token;
		if (token !== undefined) {
			options.header.Authorization = token;
		}
	},
};

// 拦截 request 请求
uni.addInterceptor('request', httpInterceptor);
// 拦截 uploadFile 文件上传
uni.addInterceptor('uploadFile', httpInterceptor);

/**
 * 请求函数
 * @param  UniApp.RequestOptions
 * @returns Promise
 *  1. 返回 Promise 对象
 *  2. 获取数据成功
 *    2.1 提取核心数据 res.data
 *    2.2 添加类型，支持泛型
 *  3. 获取数据失败
 *    3.1 401错误  -> 清理用户信息，跳转到登录页
 *    3.2 其他错误 -> 根据后端错误信息轻提示
 *    3.3 网络错误 -> 提示用户换网络
 */
interface Result<T> {
	code: string;
	msg: string;
	result: T;
}
// 2.2 添加类型，支持泛型
export const http = async <T>(options: UniApp.RequestOptions) => {
	// 1. 返回 Promise 对象
	return await new Promise<Result<T>>((resolve, reject) => {
		uni.request({
			...options,
			// 响应成功
			success(res) {
				// 状态码 2xx， axios 就是这样设计的
				if (res.statusCode >= 200 && res.statusCode < 300) {
					// 2.1 提取核心数据 res.data
					resolve(res.data as Result<T>);
				} else if (res.statusCode === 401) {
					// 401错误  -> 清理用户信息，跳转到登录页
					const memberStore = useMemberStore();
					memberStore.clearProfile();
					uni.navigateTo({ url: '/pages/login/login' });
					reject(res);
				} else {
					// 其他错误 -> 根据后端错误信息轻提示
					uni.showToast({
						icon: 'none',
						title: (res.data as Result<T>).msg || '请求错误',
					});
					reject(res);
				}
			},
			// 响应失败
			fail(err) {
				uni.showToast({
					icon: 'none',
					title: '网络错误，换个网络试试',
				});
				reject(err);
			},
		});
	});
};
```
