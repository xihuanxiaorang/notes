# å¾®ä¿¡å…¬ä¼—å·å¼€å‘

## éœ€æ±‚

è¦å€ŸåŠ©å¾®ä¿¡å…¬ä¼—å·ç»™ç³»ç»Ÿä¸­çš„ç”¨æˆ·å‘é€é€šçŸ¥ï¼Œå…¶ä¸­è‡³å…³é‡è¦çš„ä¸€æ­¥å°±æ˜¯å°†å…¬ä¼—å·ç”¨æˆ·ä¸ç³»ç»Ÿç”¨æˆ·ç»‘å®šèµ·æ¥ã€‚è¿™æ ·åœ¨ç³»ç»Ÿéœ€è¦å‘é€é€šçŸ¥ç»™æŸä¸ªç”¨æˆ·æ—¶ï¼Œå°±å¯ä»¥çŸ¥é“åº”è¯¥å¯¹å“ªä¸ªå…³æ³¨äº†å…¬ä¼—å·çš„ç”¨æˆ·å‘é€é€šçŸ¥ã€‚

## å¼€å‘ç¯å¢ƒæ­å»º

1. ç™»é™†å¾®ä¿¡å…¬ä¼—å¹³å°æµ‹è¯•å· [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login) <br />![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022251007.png)

2. å¡«å†™æµ‹è¯•å·ä¸­æ¥å£é…ç½®ä¿¡æ¯ <br />![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022251713.png)
      1. å…¶ä¸­ URL `http://e3fnyv.natappfree.cc/wx/mp/portal/appid`ä¸­çš„ appid æ•´ä¸ªæ›¿æ¢æˆæœ¬äººæµ‹è¯•å·çš„ appID å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <br />![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022252206.png)
      1. Token å¯ä»¥éšæ„å¡«å†™ï¼Œä¸åšè¦æ±‚ã€‚
      1. ç‚¹å‡»æäº¤é…ç½®ï¼Œå‘ç°æ²¡æœ‰ä»»ä½•æ•ˆæœï¼é‚£æ˜¯å› ä¸ºæ­¤æ—¶è¿˜æ²¡æœ‰å¯åŠ¨åç«¯æœåŠ¡ï¼Œæ‰€ä»¥å’±ä»¬å¾—å…ˆå»å¯åŠ¨åç«¯æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰åç«¯æœåŠ¡çš„å°ä¼™ä¼´å¯ä»¥å‚è€ƒä»¥ä¸‹æ­¥éª¤æ­å»ºä¸€ä¸ªåç«¯æœåŠ¡ã€‚ç‚¹å‡»æäº¤é…ç½®çš„æ—¶å€™ä¼šæŠŠè¿™ä¸ª token å‘é€åˆ°å¾®ä¿¡å¹³å°ï¼Œç„¶åå¾®ä¿¡å¹³å°ä¼šè¯·æ±‚æ­¤ URL è°ƒç”¨å¼€å‘çš„å¾®ä¿¡æœåŠ¡ï¼Œä»¥ä¾¿éªŒè¯æœåŠ¡çš„å¯ç”¨æ€§å’Œåˆæ³•æ€§ã€‚ç¡®ä¿å·²å¯åŠ¨å†…ç½‘ç©¿é€ [å†…ç½‘ç©¿é€å·¥å…·](../å¼€å‘è€…å·¥å…·/å†…ç½‘ç©¿é€å·¥å…·.md)ï¼Œå¦åˆ™ä¸ä¼šæœ‰ä»»ä½•ååº”ï¼


3. å¼•å…¥ä¾èµ– `wx-java-mp-spring-boot-starter`

   ```xml
   <dependency>
      <groupId>com.github.binarywang</groupId>
      <artifactId>wx-java-mp-spring-boot-starter</artifactId>
      <version>4.4.0</version>
   </dependency>
   ```

4. åœ¨ application.yml æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­å¢åŠ å¦‚ä¸‹é…ç½®ä¿¡æ¯ï¼Œå…¶ä¸­ï¼Œappid å’Œ appsecret å¡«å†™æœ¬äººæµ‹è¯•å·çš„ï¼Œè‡³äº token ä¸ä½ å¡«å†™çš„æ¥å£é…ç½®ä¿¡æ¯ä¸­çš„ Token ä¸€è‡´å³å¯ã€‚

   ```yaml
   wx:
     mp:
       app-id: xxxxx
       secret: xxxxx
       token: xiaorang
   ```
5. å¾®ä¿¡å…¬ä¼—å·æ¥å£å›è°ƒï¼Œå‚è€ƒè‡ª WxJava å…³äºå¾®ä¿¡å…¬ä¼—å·å¼€å‘çš„ [ç¤ºä¾‹ä»£ç ](https://github.com/binarywang/weixin-java-mp-demo/blob/master/src/main/java/com/github/binarywang/demo/wx/mp/controller/WxPortalController.java)

   ```java
   @RestController
   @RequestMapping("/wx/mp/portal/{appid}")
   public class WxPortalController {
       private static final Logger LOGGER = LoggerFactory.getLogger(WxPortalController.class);
       private final WxMpService wxService;
   
       public WxPortalController(WxMpService wxService) {
           this.wxService = wxService;
       }
   
       /**
        * å¼€å‘è€…è®¤è¯æ¥å£
        *
        * @param appid
        * @param signature
        * @param timestamp
        * @param nonce
        * @param echostr
        * @return
        */
       @GetMapping(produces = "text/plain;charset=utf-8")
       public String authGet(@PathVariable String appid,
                             @RequestParam(name = "signature", required = false) String signature,
                             @RequestParam(name = "timestamp", required = false) String timestamp,
                             @RequestParam(name = "nonce", required = false) String nonce,
                             @RequestParam(name = "echostr", required = false) String echostr) {
   
           LOGGER.info("\næ¥æ”¶åˆ°æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨çš„è®¤è¯æ¶ˆæ¯ï¼š[{}, {}, {}, {}]", signature,
                   timestamp, nonce, echostr);
           if (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) {
               throw new IllegalArgumentException("è¯·æ±‚å‚æ•°éæ³•ï¼Œè¯·æ ¸å®!");
           }
   
           if (!this.wxService.switchover(appid)) {
               throw new IllegalArgumentException(String.format("æœªæ‰¾åˆ°å¯¹åº”appid=[%s]çš„é…ç½®ï¼Œè¯·æ ¸å®ï¼", appid));
           }
   
           if (wxService.checkSignature(timestamp, nonce, signature)) {
               return echostr;
           }
   
           return "éæ³•è¯·æ±‚";
       }
   }
   ```


## æ¥æ”¶ä¸å“åº”æ¶ˆæ¯

### æ¶ˆæ¯å¤„ç†å™¨æ¥å£

WxJava é’ˆå¯¹ä¸åŒç±»å‹çš„å¾®ä¿¡æ¶ˆæ¯è¿›è¡Œåˆ†ç±»å¤„ç†ï¼Œç”¨æˆ·éœ€è¦å®ç°ä¸åŒç±»å‹çš„æ¶ˆæ¯å¤„ç†å™¨ï¼Œæ¶ˆæ¯å¤„ç†å™¨éœ€è¦å®ç° `WxMpMessageHandler` æ¥å£ã€‚
```java
/**
 * å¤„ç†å¾®ä¿¡æ¨é€æ¶ˆæ¯çš„å¤„ç†å™¨æ¥å£.
 *
 */
public interface WxMpMessageHandler {

  /**
   * å¤„ç†å¾®ä¿¡æ¨é€æ¶ˆæ¯.
   *
   * @param wxMessage      å¾®ä¿¡æ¨é€æ¶ˆæ¯
   * @param context        ä¸Šä¸‹æ–‡ï¼Œå¦‚æœhandleræˆ–interceptorä¹‹é—´æœ‰ä¿¡æ¯è¦ä¼ é€’ï¼Œå¯ä»¥ç”¨è¿™ä¸ª
   * @param wxMpService    æœåŠ¡ç±»
   * @param sessionManager sessionç®¡ç†å™¨
   * @return xmlæ ¼å¼çš„æ¶ˆæ¯ï¼Œå¦‚æœåœ¨å¼‚æ­¥è§„åˆ™é‡Œå¤„ç†çš„è¯ï¼Œå¯ä»¥è¿”å›null
   * @throws WxErrorException å¼‚å¸¸
   */
  WxMpXmlOutMessage handle(WxMpXmlMessage wxMessage,
                           Map<String, Object> context,
                           WxMpService wxMpService,
                           WxSessionManager sessionManager) throws WxErrorException;

}
```
### å…³æ³¨ä¸å–æ¶ˆå…³æ³¨äº‹ä»¶

1. å®ç°ä¸€ä¸ªæ¥æ”¶å…³æ³¨ã€å–æ¶ˆå…³æ³¨äº‹ä»¶æ¨é€çš„æ¶ˆæ¯å¤„ç†å™¨ã€‚é¦–å…ˆéœ€è¦å®šä¹‰å…³æ³¨å’Œå–æ¶ˆå…³æ³¨çš„æ¶ˆæ¯å¤„ç†å™¨å­˜å…¥ Spring å®¹å™¨ã€‚

   ```java
   @Component
   public class WxMpSubscribeHandler implements WxMpMessageHandler {
       private static final Logger LOGGER = LoggerFactory.getLogger(WxMpSubscribeHandler.class);
   
       @Override
       public WxMpXmlOutMessage handle(WxMpXmlMessage wxMessage, Map<String, Object> context, WxMpService wxMpService, WxSessionManager sessionManager) throws WxErrorException {
           LOGGER.info("æ–°å…³æ³¨ç”¨æˆ·: {}", wxMessage.getFromUser());
           try {
               // è·å–å¾®ä¿¡ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
               WxMpUser userWxInfo = wxMpService.getUserService().userInfo(wxMessage.getFromUser(), null);
               if (userWxInfo != null) {
                   // TODO å¯ä»¥æ·»åŠ å…³æ³¨ç”¨æˆ·åˆ°æœ¬åœ°æ•°æ®åº“
                   LOGGER.info("ç”¨æˆ·ä¿¡æ¯: {}", userWxInfo);
               }
               return WxMpXmlOutMessage.TEXT().fromUser(wxMessage.getToUser()).toUser(wxMessage.getFromUser())
                       .content("æ¬¢è¿å…³æ³¨ï¼").build();
           } catch (WxErrorException e) {
               if (e.getError().getErrorCode() == 48001) {
                   LOGGER.info("è¯¥å…¬ä¼—å·æ²¡æœ‰è·å–ç”¨æˆ·ä¿¡æ¯æƒé™ï¼");
               }
           }
           return null;
       }
   }
   ```

   ```java
   @Component
   public class WxMpUnSubscribeHandler implements WxMpMessageHandler {
       private static final Logger LOGGER = LoggerFactory.getLogger(WxMpUnSubscribeHandler.class);
   
       @Override
       public WxMpXmlOutMessage handle(WxMpXmlMessage wxMessage, Map<String, Object> context, WxMpService wxMpService,
                                       WxSessionManager sessionManager) {
           LOGGER.info("ç”¨æˆ·å–æ¶ˆå…³æ³¨: {}", wxMessage.getFromUser());
           // TODO å¯ä»¥æ›´æ–°æœ¬åœ°æ•°æ®åº“ä¸ºå–æ¶ˆå…³æ³¨çŠ¶æ€
           // å› ä¸ºå·²ç»å–æ¶ˆå…³æ³¨ï¼Œæ‰€ä»¥å³ä½¿å›å¤æ¶ˆæ¯ä¹Ÿæ”¶ä¸åˆ°
           return null;
       }
   }
   ```
2. é…ç½®æ¶ˆæ¯è·¯ç”±è§„åˆ™

   ```java
   @Configuration
   public class WeiXinMpConfig {
   	private final WxMpService wxMpService;
   	private final WxMpSubscribeHandler wxMpSubscribeHandler;
   	private final WxMpUnSubscribeHandler wxMpUnSubscribeHandler;
   
   	public WeiXinMpConfig(WxMpService wxMpService, WxMpSubscribeHandler wxMpSubscribeHandler,
   			WxMpUnSubscribeHandler wxMpUnSubscribeHandler) {
   		this.wxMpService = wxMpService;
   		this.wxMpSubscribeHandler = wxMpSubscribeHandler;
   		this.wxMpUnSubscribeHandler = wxMpUnSubscribeHandler;
   	}
   
   	@Bean
   	public WxMpMessageRouter wxMpMessageRouter() {
   		final WxMpMessageRouter router = new WxMpMessageRouter(wxMpService);
   		router.rule().async(false).msgType(WxConsts.XmlMsgType.EVENT).event(WxConsts.EventType.SUBSCRIBE)
   				.handler(wxMpSubscribeHandler).end();
   		router.rule().async(false).msgType(WxConsts.XmlMsgType.EVENT).event(WxConsts.EventType.UNSUBSCRIBE)
   				.handler(wxMpUnSubscribeHandler).end();
   		return router;
   	}
   }
   ```
3. åœ¨ WxPortalController æ§åˆ¶å™¨ä¸­å¢åŠ å¦‚ä¸‹æ–¹æ³•ç”¨äºæ¥æ”¶å¾®ä¿¡è¯·æ±‚ï¼Œå‚è€ƒè‡ª WxJava å…³äºå¾®ä¿¡å…¬ä¼—å·å¼€å‘çš„ [ç¤ºä¾‹ä»£ç ](https://github.com/binarywang/weixin-java-mp-demo/blob/master/src/main/java/com/github/binarywang/demo/wx/mp/controller/WxPortalController.java)

   ```java
   /**
    * æ¥æ”¶äº‹ä»¶æ¶ˆæ¯æ¥å£
    *
    * @param appid
    * @param requestBody
    * @param signature
    * @param timestamp
    * @param nonce
    * @param openid
    * @param encType
    * @param msgSignature
    * @return
    */
   @PostMapping(produces = "application/xml; charset=UTF-8")
   public String handleMessage(@PathVariable String appid, @RequestBody String requestBody, @RequestParam("signature") String signature, @RequestParam("timestamp") String timestamp, 
                               @RequestParam("nonce") String nonce, @RequestParam("openid") String openid, @RequestParam(name = "encrypt_type", required = false) String encType, 
                               @RequestParam(name = "msg_signature", required = false) String msgSignature) {
       LOGGER.info("\næ¥æ”¶å¾®ä¿¡è¯·æ±‚ï¼š[openid=[{}], [signature=[{}], encType=[{}], msgSignature=[{}]," + " timestamp=[{}], nonce=[{}], requestBody=[\n{}\n] ", 
                   openid, signature, encType, msgSignature, timestamp, nonce, requestBody);
   
       if (!wxMpService.switchover(appid)) {
           throw new IllegalArgumentException(String.format("æœªæ‰¾åˆ°å¯¹åº”appid=[%s]çš„é…ç½®ï¼Œè¯·æ ¸å®ï¼", appid));
       }
   
       if (!wxMpService.checkSignature(timestamp, nonce, signature)) {
           throw new IllegalArgumentException("éæ³•è¯·æ±‚ï¼Œå¯èƒ½å±äºä¼ªé€ çš„è¯·æ±‚ï¼");
       }
   
       String out = null;
       if (encType == null) {
           // æ˜æ–‡ä¼ è¾“çš„æ¶ˆæ¯
           WxMpXmlMessage inMessage = WxMpXmlMessage.fromXml(requestBody);
           WxMpXmlOutMessage outMessage = this.route(inMessage);
           if (outMessage == null) {
               return "";
           }
   
           out = outMessage.toXml();
       } else if ("aes".equalsIgnoreCase(encType)) {
           // aesåŠ å¯†çš„æ¶ˆæ¯
           WxMpXmlMessage inMessage = WxMpXmlMessage.fromEncryptedXml(requestBody, wxMpService.getWxMpConfigStorage(), timestamp, nonce, msgSignature);
           LOGGER.debug("\næ¶ˆæ¯è§£å¯†åå†…å®¹ä¸ºï¼š\n{} ", inMessage.toString());
           WxMpXmlOutMessage outMessage = this.route(inMessage);
           if (outMessage == null) {
               return "";
           }
   
           out = outMessage.toEncryptedXml(wxMpService.getWxMpConfigStorage());
       }
   
       LOGGER.debug("\nç»„è£…å›å¤ä¿¡æ¯ï¼š{}", out);
       return out;
   }
   
   private WxMpXmlOutMessage route(WxMpXmlMessage message) {
       try {
           return messageRouter.route(message);
       } catch (Exception e) {
           LOGGER.error("è·¯ç”±æ¶ˆæ¯æ—¶å‡ºç°å¼‚å¸¸ï¼", e);
       }
       return null;
   }
   ```
4. æµ‹è¯•ï¼Œå½“ç”¨æˆ·æ‰«ç å…³æ³¨å’Œå–æ¶ˆå…³æ³¨æ—¶çš„æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022254306.png" alt="image.png" style="zoom: 80%;" /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022254563.png" alt="e191219839c1c4503205e1f8ede3c74.png" style="zoom: 33%;" /><br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022255301.png" alt="image.png" style="zoom:80%;" />

## å…¬ä¼—å·ç”¨æˆ·ä¸ç³»ç»Ÿç”¨æˆ·ç»‘å®šğŸ¯

å…¶å®åœ¨ [å¾®ä¿¡å…¬ä¼—å·æ–‡æ¡£](https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html) ä¸­å·²ç»ç»™å‡ºäº†ç­”æ¡ˆï¼Œä¸ºäº†æ»¡è¶³ç”¨æˆ·æ¸ é“æ¨å¹¿åˆ†æå’Œ**ç”¨æˆ·å¸å·ç»‘å®š**ç­‰åœºæ™¯çš„éœ€è¦ï¼Œå…¬ä¼—å¹³å°æä¾›äº†ç”Ÿæˆå¸¦å‚æ•°äºŒç»´ç çš„æ¥å£ã€‚ä½¿ç”¨è¯¥æ¥å£å¯ä»¥è·å¾—å¤šä¸ªå¸¦ä¸åŒåœºæ™¯å€¼çš„äºŒç»´ç ï¼Œç”¨æˆ·æ‰«æåï¼Œå…¬ä¼—å·å¯ä»¥æ¥æ”¶åˆ°äº‹ä»¶æ¨é€ã€‚

### æ•´ä½“æµç¨‹

```plantuml
@startuml
start
:ç™»é™†ç½‘ç«™ PC ç«¯;
:è¿›å…¥ç”¨æˆ·ç®¡ç†åˆ—è¡¨;
:ç‚¹å‡»æ¯ä¸ªç”¨æˆ·ä¸Šç”¨äºç»‘å®šå¾®ä¿¡å…¬ä¼—å·çš„æŒ‰é’®;
:å¼¹æ¡†å‡ºç°ä¸€ä¸ªäºŒç»´ç ï¼ˆå¸¦ä¸Šåœºæ™¯å€¼ï¼‰;
:ç”¨æˆ·æ‰«æå…³æ³¨è¯¥å…¬ä¼—å·;
if (åˆ¤æ–­è¯¥å¾®ä¿¡ç”¨æˆ·æ˜¯å¦å·²ç»å…³æ³¨è¿‡è¯¥å…¬ä¼—å·?) then (å¦)
  :ç‚¹å‡»å…³æ³¨å…¬ä¼—å·;
  :åç«¯æ¥æ”¶å¾®ä¿¡æœåŠ¡å™¨æ¨é€çš„å…³æ³¨äº‹ä»¶;
else (æ˜¯)
  :åç«¯æ¥æ”¶å¾®ä¿¡æœåŠ¡å™¨æ¨é€çš„æ‰«æäº‹ä»¶;
endif
:åç«¯æ ¹æ®åœºæ™¯å€¼ï¼ˆå³å½“å‰éœ€è¦ç»‘å®šçš„ç³»ç»Ÿç”¨æˆ·ç¼–å·ï¼‰ä¸å¾®ä¿¡ç”¨æˆ·çš„ openId ç»‘å®šåœ¨ä¸€èµ·;
:åç«¯åˆ†åˆ«ç»™å¾®ä¿¡å…¬ä¼—å·å’Œç½‘ç«™å‰ç«¯é¡µé¢è¿”å› "ç»‘å®šæˆåŠŸ" çš„æç¤º;
stop
@enduml
```

ä¸€æ¬¡å®Œæ•´çš„ç»‘å®šæµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·ç™»å½•ç½‘ç«™ï¼Œè¿›å…¥ç”¨æˆ·ç®¡ç†åˆ—è¡¨ï¼Œç‚¹å‡»æ¯ä¸ªç”¨æˆ·ä¸Šç”¨äºç»‘å®šå¾®ä¿¡å…¬ä¼—å·çš„æŒ‰é’®ï¼›
2. åç«¯ä½¿ç”¨å¾®ä¿¡æ¥å£ï¼Œç”Ÿæˆä¸€ä¸ªäºŒç»´ç é“¾æ¥è¿”å›ç»™å‰ç«¯å¼¹æ¡†æ˜¾ç¤ºï¼Œå¹¶å¸¦ä¸Šåœºæ™¯å€¼(å³å½“å‰ç»‘å®šçš„ç”¨æˆ·ç¼–å·)ï¼›
3. å¦‚æœç”¨æˆ·è¿˜æœªå…³æ³¨å…¬ä¼—å·ï¼Œç”¨æˆ·æ‰«æäºŒç»´ç ï¼Œå¹¶ç‚¹å‡»å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼›åç«¯æ¥æ”¶åˆ°çš„æ˜¯å¾®ä¿¡æœåŠ¡å™¨æ¨é€çš„**å…³æ³¨äº‹ä»¶**ï¼Œæ‹¿åˆ°åœºæ™¯å€¼ï¼›
4. å¦‚æœç”¨æˆ·å·²ç»å…³æ³¨å…¬ä¼—å·ï¼Œç”¨æˆ·æ‰«æäºŒç»´ç ï¼Œç›´æ¥è¿›å…¥å…¬ä¼—å·ä¼šè¯ï¼›åç«¯æ¥æ”¶åˆ°çš„æ˜¯æ¥æ”¶å¾®ä¿¡æœåŠ¡å™¨æ¨é€çš„**æ‰«æäº‹ä»¶**ï¼Œæ‹¿åˆ°åœºæ™¯å€¼ï¼›
5. åç«¯å°†åœºæ™¯å€¼(å³å½“å‰ç»‘å®šçš„ç”¨æˆ·ç¼–å·)ä¸å¾®ä¿¡ç”¨æˆ·çš„openIdç»‘å®šèµ·æ¥ï¼›
6. ç»™å¾®ä¿¡å…¬ä¼—å·è¿”å›"ç»‘å®šæˆåŠŸ"çš„æç¤ºï¼›
7. é€šçŸ¥ç½‘ç«™å‰å°é¡µé¢ï¼Œæç¤º"ç»‘å®šæˆåŠŸ"ï¼Œåˆ·æ–°é¡µé¢ï¼Œå¹¶è¿”å›ä¸€äº›å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯ã€‚

### ç”Ÿæˆå¸¦å‚æ•°çš„äºŒç»´ç 

> [https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html](https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html)

ä¸ºäº†æ»¡è¶³ç”¨æˆ·æ¸ é“æ¨å¹¿åˆ†æå’Œ**ç”¨æˆ·å¸å·ç»‘å®š**ç­‰åœºæ™¯çš„éœ€è¦ï¼Œå…¬ä¼—å¹³å°æä¾›äº†ç”Ÿæˆå¸¦å‚æ•°äºŒç»´ç çš„æ¥å£ã€‚ä½¿ç”¨è¯¥æ¥å£å¯ä»¥è·å¾—å¤šä¸ªå¸¦ä¸åŒåœºæ™¯å€¼çš„äºŒç»´ç ï¼Œç”¨æˆ·æ‰«æåï¼Œå…¬ä¼—å·å¯ä»¥æ¥æ”¶åˆ°äº‹ä»¶æ¨é€ã€‚<br />ç›®å‰æœ‰2ç§ç±»å‹çš„äºŒç»´ç ï¼š

1. **ä¸´æ—¶äºŒç»´ç **ï¼Œæ˜¯æœ‰è¿‡æœŸæ—¶é—´çš„ï¼Œæœ€é•¿å¯ä»¥è®¾ç½®ä¸ºåœ¨äºŒç»´ç ç”Ÿæˆåçš„**30å¤©**ï¼ˆå³2592000ç§’ï¼‰åè¿‡æœŸï¼Œä½†èƒ½å¤Ÿç”Ÿæˆè¾ƒå¤šæ•°é‡ã€‚**ä¸´æ—¶äºŒç»´ç ä¸»è¦ç”¨äºå¸å·ç»‘å®šç­‰ä¸è¦æ±‚äºŒç»´ç æ°¸ä¹…ä¿å­˜çš„ä¸šåŠ¡åœºæ™¯**ï¼›
2. **æ°¸ä¹…äºŒç»´ç **ï¼Œæ˜¯æ— è¿‡æœŸæ—¶é—´çš„ï¼Œä½†æ•°é‡è¾ƒå°‘ï¼ˆç›®å‰ä¸ºæœ€å¤š10ä¸‡ä¸ªï¼‰ã€‚**æ°¸ä¹…äºŒç»´ç ä¸»è¦ç”¨äºé€‚ç”¨äºå¸å·ç»‘å®šã€ç”¨æˆ·æ¥æºç»Ÿè®¡ç­‰åœºæ™¯**ã€‚

ç”¨æˆ·æ‰«æå¸¦åœºæ™¯å€¼äºŒç»´ç æ—¶ï¼Œå¯èƒ½æ¨é€ä»¥ä¸‹ä¸¤ç§äº‹ä»¶ï¼š

1. å¦‚æœ**ç”¨æˆ·è¿˜æœªå…³æ³¨å…¬ä¼—å·**ï¼Œåˆ™ç”¨æˆ·å¯ä»¥å…³æ³¨å…¬ä¼—å·ï¼Œå…³æ³¨åå¾®ä¿¡ä¼šå°†**å¸¦åœºæ™¯å€¼çš„<u>å…³æ³¨äº‹ä»¶</u>æ¨é€ç»™å¼€å‘è€…**
2. å¦‚æœ**ç”¨æˆ·å·²ç»å…³æ³¨å…¬ä¼—å·**ï¼Œåœ¨ç”¨æˆ·æ‰«æåä¼šè‡ªåŠ¨è¿›å…¥ä¼šè¯ï¼Œå¾®ä¿¡ä¹Ÿä¼šå°†**å¸¦åœºæ™¯å€¼çš„<u>æ‰«æäº‹ä»¶</u>æ¨é€ç»™å¼€å‘è€…**

è·å–å¸¦å‚æ•°ï¼ˆåœºæ™¯å€¼ï¼Œå³å½“å‰éœ€è¦ç»‘å®šçš„ç³»ç»Ÿç”¨æˆ·ç¼–å·ï¼‰çš„äºŒç»´ç çš„è¿‡ç¨‹åŒ…æ‹¬ä¸¤æ­¥ã€‚é¦–å…ˆåˆ›å»ºäºŒç»´ç  ticketï¼Œç„¶åå‡­å€Ÿ ticket åˆ°æŒ‡å®š URL æ¢å–äºŒç»´ç ã€‚

#### åˆ›å»ºäºŒç»´ç ticket

æ¯æ¬¡åˆ›å»ºäºŒç»´ç  ticket éœ€è¦æä¾›ä¸€ä¸ªå¼€å‘è€…è‡ªè¡Œè®¾å®šçš„å‚æ•°ï¼ˆscene_idï¼‰ï¼Œåˆ†åˆ«ä»‹ç»ä¸´æ—¶äºŒç»´ç å’Œæ°¸ä¹…äºŒç»´ç çš„åˆ›å»ºäºŒç»´ç  ticket è¿‡ç¨‹ã€‚

1. ä¸´æ—¶äºŒç»´ç è¯·æ±‚è¯´æ˜ï¼š

   httpè¯·æ±‚æ–¹å¼: POST URL: https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=TOKEN <br />POSTæ•°æ®æ ¼å¼ï¼šjson POSTæ•°æ®ä¾‹å­ï¼š{"expire_seconds": 604800, "action_name": "QR_SCENE", "action_info": {"scene": {"scene_id": 123}}} <br />æˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹POSTæ•°æ®åˆ›å»ºå­—ç¬¦ä¸²å½¢å¼çš„äºŒç»´ç å‚æ•°ï¼š{"expire_seconds": 604800, "action_name": "QR_STR_SCENE", "action_info": {"scene": {"scene_str": "test"}}}

2. æ°¸ä¹…äºŒç»´ç è¯·æ±‚è¯´æ˜ï¼š

   httpè¯·æ±‚æ–¹å¼: POST URL: https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=TOKEN <br />POSTæ•°æ®æ ¼å¼ï¼šjson POSTæ•°æ®ä¾‹å­ï¼š{"action_name": "QR_LIMIT_SCENE", "action_info": {"scene": {"scene_id": 123}}} <br />æˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹POSTæ•°æ®åˆ›å»ºå­—ç¬¦ä¸²å½¢å¼çš„äºŒç»´ç å‚æ•°ï¼š {"action_name": "QR_LIMIT_STR_SCENE", "action_info": {"scene": {"scene_str": "test"}}}<br />å‚æ•°è¯´æ˜ï¼š

| å‚æ•° | è¯´æ˜ |
| --- | --- |
| expire_seconds | è¯¥äºŒç»´ç æœ‰æ•ˆæ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚ æœ€å¤§ä¸è¶…è¿‡2592000ï¼ˆå³30å¤©ï¼‰ï¼Œæ­¤å­—æ®µå¦‚æœä¸å¡«ï¼Œåˆ™é»˜è®¤æœ‰æ•ˆæœŸä¸º30ç§’ã€‚ |
| action_name | äºŒç»´ç ç±»å‹ï¼ŒQR_SCENEä¸ºä¸´æ—¶çš„æ•´å‹å‚æ•°å€¼ï¼ŒQR_STR_SCENEä¸ºä¸´æ—¶çš„å­—ç¬¦ä¸²å‚æ•°å€¼ï¼ŒQR_LIMIT_SCENEä¸ºæ°¸ä¹…çš„æ•´å‹å‚æ•°å€¼ï¼ŒQR_LIMIT_STR_SCENEä¸ºæ°¸ä¹…çš„å­—ç¬¦ä¸²å‚æ•°å€¼ |
| action_info | äºŒç»´ç è¯¦ç»†ä¿¡æ¯ |
| scene_id | åœºæ™¯å€¼IDï¼Œä¸´æ—¶äºŒç»´ç æ—¶ä¸º32ä½é0æ•´å‹ï¼Œæ°¸ä¹…äºŒç»´ç æ—¶æœ€å¤§å€¼ä¸º100000ï¼ˆç›®å‰å‚æ•°åªæ”¯æŒ1--100000ï¼‰ |
| scene_str | åœºæ™¯å€¼IDï¼ˆå­—ç¬¦ä¸²å½¢å¼çš„IDï¼‰ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œé•¿åº¦é™åˆ¶ä¸º1åˆ°64 |

å¯ä»¥é€šè¿‡ [å¾®ä¿¡å…¬ä¼—å¹³å°æ¥å£è°ƒè¯•å·¥å…·](https://mp.weixin.qq.com/debug/cgi-bin/apiinfo) æµ‹è¯•ä¸€ä¸‹ï¼Œå…ˆè°ƒç”¨è·å–acess_tokençš„æ¥å£è·å– tokenï¼Œå†è°ƒç”¨åˆ›å»ºäºŒç»´ç  ticket æ¥å£åˆ›å»ºä¸€ä¸ªå¸¦åœºæ™¯å€¼çš„ä¸´æ—¶äºŒç»´ç ï¼Œè¿”å›ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022314562.png" alt="image.png"  /><br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022314202.png" alt="image.png"  />

å‚æ•°è¯´æ˜ï¼š

| å‚æ•° | è¯´æ˜ |
| --- | --- |
| ticket | è·å–çš„äºŒç»´ç ticketï¼Œå‡­å€Ÿæ­¤ticketå¯ä»¥åœ¨æœ‰æ•ˆæ—¶é—´å†…æ¢å–äºŒç»´ç ã€‚ |
| expire_seconds | è¯¥äºŒç»´ç æœ‰æ•ˆæ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚ æœ€å¤§ä¸è¶…è¿‡2592000ï¼ˆå³30å¤©ï¼‰ã€‚ |
| url | äºŒç»´ç å›¾ç‰‡è§£æåçš„åœ°å€ï¼Œå¼€å‘è€…å¯æ ¹æ®è¯¥åœ°å€è‡ªè¡Œç”Ÿæˆéœ€è¦çš„äºŒç»´ç å›¾ç‰‡ |

#### é€šè¿‡ticketæ¢å–äºŒç»´ç 

è·å–äºŒç»´ç ticketåï¼Œå¼€å‘è€…å¯ç”¨ticketæ¢å–äºŒç»´ç å›¾ç‰‡ã€‚è¯·æ³¨æ„ï¼Œæœ¬æ¥å£æ— é¡»ç™»å½•æ€å³å¯è°ƒç”¨ã€‚<br />è¯·æ±‚è¯´æ˜ï¼šHTTP GETè¯·æ±‚ï¼ˆè¯·ä½¿ç”¨httpsåè®®ï¼‰https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=TICKET æé†’ï¼šTICKETè®°å¾—è¿›è¡ŒUrlEncode<br />è¿”å›ç»“æœï¼šticket æ­£ç¡®æƒ…å†µä¸‹ï¼Œhttp è¿”å›ç æ˜¯200ï¼Œæ˜¯ä¸€å¼ å›¾ç‰‡ï¼Œå¯ä»¥ç›´æ¥å±•ç¤ºæˆ–è€…ä¸‹è½½ã€‚<br />å†é€šè¿‡ [å¾®ä¿¡å…¬ä¼—å¹³å°æ¥å£è°ƒè¯•å·¥å…·](https://mp.weixin.qq.com/debug/cgi-bin/apiinfo) æµ‹è¯•ä¸€ä¸‹ï¼ŒäºŒç»´ç å›¾ç‰‡åœ°å€å°±æ˜¯ä¸‹é¢è¿”å›çš„è¯·æ±‚åœ°å€ã€‚<br />![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022316602.png)<br />ä½¿ç”¨å¾®ä¿¡æ‰«æç”Ÿæˆçš„äºŒç»´ç ä¹‹åï¼Œä¼šè·³è½¬åˆ°å¾®ä¿¡å…¬ä¼—å·ï¼ˆæˆ–è€…å¼€å‘æ—¶ç”¨çš„çš„æµ‹è¯•å·)

1. ç”¨æˆ·å¦‚æœæ²¡æœ‰å…³æ³¨çš„è¯ï¼Œåˆ™ç‚¹å‡»å…³æ³¨æ—¶ï¼Œåç«¯ä¼šæ¥æ”¶åˆ°å¾®ä¿¡æ¨é€è¿‡æ¥çš„**å¸¦åœºæ™¯å€¼(ç³»ç»Ÿç”¨æˆ·ç¼–å·)çš„å…³æ³¨äº‹ä»¶**
2. ç”¨æˆ·å¦‚æœå·²ç»å…³æ³¨è¿‡è¯¥å…¬ä¼—å·ï¼Œåœ¨ç”¨æˆ·æ‰«æè¯¥äºŒç»´ç ä¹‹åä¼šè‡ªåŠ¨è¿›å…¥ä¼šè¯ï¼Œåç«¯æ­¤æ—¶ä¼šæ¥æ”¶åˆ°å¾®ä¿¡æ¨é€è¿‡æ¥çš„**å¸¦åœºæ™¯å€¼(ç³»ç»Ÿç”¨æˆ·ç¼–å·)çš„æ‰«æäº‹ä»¶**

![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022316932.png)
### åŠŸèƒ½å®ç°

1. ç”Ÿæˆå¸¦åœºæ™¯å€¼çš„äºŒç»´ç çš„æ¥å£

   ```java
   @RestController
   @RequestMapping("/wx/mp")
   public class WxMpController {
       private static final Logger LOGGER = LoggerFactory.getLogger(WxMpController.class);
       private final WxMpService wxMpService;
   
       public WxMpController(WxMpService wxMpService) {
           this.wxMpService = wxMpService;
       }
   
       /**
        * ç”Ÿæˆå¸¦åœºæ™¯å€¼çš„äºŒç»´ç 
        *
        * @param userNo ç”¨æˆ·ç¼–å·
        * @return äºŒç»´ç URL
        */
       @GetMapping("/qr-code/{userNo}")
       public String createQrCode(@PathVariable String userNo) throws WxErrorException {
           LOGGER.info("å½“å‰æ­£åœ¨ç»‘å®šå¾®ä¿¡å…¬ä¼—å·çš„ç”¨æˆ·ç¼–å·ä¸º: {}", userNo);
           // è·å–ticketï¼Œæ—¶é—´ä¸å¡«é»˜è®¤30ç§’ï¼Œæœ€å¤§30å¤©
           WxMpQrCodeTicket ticket = this.wxMpService.getQrcodeService().qrCodeCreateTmpTicket(userNo, null);
           // æ ¹æ®ticketåˆ›å»ºä¸´æ—¶äºŒç»´ç 
           return this.wxMpService.getQrcodeService().qrCodePictureUrl(ticket.getTicket());
       }
   }
   ```

   ç³»ç»Ÿç”¨æˆ·åœ¨ç‚¹å‡»ç»‘å®šå¾®ä¿¡å…¬ä¼—å·çš„æŒ‰é’®åï¼Œå‰åå‘è¯·æ±‚è°ƒç”¨è¯¥æ¥å£ï¼Œè¿”å›äºŒç»´ç  URLã€‚å’±ä»¬ä½¿ç”¨ ApiFox æµ‹è¯•ä¸€ä¸‹ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿”å›äºŒç»´ç å›¾ç‰‡åœ°å€ã€‚<br />![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022317987.png)

2. å¢åŠ ç”¨äºç”¨äºå¤„ç†å·²å…³æ³¨ç”¨æˆ·æ‰«æäºŒç»´ç åå¾®ä¿¡æ¨é€è¿‡æ¥çš„**å¸¦åœºæ™¯å€¼çš„æ‰«æäº‹ä»¶**çš„æ¶ˆæ¯å¤„ç†å™¨

   ```java
   @Component
   public class WxMpScanHandler implements WxMpMessageHandler {
       private static final Logger LOGGER = LoggerFactory.getLogger(WxMpScanHandler.class);
   
       @Override
       public WxMpXmlOutMessage handle(WxMpXmlMessage wxMessage, Map<String, Object> map, WxMpService wxMpService, WxSessionManager wxSessionManager) throws WxErrorException {
           LOGGER.info("ç³»ç»Ÿç”¨æˆ·è´¦å·ä¸ºï¼š{}", wxMessage.getEventKey());
           LOGGER.info("openId: {}", wxMessage.getFromUser());
           return WxMpXmlOutMessage.TEXT().content("ç»‘å®šç³»ç»Ÿç”¨æˆ·æˆåŠŸï¼").fromUser(wxMessage.getToUser()).toUser(wxMessage.getFromUser()).build();
       }
   }
   ```

3. å¢åŠ æ¶ˆæ¯è·¯ç”±è§„åˆ™

   ```java
   router.rule().async(false).msgType(EVENT).event(SCAN).handler(scanHandler).end();
   ```
4. æ›´æ–°å…³æ³¨äº‹ä»¶æ¶ˆæ¯å¤„ç†å™¨

   ```java
   @Component
   public class WxMpSubscribeHandler implements WxMpMessageHandler {
       private static final Logger LOGGER = LoggerFactory.getLogger(WxMpSubscribeHandler.class);
   
       @Override
       public WxMpXmlOutMessage handle(WxMpXmlMessage wxMessage, Map<String, Object> context, WxMpService wxMpService, WxSessionManager sessionManager) {
           if (StringUtils.hasText(wxMessage.getEventKey())) {
               // é€šè¿‡æ‰«æå¸¦åœºæ™¯å€¼äºŒç»´ç å…³æ³¨çš„ç”¨æˆ·ï¼Œç”¨äºç³»ç»Ÿç»‘å®šç”¨æˆ·
               LOGGER.info("ç”¨æˆ·ç¼–å·ä¸ºï¼š{}", wxMessage.getEventKey().split("_")[1]);
           }
           LOGGER.info("æ–°ç”¨æˆ·å…³æ³¨ OPENID: {}", wxMessage.getFromUser());
           String uri = "http://e3fnyv.natappfree.cc/wx/mp/APPID/callback";
           uri = uri.replace("APPID", wxMpService.getWxMpConfigStorage().getAppId());
           String href = "æ¬¢è¿å…³æ³¨ï¼<a href=\"" + wxMpService.getOAuth2Service().buildAuthorizationUrl(uri, SNSAPI_USERINFO, wxMpService.getWxMpConfigStorage().getToken()) + "\">è¯·ç‚¹å‡»æ­¤å¤„è¿›è¡Œç½‘é¡µæˆæƒï¼Œæµ‹è¯•ç”¨ï¼ï¼ï¼</a>";
           return WxMpXmlOutMessage.TEXT().content(href).fromUser(wxMessage.getToUser()).toUser(wxMessage.getFromUser()).build();
       }
   }
   ```
5. ç½‘é¡µæˆæƒå›è°ƒæ¥å£

   ```java
   /**
    * ç½‘é¡µæˆæƒå›è°ƒæ¥å£
    *
    * @param appid
    * @param code
    * @param state
    * @return
    * @throws WxErrorException
    */
   @GetMapping("/{appid}/callback")
   public WxOAuth2UserInfo callback(@PathVariable String appid, @RequestParam String code, @RequestParam String state) throws WxErrorException {
       LOGGER.info("\næ¥æ”¶å¾®ä¿¡è¯·æ±‚ï¼š[appid=[{}], code=[{}], state=[{}]]", appid, code, state);
       if (!Objects.equals(state, wxMpService.getWxMpConfigStorage().getToken())) {
           throw new IllegalArgumentException("éæ³•è¯·æ±‚ï¼Œå¯èƒ½å±äºä¼ªé€ çš„è¯·æ±‚ï¼");
       }
       WxOAuth2Service oAuth2Service = wxMpService.getOAuth2Service();
       // åˆ©ç”¨codeè·å–accessToken
       WxOAuth2AccessToken accessToken = oAuth2Service.getAccessToken(code);
       // åˆ©ç”¨accessTokenè·å–ç”¨æˆ·ä¿¡æ¯
       return oAuth2Service.getUserInfo(accessToken, null);
   }
   ```

æµ‹è¯•æµç¨‹ï¼šå…ˆä½¿ç”¨ ApiFox å‘é€ç”Ÿæˆå¸¦åœºæ™¯å€¼çš„äºŒç»´ç çš„è¯·æ±‚ï¼Œè·å–äºŒç»´ç å›¾ç‰‡URLï¼Œä¹‹åç”¨å¾®ä¿¡æ‰«æè¯¥äºŒç»´ç ï¼Œä¼šå‡ºç°å¦‚ä¸‹ä¸¤ç§æƒ…å†µï¼š

- å¦‚æœç”¨æˆ·æ²¡æœ‰å…³æ³¨è¿‡è¯¥å…¬ä¼—å·ï¼ˆæµ‹è¯•å·ï¼‰ï¼Œåˆ™è§¦å‘å…³æ³¨äº‹ä»¶å¤„ç†å™¨ï¼Œè¿”å›æ¬¢è¿å…³æ³¨ï¼å¹¶åœ¨æš—ä¸­å°†å½“å‰ç³»ç»Ÿç”¨æˆ·(userNo)ä¸å¾®ä¿¡ç”¨æˆ·(openid)ç»‘å®šåœ¨ä¸€èµ·ï¼›<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022318839.png" alt="image.png" style="zoom:80%;" /><br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022318030.png" alt="da2de9b012687fb5c9b1ad3d1714765.png" style="zoom:33%;" /><br />ç‚¹å‡»ç½‘é¡µæˆæƒï¼Œå‡ºç°æŠ¥é”™ä¿¡æ¯ï¼Œ redirect_uri åŸŸåä¸åå°é…ç½®ä¸ä¸€è‡´ï¼Œé”™è¯¯ç :10003ã€‚ä¸ç”¨æ…Œï¼Œè¿™ä¸ªä¸œè¥¿ä¸æœ¬æ¬¡éœ€æ±‚å¹¶æ²¡æœ‰å¤šå¤§çš„å…³ç³»ï¼Œæœ‰å¼ºè¿«ç—‡çš„å°ä¼™ä¼´å¯ä»¥å‚è€ƒ [ç½‘é¡µæˆæƒ | å¾®ä¿¡å¼€æ”¾æ–‡æ¡£](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html) æ‰¾åˆ°å…·ä½“çš„è§£å†³æ–¹æ¡ˆã€‚

- å¦‚æœç”¨æˆ·ä»¥å‰å…³æ³¨è¿‡è¯¥å…¬ä¼—å·ï¼ˆæµ‹è¯•å·ï¼‰ï¼Œåˆ™è§¦å‘æ‰«æäº‹ä»¶å¤„ç†å™¨ï¼Œè¿”å›ç»‘å®šç³»ç»Ÿç”¨æˆ·æˆåŠŸï¼<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022319486.png" alt="image.png" style="zoom:80%;" /><br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022319639.png" alt="ba5f9410e6379b8f96007d6db884861.png" style="zoom:33%;" /><br />è‡³æ­¤ï¼Œå…¬ä¼—å·ç”¨æˆ·ä¸ç³»ç»Ÿç”¨æˆ·ç»‘å®šçš„æ•´ä¸ªæµç¨‹å°±å®Œæˆäº†ï¼

## æ¨¡æ¿æ¶ˆæ¯
> [https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Template_Message_Interface.html](https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Template_Message_Interface.html)

æ¨¡æ¿æ¶ˆæ¯ä»…ç”¨äºå…¬ä¼—å·å‘ç”¨æˆ·å‘é€é‡è¦çš„æœåŠ¡é€šçŸ¥ï¼Œåªèƒ½ç”¨äºç¬¦åˆå…¶è¦æ±‚çš„æœåŠ¡åœºæ™¯ä¸­ï¼Œå¦‚ä¿¡ç”¨å¡åˆ·å¡é€šçŸ¥ï¼Œå•†å“è´­ä¹°æˆåŠŸé€šçŸ¥ç­‰ã€‚ä¸æ”¯æŒå¹¿å‘Šç­‰è¥é”€ç±»æ¶ˆæ¯ä»¥åŠå…¶å®ƒæ‰€æœ‰å¯èƒ½å¯¹ç”¨æˆ·é€ æˆéªšæ‰°çš„æ¶ˆæ¯ã€‚<br />å…³äºä½¿ç”¨è§„åˆ™ï¼Œè¯·æ³¨æ„ï¼š

1. æ‰€æœ‰æœåŠ¡å·éƒ½å¯ä»¥åœ¨åŠŸèƒ½->æ·»åŠ åŠŸèƒ½æ’ä»¶å¤„çœ‹åˆ°ç”³è¯·æ¨¡æ¿æ¶ˆæ¯åŠŸèƒ½çš„å…¥å£ï¼Œä½†åªæœ‰**è®¤è¯åçš„æœåŠ¡å·æ‰å¯ä»¥ç”³è¯·æ¨¡æ¿æ¶ˆæ¯çš„ä½¿ç”¨æƒé™å¹¶è·å¾—è¯¥æƒé™**ï¼›
2. éœ€è¦é€‰æ‹©å…¬ä¼—è´¦å·æœåŠ¡æ‰€å¤„çš„2ä¸ªè¡Œä¸šï¼Œæ¯æœˆå¯æ›´æ”¹1æ¬¡æ‰€é€‰è¡Œä¸šï¼›
3. åœ¨æ‰€é€‰æ‹©è¡Œä¸šçš„æ¨¡æ¿åº“ä¸­é€‰ç”¨å·²æœ‰çš„æ¨¡æ¿è¿›è¡Œè°ƒç”¨ï¼›
4. æ¯ä¸ªè´¦å·å¯ä»¥åŒæ—¶ä½¿ç”¨25ä¸ªæ¨¡æ¿ã€‚
5. å½“å‰æ¯ä¸ªè´¦å·çš„æ¨¡æ¿æ¶ˆæ¯çš„**æ—¥è°ƒç”¨ä¸Šé™ä¸º10ä¸‡æ¬¡**ï¼Œå•ä¸ªæ¨¡æ¿æ²¡æœ‰ç‰¹æ®Šé™åˆ¶ã€‚ã€2014å¹´11æœˆ18æ—¥å°†æ¥å£è°ƒç”¨é¢‘ç‡ä»é»˜è®¤çš„æ—¥1ä¸‡æ¬¡æå‡ä¸ºæ—¥10ä¸‡æ¬¡ï¼Œå¯åœ¨MPç™»å½•åçš„å¼€å‘è€…ä¸­å¿ƒæŸ¥çœ‹ã€‘ã€‚å½“è´¦å·ç²‰ä¸æ•°è¶…è¿‡10W/100W/1000Wæ—¶ï¼Œæ¨¡æ¿æ¶ˆæ¯çš„æ—¥è°ƒç”¨ä¸Šé™ä¼šç›¸åº”æå‡ï¼Œä»¥å…¬ä¼—å·MPåå°å¼€å‘è€…ä¸­å¿ƒé¡µé¢ä¸­æ ‡æ˜çš„æ•°å­—ä¸ºå‡†ã€‚

å…³äºæ¥å£æ–‡æ¡£ï¼Œè¯·æ³¨æ„ï¼š

1. æ¨¡æ¿æ¶ˆæ¯è°ƒç”¨æ—¶ä¸»è¦éœ€è¦æ¨¡æ¿IDå’Œæ¨¡æ¿ä¸­å„å‚æ•°çš„èµ‹å€¼å†…å®¹ï¼›
2. æ¨¡æ¿ä¸­å‚æ•°å†…å®¹å¿…é¡»ä»¥".DATA"ç»“å°¾ï¼Œå¦åˆ™è§†ä¸ºä¿ç•™å­—ï¼›
3. æ¨¡æ¿ä¿ç•™ç¬¦å·""ã€‚

### å‘é€æ¨¡æ¿æ¶ˆæ¯

> httpè¯·æ±‚æ–¹å¼: POST https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=ACCESS_TOKEN

POSTæ•°æ®ç¤ºä¾‹å¦‚ä¸‹ï¼š
```json
{
    "touser":"OPENID",
    "template_id":"ngqIpbwh8bUfcSsECmogfXcV14J0tQlEpBO27izEYtY",
    "url":"http://weixin.qq.com/download",  
    "miniprogram":{
        "appid":"xiaochengxuappid12345",
        "pagepath":"index?foo=bar"
        },          
    "data":{
        "first": {
            "value":"æ­å–œä½ è´­ä¹°æˆåŠŸï¼",
            "color":"#173177"
            },
        "keyword1":{
            "value":"å·§å…‹åŠ›",
            "color":"#173177"
            },
        "keyword2": {
            "value":"39.8å…ƒ",
            "color":"#173177"
            },
        "keyword3": {
            "value":"2014å¹´9æœˆ22æ—¥",
            "color":"#173177"
            },
        "remark":{
            "value":"æ¬¢è¿å†æ¬¡è´­ä¹°ï¼",
            "color":"#173177"
            }
    }
}
```
å‚æ•°è¯´æ˜ï¼š

| å‚æ•° | æ˜¯å¦å¿…å¡« | è¯´æ˜ |
| --- | --- | --- |
| touser | **æ˜¯** | æ¥æ”¶è€…openid |
| template_id | **æ˜¯** | æ¨¡æ¿ID |
| url | å¦ | æ¨¡æ¿è·³è½¬é“¾æ¥ï¼ˆæµ·å¤–å¸å·æ²¡æœ‰è·³è½¬èƒ½åŠ›ï¼‰ |
| miniprogram | å¦ | è·³å°ç¨‹åºæ‰€éœ€æ•°æ®ï¼Œä¸éœ€è·³å°ç¨‹åºå¯ä¸ç”¨ä¼ è¯¥æ•°æ® |
| appid | **æ˜¯** | æ‰€éœ€è·³è½¬åˆ°çš„å°ç¨‹åºappidï¼ˆè¯¥å°ç¨‹åºappidå¿…é¡»ä¸å‘æ¨¡æ¿æ¶ˆæ¯çš„å…¬ä¼—å·æ˜¯ç»‘å®šå…³è”å…³ç³»ï¼Œæš‚ä¸æ”¯æŒå°æ¸¸æˆï¼‰ |
| pagepath | å¦ | æ‰€éœ€è·³è½¬åˆ°å°ç¨‹åºçš„å…·ä½“é¡µé¢è·¯å¾„ï¼Œæ”¯æŒå¸¦å‚æ•°,ï¼ˆç¤ºä¾‹index?foo=barï¼‰ï¼Œè¦æ±‚è¯¥å°ç¨‹åºå·²å‘å¸ƒï¼Œæš‚ä¸æ”¯æŒå°æ¸¸æˆ |
| data | **æ˜¯** | æ¨¡æ¿æ•°æ® |
| color | å¦ | æ¨¡æ¿å†…å®¹å­—ä½“é¢œè‰²ï¼Œä¸å¡«é»˜è®¤ä¸ºé»‘è‰² |
| client_msg_id | å¦ | é˜²é‡å…¥idã€‚å¯¹äºåŒä¸€ä¸ªopenid + client_msg_id, åªå‘é€ä¸€æ¡æ¶ˆæ¯,10åˆ†é’Ÿæœ‰æ•ˆ,è¶…è¿‡10åˆ†é’Ÿä¸ä¿è¯æ•ˆæœã€‚è‹¥æ— é˜²é‡å…¥éœ€æ±‚ï¼Œå¯ä¸å¡« |

**æ³¨ï¼šurlå’Œminiprograméƒ½æ˜¯éå¿…å¡«å­—æ®µï¼Œè‹¥éƒ½ä¸ä¼ åˆ™æ¨¡æ¿æ— è·³è½¬ï¼›è‹¥éƒ½ä¼ ï¼Œä¼šä¼˜å…ˆè·³è½¬è‡³å°ç¨‹åºã€‚å¼€å‘è€…å¯æ ¹æ®å®é™…éœ€è¦é€‰æ‹©å…¶ä¸­ä¸€ç§è·³è½¬æ–¹å¼å³å¯ã€‚å½“ç”¨æˆ·çš„å¾®ä¿¡å®¢æˆ·ç«¯ç‰ˆæœ¬ä¸æ”¯æŒè·³å°ç¨‹åºæ—¶ï¼Œå°†ä¼šè·³è½¬è‡³urlã€‚**
### æ·»åŠ æ¨¡æ¿
å¦‚æœæ˜¯è®¤è¯è¿‡åçš„æœåŠ¡å·ï¼Œå¯ä»¥ç™»å½•å¾®ä¿¡å…¬ä¼—å·åå°ç®¡ç†ï¼Œä»æ¨¡æ¿åº“ä¸­æ·»åŠ ï¼Œå¦‚æœæ‰¾ä¸åˆ°é€‚åˆçš„æ¨¡æ¿ï¼Œè¿˜å¯ä»¥ç”³è¯·æ–°æ¨¡æ¿(ä¸€ä¸ªæœˆåªå¯ä»¥ç”³è¯·ä¸‰ä¸ªæ¨¡æ¿)ï¼›ç°åœ¨æµ‹è¯•é˜¶æ®µå¯ä»¥å…ˆåœ¨æµ‹è¯•å·ä¸­æ‰‹åŠ¨æ·»åŠ æ¨¡æ¿æ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```
{{first.DATA}} å•†å®¶åç§°ï¼š{{keyword1.DATA}} å•†å®¶ç”µè¯ï¼š{{keyword2.DATA}} è®¢å•å·ï¼š{{keyword3.DATA}} çŠ¶æ€ï¼š{{keyword4.DATA}} æ€»ä»·ï¼š{{keyword5.DATA}} {{remark.DATA}}
```
![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022319392.png)<br />![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022319089.png)

### åŠŸèƒ½å®ç°

åœ¨ WxMpController æ§åˆ¶å™¨ä¸­å¢åŠ å‘é€æ¨¡æ¿æ¶ˆæ¯æ¥å£ï¼Œå…¶ä¸­ï¼Œæ¥æ”¶è€…openidã€æ¨¡æ¿idã€æ¨¡æ¿è·³è½¬é“¾æ¥ä»¥åŠæ¨¡æ¿æ•°æ®åœ¨æ­¤å¤„å†™æ­»ï¼Œåç»­åœ¨å®é™…é¡¹ç›®ä¸­å¯ä»¥æ ¹æ®éœ€è¦æ¥å¡«å†™ã€‚
```java
/**
 * å‘é€æ¨¡æ¿æ¶ˆæ¯
 *
 * @return
 * @throws WxErrorException
 */
@GetMapping("/template-message/send")
public String sendTemplateMessage() throws WxErrorException {
    LOGGER.info(wxMpService.getAccessToken());
    // å‘é€æ¨¡æ¿æ¶ˆæ¯æ¥å£
    WxMpTemplateMessage templateMessage = WxMpTemplateMessage.builder()
            // æ¥æ”¶è€…openid
            .toUser("oQeyd6s9Sn8Zp9-OmfZwxgCBEK0E")
            // æ¨¡æ¿id
            .templateId("_lHMN4BqWpNlKCZWx7RgNS1bV_SXoYGBxOqUY1bVvRY")
            // æ¨¡æ¿è·³è½¬é“¾æ¥
            .url("https://www.baidu.com").build();
    // æ·»åŠ æ¨¡æ¿æ•°æ®
    templateMessage
		.addData(new WxMpTemplateData("first", "ç”¨é¤æ„‰å¿«å“¦", "#FF00FF"))
		.addData(new WxMpTemplateData("keyword1", "å¾®ä¿¡ç‚¹é¤", "#A9A9A9"))
		.addData(new WxMpTemplateData("keyword2", "13826913333", "#FF00FF"))
		.addData(new WxMpTemplateData("keyword3", "2021081722150001", "#FF00FF"))
		.addData(new WxMpTemplateData("keyword4", "ï¿¥56.5", "#FF00FF"))
		.addData(new WxMpTemplateData("remark", "ç”¨é¤æ„‰å¿«å“¦", "#000000"));
    String msgId = null;
    try {
        // å‘é€æ¨¡æ¿æ¶ˆæ¯
        msgId = wxMpService.getTemplateMsgService().sendTemplateMsg(templateMessage);
        LOGGER.info(wxMpService.getAccessToken());
        LOGGER.warn("Â·==++--Â·æ¨é€å¾®ä¿¡æ¨¡æ¿ä¿¡æ¯ï¼š{}Â·--++==Â·", "æˆåŠŸ");
    } catch (WxErrorException e) {
        System.out.println(wxMpService.getAccessToken());
        LOGGER.warn("Â·==++--Â·æ¨é€å¾®ä¿¡æ¨¡æ¿ä¿¡æ¯ï¼š{}Â·--++==Â·", "å¤±è´¥");
        e.printStackTrace();
    }
    return msgId;
}
```
å…¶ä¸­ï¼Œæ¥æ”¶è€…openidã€æ¨¡æ¿idä»¥åŠæ¨¡æ¿æ•°æ®éƒ½å¯ä»¥åœ¨æµ‹è¯•å·ä¸­æ‰¾åˆ°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br />![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022320047.png)<br />ä½¿ç”¨ ApiFox è¯·æ±‚å‘é€æ¨¡æ¿æ¶ˆæ¯ï¼Œåœ¨å¾®ä¿¡å…¬ä¼—å·å³å¯æ”¶åˆ°å‘é€è¿‡æ¥çš„é€šçŸ¥ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br />![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022321624.png)<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022320988.png" alt="b67c5e8a2912b7d172c09535e8ea53b.png" style="zoom:33%;" /><br />ä»¥ä¸Šæµ‹è¯•ç»“æœéƒ½æ˜¯ä½¿ç”¨æµ‹è¯•å·è°ƒè¯•å‡ºæ¥çš„ï¼Œé‚£ä¹ˆåœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨å…¬å¸æœåŠ¡å·çš„æ—¶ï¼Œè¯¥å¦‚ä½•é…ç½®å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br />![image.png](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202308022321739.png)<br />è‡³æ­¤ï¼Œå¤§åŠŸå‘Šæˆï¼å¹²æ¯ğŸºğŸºğŸº

## å‚è€ƒèµ„æ–™

- å®˜æ–¹æ–‡æ¡£
   - [å¾®ä¿¡å…¬ä¼—å¹³å°æµ‹è¯•å·](https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index)
   - [å…¬ä¼—å·æ–‡æ¡£](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html#0)
   - [å…¬ä¼—å·åå°ç®¡ç†](https://mp.weixin.qq.com/advanced/advanced?action=dev&t=advanced/dev&token=1012990949&lang=zh_CN)
   - [å¾®ä¿¡å…¬ä¼—å¹³å°æ¥å£è°ƒè¯•å·¥å…·](https://mp.weixin.qq.com/debug/cgi-bin/apiinfo)
- [GitHub - Wechat-Group/WxJava: å¾®ä¿¡å¼€å‘ Java SDK ï¼Œæ”¯æŒåŒ…æ‹¬å¾®ä¿¡æ”¯ä»˜ï¼Œå¼€æ”¾å¹³å°ï¼Œå°ç¨‹åºï¼Œä¼ä¸šå¾®ä¿¡ï¼Œå…¬ä¼—å·ç­‰çš„åç«¯å¼€å‘](https://github.com/Wechat-Group/WxJava)
   - [wx-java-mp-demo](https://github.com/binarywang/weixin-java-mp-demo) é¡¹ç›®å®é™…å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥å‚è€ƒè¯¥ç¤ºä¾‹
   - [æ¯”è¾ƒå…¨é¢çš„æ•™ç¨‹](https://blog.csdn.net/weixin_45070175/article/details/118532572)
   - å¾®ä¿¡å…¬ä¼—å·å‘é€æ¨¡æ¿æ¶ˆæ¯æ•™ç¨‹ [1](https://www.cnblogs.com/shouyaya/p/13235897.html) å’Œ [2](https://www.cnblogs.com/runningA/archive/2020/01/24/12221878.html)

