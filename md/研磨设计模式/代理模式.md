# ä»£ç†æ¨¡å¼(Proxy)

## å®šä¹‰

**ä»£ç†æ¨¡å¼**æ˜¯ä¸€ç§<u><span style="background-color: rgb(232, 247, 207);">ç»“æ„å‹</span></u>è®¾è®¡æ¨¡å¼ï¼Œä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚

ä½¿ç”¨ä»£ç†æ¨¡å¼ä¸»è¦æœ‰ä¸¤ä¸ªç›®çš„ï¼šä¸€æ˜¯**ä¿æŠ¤ç›®æ ‡å¯¹è±¡**ï¼ŒäºŒæ˜¯**å¢å¼ºç›®æ ‡å¯¹è±¡**ã€‚

## åˆ†ç±»

- é™æ€ä»£ç†ï¼šåœ¨ç¨‹åºè¿è¡Œå‰å°±å·²ç»å­˜åœ¨ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œä»£ç†ç±»å’Œå§”æ‰˜ç±»çš„å…³ç³»åœ¨è¿è¡Œå‰å°±å·²ç»ç¡®å®šã€‚é’ˆå¯¹æ¯ä¸ªç›®æ ‡ç±»éƒ½éœ€è¦å•ç‹¬å†™ä¸€ä¸ªä»£ç†ç±»ï¼Œä¸€æ—¦æ¥å£ä¸­å¢åŠ æ–°çš„æ–¹æ³•ï¼Œç›®æ ‡ç±»ä¸ä»£ç†ç±»éƒ½éœ€è¦è¿›è¡Œä¿®æ”¹ï¼Œä¸æ»¡è¶³å¼€é—­åŸåˆ™ï¼
- **åŠ¨æ€ä»£ç†**ï¼šç¼–è¯‘å®Œåæ²¡æœ‰ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œè€Œæ˜¯ **åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆå¹¶åŠ è½½åˆ° JVM ä¸­**ã€‚

### é™æ€ä»£ç†

ç±»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š
```plantuml
@startuml

class Client {
  + {static} main(args: String[]): void
}

interface Subject {
	+ request(): void
}

class RealSubject {
	+ request(): void
}

class Proxy {
	- realSubject: Subject
	+ Proxy(realSubject: Subject): void
	- before(): void
	- after() : void
	+ request(): void
}

Client ..> Subject
Client ..> Proxy
Client ..> RealSubject
Subject <|.. Proxy
Subject <|.. RealSubject
Proxy --> RealSubject

@enduml
```

- Subjectï¼šé¡¶å±‚æ¥å£ï¼ŒRealSubject å’Œ Proxy éƒ½éœ€è¦å®ç°è¯¥æ¥å£ï¼›
- RealSubjectï¼šç›®æ ‡ç±»ï¼Œæˆ–è€…è¯´è¢«ä»£ç†ç±»ï¼›
- **Proxy**ï¼šä»£ç†ç±»ï¼Œ**ä»£ç†ç±»ä¸­æŒæœ‰è¢«ä»£ç†ç±»å¯¹è±¡çš„å¼•ç”¨**ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸ä¿®æ”¹ç›®æ ‡ç±»å¯¹è±¡çš„å‰æä¸‹ï¼Œæ‰©å±•ç›®æ ‡ç±»å¯¹è±¡çš„åŠŸèƒ½ï¼›

[Java ä»£ç†æ¨¡å¼è®²è§£å’Œä»£ç ç¤ºä¾‹](https://refactoringguru.cn/design-patterns/proxy/java/example#lang-features) æœ¬æ¡ˆä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨é™æ€ä»£ç†æ¨¡å¼ä¸ºä½æ•ˆçš„ç¬¬ä¸‰æ–¹YouTubeé›†æˆç¨‹åºåº“ä¸­æ·»åŠ å»¶è¿Ÿåˆå§‹åŒ–å’Œç¼“å­˜åŠŸèƒ½ã€‚

1. é¡¶å±‚æ¥å£ï¼šThirdPartyYouTubeLibï¼ŒYouTubeè¿œç¨‹æœåŠ¡æ¥å£

   ```java
   public interface ThirdPartyYouTubeLib {
       /**
        * è·å–çƒ­é—¨è§†é¢‘
        *
        * @return çƒ­é—¨è§†é¢‘é›†åˆ
        */
       Map<String, Video> popularVideos();
   
       /**
        * æ ¹æ®è§†é¢‘idè·å–è§†é¢‘è¯¦ç»†ä¿¡æ¯
        *
        * @param videoId è§†é¢‘id
        * @return è§†é¢‘è¯¦ç»†ä¿¡æ¯
        */
       Video getVideo(String videoId);
   }
   ```
2. ç›®æ ‡ç±»ï¼šThirdPartyYouTubeLibClassï¼ŒYouTubeè¿œç¨‹æœåŠ¡å®ç°

   ```java
   public class ThirdPartyYouTubeLibClass implements ThirdPartyYouTubeLib {
       private static final Logger LOGGER = LoggerFactory.getLogger(ThirdPartyYouTubeLibClass.class);
   
       @Override
       public Map<String, Video> popularVideos() {
           LOGGER.info("-------------------------------");
           connectToServer("https://www.youtube.com");
           return getRandomVideos();
       }
   
       @Override
       public Video getVideo(String videoId) {
           LOGGER.info("-------------------------------");
           connectToServer("https://www.youtube.com/" + videoId);
           return getSomeVideo(videoId);
       }
   
       private Map<String, Video> getRandomVideos() {
           LOGGER.info("å¼€å§‹ä¸‹è½½çƒ­é—¨è§†é¢‘ ... ");
           experienceNetworkLatency();
           Map<String, Video> videoMap = new HashMap<>(5);
           videoMap.put("catzzzzzzzzz", new Video("sadgahasgdas", "Catzzzz.avi"));
           videoMap.put("mkafksangasj", new Video("mkafksangasj", "Dog play with ball.mp4"));
           videoMap.put("dancesvideoo", new Video("asdfas3ffasd", "Dancing video.mpq"));
           videoMap.put("dlsdk5jfslaf", new Video("dlsdk5jfslaf", "Barcelona vs RealM.mov"));
           videoMap.put("3sdfgsd1j333", new Video("3sdfgsd1j333", "Programing lesson#1.avi"));
           LOGGER.info("Done!");
           return videoMap;
       }
   
       private Video getSomeVideo(String videoId) {
           LOGGER.info("å¼€å§‹ä¸‹è½½ {} è§†é¢‘... ", videoId);
           experienceNetworkLatency();
           Video video = new Video(videoId, "Some video title");
           LOGGER.info("Done!");
           return video;
       }
   
       private int random(int min, int max) {
           return min + (int) (Math.random() * ((max - min) + 1));
       }
   
       /**
        * æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        */
       private void experienceNetworkLatency() {
           int randomLatency = random(5, 10);
           for (int i = 0; i < randomLatency; i++) {
               try {
                   Thread.sleep(100);
               } catch (InterruptedException ex) {
                   ex.printStackTrace();
               }
           }
       }
   
       private void connectToServer(String server) {
           LOGGER.info("Connecting to {} ... ", server);
           experienceNetworkLatency();
           LOGGER.info("Connected!");
       }
   }
   ```
3. ä»£ç†ç±»ï¼šYouTubeCacheProxyï¼Œç¼“å­˜ä»£ç†ï¼ŒåŒæ ·å®ç° YouTubeè¿œç¨‹æœåŠ¡æ¥å£ï¼Œåœ¨å…¶å†…éƒ¨æŒæœ‰ä¸€ä¸ªè¢«ä»£ç†ç±»å¯¹è±¡çš„å¼•ç”¨ï¼Œé€šè¿‡æ„é€ æ–¹æ³•æ³¨å…¥è¢«ä»£ç†ç±»å®ä¾‹å¯¹è±¡ï¼›ä¸ºäº†å®ç°ç¼“å­˜çš„åŠŸèƒ½ï¼Œåœ¨å…¶å†…éƒ¨å®šä¹‰ä¸¤ä¸ªé›†åˆä½œä¸ºçƒ­é—¨è§†é¢‘å’Œå…¨éƒ¨è§†é¢‘çš„ç¼“å­˜æ± ã€‚

   ```java
   public class YouTubeCacheProxy implements ThirdPartyYouTubeLib {
       private static final Logger LOGGER = LoggerFactory.getLogger(YouTubeCacheProxy.class);
       private final ThirdPartyYouTubeLib thirdPartyYouTubeLib;
       private final Map<String, Video> cacheAll = new HashMap<>();
       private Map<String, Video> cachePopular = new HashMap<>();
   
       public YouTubeCacheProxy(ThirdPartyYouTubeLib thirdPartyYouTubeLib) {
           this.thirdPartyYouTubeLib = thirdPartyYouTubeLib;
       }
   
       @Override
       public Map<String, Video> popularVideos() {
           if (cachePopular.isEmpty()) {
               cachePopular = thirdPartyYouTubeLib.popularVideos();
           } else {
               LOGGER.info("ä»ç¼“å­˜ä¸­ä¸‹è½½çƒ­é—¨è§†é¢‘");
           }
           return cachePopular;
       }
   
       @Override
       public Video getVideo(String videoId) {
           Video video = cacheAll.get(videoId);
           if (video == null) {
               video = thirdPartyYouTubeLib.getVideo(videoId);
               cacheAll.put(videoId, video);
           } else {
               LOGGER.info("ä»ç¼“å­˜ä¸­ä¸‹è½½ {} è§†é¢‘... ", videoId);
           }
           return video;
       }
   }
   ```
4. åª’ä½“ä¸‹è½½åº”ç”¨ï¼šè°ƒç”¨YouTubeè¿œç¨‹æœåŠ¡æ¥å£è·å–çƒ­é—¨è§†é¢‘æˆ–å•ç‹¬æŸä¸ªè§†é¢‘å¹¶æ¸²æŸ“

   ```java
   public class YouTubeDownloader {
       private static final Logger LOGGER = LoggerFactory.getLogger(YouTubeDownloader.class);
   
       private final ThirdPartyYouTubeLib thirdPartyYouTubeLib;
   
       public YouTubeDownloader(ThirdPartyYouTubeLib thirdPartyYouTubeLib) {
           this.thirdPartyYouTubeLib = thirdPartyYouTubeLib;
       }
   
       public void renderVideoPage(String videoId) {
           Video video = thirdPartyYouTubeLib.getVideo(videoId);
           LOGGER.info("æ¸²æŸ“è§†é¢‘è¯¦æƒ…é¡µé¢");
           LOGGER.info("ID: {}", video.getId());
           LOGGER.info("Title: {}", video.getTitle());
           LOGGER.info("Video: {}", video.getData());
           LOGGER.info("-------------------------------\n");
       }
   
       public void renderPopularVideos() {
           Map<String, Video> list = thirdPartyYouTubeLib.popularVideos();
           LOGGER.info("æ¸²æŸ“çƒ­é—¨è§†é¢‘ä¸“æ é¡µé¢");
           for (Video video : list.values()) {
               LOGGER.info("ID: {}  / Title: {}", video.getId(), video.getTitle());
           }
           LOGGER.info("-------------------------------\n");
       }
   }
   ```
5. å®¢æˆ·ç«¯ï¼šClientï¼Œé€šè¿‡åª’ä½“ä¸‹è½½åº”ç”¨åˆ†åˆ«å¯¹ä¸¤ç§YouTubeè¿œç¨‹æœåŠ¡å®ç°è¿›è¡Œæµ‹è¯•ï¼Œæ¯”è¾ƒåŸç”Ÿå®ç°ä¸ç¼“å­˜ä»£ç†å…·ä½“è€—æ—¶æ—¶é—´

   ```java
   class ApiTest {
       private static final Logger LOGGER = LoggerFactory.getLogger(ApiTest.class);
   
       @Test
       public void test_00() {
           ThirdPartyYouTubeLib thirdPartyYouTubeLib = new ThirdPartyYouTubeLibClass();
           YouTubeDownloader naiveDownloader = new YouTubeDownloader(thirdPartyYouTubeLib);
           YouTubeDownloader smartDownloader =
           new YouTubeDownloader(new YouTubeCacheProxy(thirdPartyYouTubeLib));
       
           long naive = test(naiveDownloader);
           LOGGER.info(
               "--------------------------------------------------------------------------------\n");
           long smart = test(smartDownloader);
           LOGGER.info("é€šè¿‡ç¼“å­˜ä»£ç†å¯ä»¥èŠ‚çº¦ {} ms", (naive - smart));
       }
   
       private long test(YouTubeDownloader downloader) {
           long startTime = System.currentTimeMillis();
   
           // åº”ç”¨ä¸­çš„ç”¨æˆ·è¡Œä¸ºå¦‚ä¸‹ï¼š
           downloader.renderPopularVideos();
           downloader.renderVideoPage("catzzzzzzzzz");
           downloader.renderPopularVideos();
           downloader.renderVideoPage("dancesvideoo");
           // ç”¨æˆ·æœ‰å¯èƒ½ä¼šç»å¸¸è®¿é—®åŒä¸€ä¸ªé¡µé¢
           downloader.renderVideoPage("catzzzzzzzzz");
           downloader.renderVideoPage("someothervid");
       
           long estimatedTime = System.currentTimeMillis() - startTime;
           LOGGER.info("æµ‹è¯•æ€»å…±è€—æ—¶ {} ms", estimatedTime);
           return estimatedTime;
       }
   }
   ```

   æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼šç”±ç»“æœå¯çŸ¥ï¼Œå¦‚æœç”¨æˆ·è¶Šå¤šæ¬¡è®¿é—®ç›¸åŒçš„é¡µé¢ï¼Œç¼“å­˜ä»£ç†çš„ä»·å€¼å°±è¶Šå¤§ï¼

   ```
   2023-05-10 16:51:08.709 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:73 - Connecting to https://www.youtube.com ... 
   2023-05-10 16:51:09.249 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:75 - Connected!
   2023-05-10 16:51:09.249 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:34 - å¼€å§‹ä¸‹è½½çƒ­é—¨è§†é¢‘ ... 
   2023-05-10 16:51:10.337 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:42 - Done!
   2023-05-10 16:51:10.338 [main] INFO  f.x.d.p.s.YouTubeDownloader:35 - æ¸²æŸ“çƒ­é—¨è§†é¢‘ä¸“æ é¡µé¢
   2023-05-10 16:51:10.338 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: mkafksangasj  / Title: Dog play with ball.mp4
   2023-05-10 16:51:10.338 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: sadgahasgdas  / Title: Catzzzz.avi
   2023-05-10 16:51:10.338 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: asdfas3ffasd  / Title: Dancing video.mpq
   2023-05-10 16:51:10.339 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: dlsdk5jfslaf  / Title: Barcelona vs RealM.mov
   2023-05-10 16:51:10.339 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: 3sdfgsd1j333  / Title: Programing lesson#1.avi
   2023-05-10 16:51:10.339 [main] INFO  f.x.d.p.s.YouTubeDownloader:39 - -------------------------------
   2023-05-10 16:51:10.339 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:28 - -------------------------------
   2023-05-10 16:51:10.339 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:73 - Connecting to https://www.youtube.com/catzzzzzzzzz ... 
   2023-05-10 16:51:11.316 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:75 - Connected!
   2023-05-10 16:51:11.317 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:47 - å¼€å§‹ä¸‹è½½ catzzzzzzzzz è§†é¢‘... 
   2023-05-10 16:51:12.404 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:50 - Done!
   2023-05-10 16:51:12.406 [main] INFO  f.x.d.p.s.YouTubeDownloader:26 - æ¸²æŸ“è§†é¢‘è¯¦æƒ…é¡µé¢
   2023-05-10 16:51:12.406 [main] INFO  f.x.d.p.s.YouTubeDownloader:27 - ID: catzzzzzzzzz
   2023-05-10 16:51:12.406 [main] INFO  f.x.d.p.s.YouTubeDownloader:28 - Title: Some video title
   2023-05-10 16:51:12.406 [main] INFO  f.x.d.p.s.YouTubeDownloader:29 - Video: Random video.
   2023-05-10 16:51:12.406 [main] INFO  f.x.d.p.s.YouTubeDownloader:30 - -------------------------------
   2023-05-10 16:51:12.406 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:21 - -------------------------------
   2023-05-10 16:51:12.406 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:73 - Connecting to https://www.youtube.com ... 
   2023-05-10 16:51:13.167 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:75 - Connected!
   2023-05-10 16:51:13.167 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:34 - å¼€å§‹ä¸‹è½½çƒ­é—¨è§†é¢‘ ... 
   2023-05-10 16:51:14.254 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:42 - Done!
   2023-05-10 16:51:14.254 [main] INFO  f.x.d.p.s.YouTubeDownloader:35 - æ¸²æŸ“çƒ­é—¨è§†é¢‘ä¸“æ é¡µé¢
   2023-05-10 16:51:14.254 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: mkafksangasj  / Title: Dog play with ball.mp4
   2023-05-10 16:51:14.254 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: sadgahasgdas  / Title: Catzzzz.avi
   2023-05-10 16:51:14.254 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: asdfas3ffasd  / Title: Dancing video.mpq
   2023-05-10 16:51:14.254 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: dlsdk5jfslaf  / Title: Barcelona vs RealM.mov
   2023-05-10 16:51:14.255 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: 3sdfgsd1j333  / Title: Programing lesson#1.avi
   2023-05-10 16:51:14.255 [main] INFO  f.x.d.p.s.YouTubeDownloader:39 - -------------------------------
   2023-05-10 16:51:14.255 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:28 - -------------------------------
   2023-05-10 16:51:14.255 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:73 - Connecting to https://www.youtube.com/dancesvideoo ... 
   2023-05-10 16:51:15.013 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:75 - Connected!
   2023-05-10 16:51:15.014 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:47 - å¼€å§‹ä¸‹è½½ dancesvideoo è§†é¢‘... 
   2023-05-10 16:51:16.094 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:50 - Done!
   2023-05-10 16:51:16.095 [main] INFO  f.x.d.p.s.YouTubeDownloader:26 - æ¸²æŸ“è§†é¢‘è¯¦æƒ…é¡µé¢
   2023-05-10 16:51:16.095 [main] INFO  f.x.d.p.s.YouTubeDownloader:27 - ID: dancesvideoo
   2023-05-10 16:51:16.095 [main] INFO  f.x.d.p.s.YouTubeDownloader:28 - Title: Some video title
   2023-05-10 16:51:16.095 [main] INFO  f.x.d.p.s.YouTubeDownloader:29 - Video: Random video.
   2023-05-10 16:51:16.097 [main] INFO  f.x.d.p.s.YouTubeDownloader:30 - -------------------------------
   2023-05-10 16:51:16.097 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:28 - -------------------------------
   2023-05-10 16:51:16.097 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:73 - Connecting to https://www.youtube.com/catzzzzzzzzz ... 
   2023-05-10 16:51:16.963 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:75 - Connected!
   2023-05-10 16:51:16.963 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:47 - å¼€å§‹ä¸‹è½½ catzzzzzzzzz è§†é¢‘... 
   2023-05-10 16:51:17.832 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:50 - Done!
   2023-05-10 16:51:17.832 [main] INFO  f.x.d.p.s.YouTubeDownloader:26 - æ¸²æŸ“è§†é¢‘è¯¦æƒ…é¡µé¢
   2023-05-10 16:51:17.832 [main] INFO  f.x.d.p.s.YouTubeDownloader:27 - ID: catzzzzzzzzz
   2023-05-10 16:51:17.832 [main] INFO  f.x.d.p.s.YouTubeDownloader:28 - Title: Some video title
   2023-05-10 16:51:17.832 [main] INFO  f.x.d.p.s.YouTubeDownloader:29 - Video: Random video.
   2023-05-10 16:51:17.832 [main] INFO  f.x.d.p.s.YouTubeDownloader:30 - -------------------------------
   2023-05-10 16:51:17.832 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:28 - -------------------------------
   2023-05-10 16:51:17.832 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:73 - Connecting to https://www.youtube.com/someothervid ... 
   2023-05-10 16:51:18.482 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:75 - Connected!
   2023-05-10 16:51:18.482 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:47 - å¼€å§‹ä¸‹è½½ someothervid è§†é¢‘... 
   2023-05-10 16:51:19.135 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:50 - Done!
   2023-05-10 16:51:19.135 [main] INFO  f.x.d.p.s.YouTubeDownloader:26 - æ¸²æŸ“è§†é¢‘è¯¦æƒ…é¡µé¢
   2023-05-10 16:51:19.135 [main] INFO  f.x.d.p.s.YouTubeDownloader:27 - ID: someothervid
   2023-05-10 16:51:19.135 [main] INFO  f.x.d.p.s.YouTubeDownloader:28 - Title: Some video title
   2023-05-10 16:51:19.135 [main] INFO  f.x.d.p.s.YouTubeDownloader:29 - Video: Random video.
   2023-05-10 16:51:19.135 [main] INFO  f.x.d.p.s.YouTubeDownloader:30 - -------------------------------
   2023-05-10 16:51:19.135 [main] INFO  f.x.d.p.ApiTest:46 - æµ‹è¯•æ€»å…±è€—æ—¶ 10430 ms
   2023-05-10 16:51:19.135 [main] INFO  f.x.d.p.ApiTest:28 - --------------------------------------------------------------------------------
   2023-05-10 16:51:19.135 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:21 - -------------------------------
   2023-05-10 16:51:19.137 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:73 - Connecting to https://www.youtube.com ... 
   2023-05-10 16:51:20.227 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:75 - Connected!
   2023-05-10 16:51:20.230 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:34 - å¼€å§‹ä¸‹è½½çƒ­é—¨è§†é¢‘ ... 
   2023-05-10 16:51:21.314 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:42 - Done!
   2023-05-10 16:51:21.314 [main] INFO  f.x.d.p.s.YouTubeDownloader:35 - æ¸²æŸ“çƒ­é—¨è§†é¢‘ä¸“æ é¡µé¢
   2023-05-10 16:51:21.314 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: mkafksangasj  / Title: Dog play with ball.mp4
   2023-05-10 16:51:21.314 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: sadgahasgdas  / Title: Catzzzz.avi
   2023-05-10 16:51:21.315 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: asdfas3ffasd  / Title: Dancing video.mpq
   2023-05-10 16:51:21.315 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: dlsdk5jfslaf  / Title: Barcelona vs RealM.mov
   2023-05-10 16:51:21.315 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: 3sdfgsd1j333  / Title: Programing lesson#1.avi
   2023-05-10 16:51:21.315 [main] INFO  f.x.d.p.s.YouTubeDownloader:39 - -------------------------------
   
   2023-05-10 16:51:21.315 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:28 - -------------------------------
   2023-05-10 16:51:21.315 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:73 - Connecting to https://www.youtube.com/catzzzzzzzzz ... 
   2023-05-10 16:51:22.088 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:75 - Connected!
   2023-05-10 16:51:22.088 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:47 - å¼€å§‹ä¸‹è½½ catzzzzzzzzz è§†é¢‘... 
   2023-05-10 16:51:23.068 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:50 - Done!
   2023-05-10 16:51:23.068 [main] INFO  f.x.d.p.s.YouTubeDownloader:26 - æ¸²æŸ“è§†é¢‘è¯¦æƒ…é¡µé¢
   2023-05-10 16:51:23.068 [main] INFO  f.x.d.p.s.YouTubeDownloader:27 - ID: catzzzzzzzzz
   2023-05-10 16:51:23.068 [main] INFO  f.x.d.p.s.YouTubeDownloader:28 - Title: Some video title
   2023-05-10 16:51:23.068 [main] INFO  f.x.d.p.s.YouTubeDownloader:29 - Video: Random video.
   2023-05-10 16:51:23.068 [main] INFO  f.x.d.p.s.YouTubeDownloader:30 - -------------------------------
   
   2023-05-10 16:51:23.069 [main] INFO  f.x.d.p.s.YouTubeCacheProxy:31 - ä»ç¼“å­˜ä¸­ä¸‹è½½çƒ­é—¨è§†é¢‘
   2023-05-10 16:51:23.069 [main] INFO  f.x.d.p.s.YouTubeDownloader:35 - æ¸²æŸ“çƒ­é—¨è§†é¢‘ä¸“æ é¡µé¢
   2023-05-10 16:51:23.069 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: mkafksangasj  / Title: Dog play with ball.mp4
   2023-05-10 16:51:23.069 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: sadgahasgdas  / Title: Catzzzz.avi
   2023-05-10 16:51:23.069 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: asdfas3ffasd  / Title: Dancing video.mpq
   2023-05-10 16:51:23.069 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: dlsdk5jfslaf  / Title: Barcelona vs RealM.mov
   2023-05-10 16:51:23.069 [main] INFO  f.x.d.p.s.YouTubeDownloader:37 - ID: 3sdfgsd1j333  / Title: Programing lesson#1.avi
   2023-05-10 16:51:23.069 [main] INFO  f.x.d.p.s.YouTubeDownloader:39 - -------------------------------
   
   2023-05-10 16:51:23.069 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:28 - -------------------------------
   2023-05-10 16:51:23.069 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:73 - Connecting to https://www.youtube.com/dancesvideoo ... 
   2023-05-10 16:51:24.043 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:75 - Connected!
   2023-05-10 16:51:24.044 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:47 - å¼€å§‹ä¸‹è½½ dancesvideoo è§†é¢‘... 
   2023-05-10 16:51:24.801 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:50 - Done!
   2023-05-10 16:51:24.801 [main] INFO  f.x.d.p.s.YouTubeDownloader:26 - æ¸²æŸ“è§†é¢‘è¯¦æƒ…é¡µé¢
   2023-05-10 16:51:24.801 [main] INFO  f.x.d.p.s.YouTubeDownloader:27 - ID: dancesvideoo
   2023-05-10 16:51:24.802 [main] INFO  f.x.d.p.s.YouTubeDownloader:28 - Title: Some video title
   2023-05-10 16:51:24.802 [main] INFO  f.x.d.p.s.YouTubeDownloader:29 - Video: Random video.
   2023-05-10 16:51:24.802 [main] INFO  f.x.d.p.s.YouTubeDownloader:30 - -------------------------------
   
   2023-05-10 16:51:24.802 [main] INFO  f.x.d.p.s.YouTubeCacheProxy:43 - ä»ç¼“å­˜ä¸­ä¸‹è½½ catzzzzzzzzz è§†é¢‘... 
   2023-05-10 16:51:24.802 [main] INFO  f.x.d.p.s.YouTubeDownloader:26 - æ¸²æŸ“è§†é¢‘è¯¦æƒ…é¡µé¢
   2023-05-10 16:51:24.802 [main] INFO  f.x.d.p.s.YouTubeDownloader:27 - ID: catzzzzzzzzz
   2023-05-10 16:51:24.802 [main] INFO  f.x.d.p.s.YouTubeDownloader:28 - Title: Some video title
   2023-05-10 16:51:24.803 [main] INFO  f.x.d.p.s.YouTubeDownloader:29 - Video: Random video.
   2023-05-10 16:51:24.803 [main] INFO  f.x.d.p.s.YouTubeDownloader:30 - -------------------------------
   
   2023-05-10 16:51:24.803 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:28 - -------------------------------
   2023-05-10 16:51:24.803 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:73 - Connecting to https://www.youtube.com/someothervid ... 
   2023-05-10 16:51:25.344 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:75 - Connected!
   2023-05-10 16:51:25.345 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:47 - å¼€å§‹ä¸‹è½½ someothervid è§†é¢‘... 
   2023-05-10 16:51:25.998 [main] INFO  f.x.d.p.s.ThirdPartyYouTubeLibClass:50 - Done!
   2023-05-10 16:51:25.998 [main] INFO  f.x.d.p.s.YouTubeDownloader:26 - æ¸²æŸ“è§†é¢‘è¯¦æƒ…é¡µé¢
   2023-05-10 16:51:25.998 [main] INFO  f.x.d.p.s.YouTubeDownloader:27 - ID: someothervid
   2023-05-10 16:51:25.998 [main] INFO  f.x.d.p.s.YouTubeDownloader:28 - Title: Some video title
   2023-05-10 16:51:25.998 [main] INFO  f.x.d.p.s.YouTubeDownloader:29 - Video: Random video.
   2023-05-10 16:51:25.998 [main] INFO  f.x.d.p.s.YouTubeDownloader:30 - -------------------------------
   
   2023-05-10 16:51:25.998 [main] INFO  f.x.d.p.ApiTest:46 - æµ‹è¯•æ€»å…±è€—æ—¶ 6863 ms
   2023-05-10 16:51:25.998 [main] INFO  f.x.d.p.ApiTest:30 - é€šè¿‡ç¼“å­˜ä»£ç†å¯ä»¥èŠ‚çº¦ 3567 ms
   ```

é™æ€ä»£ç†å®ç°æ­¥éª¤å¦‚ä¸‹:

1. å®šä¹‰é¡¶å±‚æ¥å£ Subjectï¼›
2. å®šä¹‰å®ç°ç±»/ç›®æ ‡ç±» RealSubjectï¼Œå®ç°é¡¶å±‚æ¥å£ Subjectï¼›
3. å®šä¹‰ä»£ç†ç±» Proxyï¼ŒåŒæ ·å®ç°é¡¶å±‚æ¥å£ Subjectï¼Œå¹¶åœ¨ä»£ç†ç±»ä¸­éœ€è¦å®šä¹‰ä¸€ä¸ªè¢«ä»£ç†ç±»å¯¹è±¡çš„å¼•ç”¨ï¼Œåœ¨ä½¿ç”¨æ—¶å°†ç›®æ ‡ç±»å¯¹è±¡é€šè¿‡æ„é€ æ–¹æ³•æ³¨å…¥è¿›æ¥ï¼Œåœ¨è°ƒç”¨ä»£ç†ç±»å¯¹è±¡ä¸­çš„æ–¹æ³•æ—¶å®é™…ä¸Šæ˜¯è°ƒç”¨ç›®æ ‡ç±»å¯¹åº”çš„æ–¹æ³•ï¼Œä¸è¿‡åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰åå¢åŠ é¢å¤–åŠŸèƒ½å®ç°å¢å¼ºç›®æ ‡ç±»å¯¹è±¡æ–¹æ³•åŠŸèƒ½çš„ç›®çš„ï¼Œæ­¤è¿‡ç¨‹å¯¹äºç”¨æˆ·è€Œè¨€æ˜¯ä¸å¯è§çš„ï¼›

### åŠ¨æ€ä»£ç†

åŠ¨æ€ä»£ç†ä¸é™æ€ä»£ç†çš„åŸºæœ¬æ€è·¯ä¸€è‡´ï¼Œåªä¸è¿‡åŠ¨æ€ä»£ç†åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œéšç€ä¸šåŠ¡çš„æ‰©å±•é€‚åº”æ€§æ›´å¼ºã€‚

#### JDK

> [!NOTE]
>
> **è¦æ±‚ç›®æ ‡ç±»å¿…é¡»å®ç°æŸä¸ªæ¥å£**ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼å› ä¸ºä»£ç†ç±»å·²ç»ç»§æ‰¿è‡ª Proxyï¼Œè€Œ Java ä¸å…è®¸å¤šç»§æ‰¿ï¼Œä½†å…è®¸æŸä¸ªç±»å®ç°å¤šä¸ªæ¥å£ã€‚

>[!IMPORTANT]
>
>JDK åŠ¨æ€ä»£ç†å®ç°åŸç†ï¼š**ä»£ç†ç±»ä¸ç›®æ ‡ç±»å®ç°ç›¸åŒçš„æ¥å£**ã€‚

å®ç°æ–¹å¼ï¼šä½äº Java.lang.reflect åŒ…ä¸‹ï¼Œä¸€èˆ¬ä»…æ¶‰åŠ `Java.lang.reflect.Proxy` ç±»ä¸ `InvocationHandler` æ¥å£ï¼Œä¸¤è€…é…åˆåå°„æŠ€æœ¯å³å¯å®ç°åŠ¨æ€ä»£ç†çš„æ“ä½œã€‚å¸¸ä½¿ç”¨ `Proxy` ç±»ä¸­çš„ `newProxyInstance()` é™æ€æ–¹æ³•äº§ç”Ÿä»£ç†å¯¹è±¡ï¼š

```java
public static Object newProxyInstance(ClassLoader loader, Class<?>[] interfaces,  InvocationHandler h)
```

ä¸‰ä¸ªå‚æ•°çš„å«ä¹‰ä¾æ¬¡ä¸ºï¼š

   1. ClassLoader loaderï¼šç›®æ ‡ç±»çš„ç±»åŠ è½½å™¨ï¼›

   2. Class<?>[] interfacesï¼šç›®æ ‡ç±»å®ç°çš„æ¥å£æ•°ç»„ï¼›

   3. InvocationHandler hï¼šè°ƒç”¨å¤„ç†å™¨ï¼Œæ¯ä¸€ä¸ªä»£ç†å¯¹è±¡éƒ½ä¼šå…³è”ä¸€ä¸ª `InvocationHandler` æ¥å£çš„å®ç°ç±»ï¼ˆå¦‚æœéœ€è¦é¢å¤–çš„å‚æ•°å¯ä»¥æä¾›æ„é€ æ–¹æ³•ï¼‰ï¼Œå½“ä¸€ä¸ªæ–¹æ³•ä¼´éšä»£ç†å¯¹è±¡è¢«è°ƒç”¨æ—¶ï¼Œå°±ä¼šè¢«è‡ªåŠ¨è½¬ç§»ä¸ºå¯¹å¤„ç†å™¨ä¸­é‡å†™çš„ `invoke()` æ‰©å±•æ–¹æ³•çš„è°ƒç”¨ã€‚

      ```java
      public interface InvocationHandler {
          public Object invoke(Object proxy, Method method, Object[] args) throws Throwable;
      }
      ```

       1. proxy: ä»£ç†ç±»çš„å®ä¾‹å¯¹è±¡ï¼›
       2. methodï¼šè¦è°ƒç”¨çš„çœŸå®ä¸šåŠ¡çš„å¤„ç†æ–¹æ³•ï¼›
       3. argsï¼šè°ƒç”¨çœŸå®ä¸šåŠ¡å¤„ç†æ–¹æ³•æ—¶æ‰€éœ€è¦çš„å‚æ•°ï¼›

å°†ä»£ç†ç±» YouTubeCacheProxy ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†çš„æ–¹å¼å®ç°ï¼š
```java
public class JdkYouTubeCacheProxy implements InvocationHandler {
    private static final Logger LOGGER = LoggerFactory.getLogger(YouTubeCacheProxy2.class);
    private static final Map<String, Video> cacheAll = new HashMap<>();
    private static Map<String, Video> cachePopular = new HashMap<>();
    private ThirdPartyYouTubeLib thirdPartyYouTubeLib;

    public ThirdPartyYouTubeLib bind(ThirdPartyYouTubeLib thirdPartyYouTubeLib) {
        this.thirdPartyYouTubeLib = thirdPartyYouTubeLib;
        return (ThirdPartyYouTubeLib)
                Proxy.newProxyInstance(
                    thirdPartyYouTubeLib.getClass().getClassLoader(),
                    thirdPartyYouTubeLib.getClass().getInterfaces(),
                    this);
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        String methodName = method.getName();
        if ("popularVideos".equals(methodName)) {
            if (cachePopular.isEmpty()) {
                cachePopular = (Map<String, Video>) method.invoke(thirdPartyYouTubeLib, args);
            } else {
                LOGGER.info("ä»ç¼“å­˜ä¸­ä¸‹è½½çƒ­é—¨è§†é¢‘");
            }
            return cachePopular;
        } else if ("getVideo".equals(methodName)) {
            String videoId = (String) args[0];
            Video video = cacheAll.get(videoId);
            if (video == null) {
                video = (Video) method.invoke(thirdPartyYouTubeLib, args);
                cacheAll.put(videoId, video);
            } else {
                LOGGER.info("ä»ç¼“å­˜ä¸­ä¸‹è½½ {} è§†é¢‘... ", videoId);
            }
            return video;
        }
        return method.invoke(thirdPartyYouTubeLib, args);
    }
}
```
å¢åŠ æ–°çš„æµ‹è¯•æ–¹æ³•ï¼Œä½¿ç”¨ JDK åŠ¨æ€ä»£ç†çš„æ–¹å¼äº§ç”Ÿä»£ç†å¯¹è±¡
```java
@Test
public void test_01() {
    ThirdPartyYouTubeLib thirdPartyYouTubeLib = new ThirdPartyYouTubeLibClass();
    ThirdPartyYouTubeLib proxy = new JdkYouTubeCacheProxy().getProxy(thirdPartyYouTubeLib);
    YouTubeDownloader naiveDownloader = new YouTubeDownloader(thirdPartyYouTubeLib);
    YouTubeDownloader smartDownloader = new YouTubeDownloader(proxy);

    long naive = test(naiveDownloader);
    LOGGER.info(
            "--------------------------------------------------------------------------------\n");
    long smart = test(smartDownloader);
    LOGGER.info("é€šè¿‡ç¼“å­˜ä»£ç†å¯ä»¥èŠ‚çº¦ {} ms", (naive - smart));
}
```
å¯ä»¥å‘ç°æµ‹è¯•ç»“æœä¸ä½¿ç”¨é™æ€ä»£ç†æ—¶ä¸€è‡´ï¼

#### CGLIB

> [!IMPORTANT]
>
> CGLIB åŠ¨æ€ä»£ç†å®ç°åŸç†ï¼š**ä»£ç†ç±»ç»§æ‰¿è‡ªç›®æ ‡ç±»ï¼Œé‡å†™ç›®æ ‡ç±»ä¸­çš„æ–¹æ³•**ï¼Œæ‰€ä»¥å¯¹äº**è¢« final ä¿®é¥°çš„ç±»æˆ–æ–¹æ³•æ— æ³•è¿›è¡Œä»£ç†**ï¼ŒCGLIBæ˜¯é€šè¿‡ ASM æ¥æ“ä½œå­—èŠ‚ç ç”Ÿæˆä»£ç†ç±»ï¼›

å®ç°æ–¹å¼ï¼šéœ€è¦é¢å¤–å¼•å…¥ `cglib` ä¾èµ–ï¼Œåœ¨ CGLIB åŠ¨æ€ä»£ç†æœºåˆ¶ä¸­ `Enhancer` ç±»å’Œ `MethodInterceptor` æ¥å£æ˜¯æ ¸å¿ƒã€‚

   1. å…ˆåˆ›å»º `Enhancer` å®ä¾‹å¯¹è±¡ï¼›

   2. è®¾ç½® superClass å±æ€§ä¸ºç›®æ ‡ç±».classï¼ŒæŒ‡å®šä»£ç†ç±»ç»§æ‰¿çš„çˆ¶ç±»æ˜¯è°ï¼›

   3. è®¾ç½® callback å±æ€§ä¸ºå…¶å­ç±» `MethodInterceptor` ç±»å‹çš„å®ä¾‹å¯¹è±¡ï¼Œéœ€è¦å®ç° `MethodInterceptor` æ¥å£å¹¶é‡å†™ `intercept()` æ–¹æ³•ï¼Œå…¶ä¸­çš„ `intercept()` æ–¹æ³•ç”¨äºæ‹¦æˆªï¼ˆå¢å¼ºï¼‰è¢«ä»£ç†ç±»çš„æ–¹æ³•ã€‚

      ```java
      public interface MethodInterceptor extends Callback {
      	public Object intercept(Object obj, java.lang.reflect.Method method, Object[] args, MethodProxy methodProxy) throws Throwable;
      }
      ```

         1. å½“ä½¿ç”¨ `methodProxy.invoke(obj, args)` æ—¶ï¼Œä¸æ–­é€’å½’è°ƒç”¨ä»£ç†å¯¹è±¡ä¸­çš„è¯¥æ–¹æ³•ç›´è‡³äº§ç”Ÿ StackOverflow å¼‚å¸¸ï¼
         2. å½“ä½¿ç”¨ `methodProxy.invokeSuper(target, args)` æ—¶ï¼Œä¼šäº§ç”Ÿ ClassCastException å¼‚å¸¸ï¼
         3. åªæœ‰ä½¿ç”¨ `methodProxy.invoke(target, args)` æˆ–è€… `methodProxy.invokeSuper(obj, args)` æ—¶æ‰ä¼šè°ƒç”¨ç›®æ ‡å¯¹è±¡ä¸­çš„åŸå§‹æ–¹æ³•ï¼Œç­‰ä»·äº `method.invoke(target, args)`ï¼›
         4. æœ€åè°ƒç”¨ create() æ–¹æ³•åˆ›å»ºä»£ç†å¯¹è±¡ï¼›

å°†ä»£ç†ç±» YouTubeCacheProxy ä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç†çš„æ–¹å¼å®ç°ï¼š
```java
public class CglibYouTubeCacheProxy {
    private static final Logger LOGGER = LoggerFactory.getLogger(CglibYouTubeCacheProxy.class);
    private static final Map<String, Video> cacheAll = new HashMap<>();
    private static Map<String, Video> cachePopular = new HashMap<>();

    public ThirdPartyYouTubeLibClass getProxy(ThirdPartyYouTubeLibClass thirdPartyYouTubeLib) {
        Enhancer enhancer = new Enhancer();
        enhancer.setSuperclass(thirdPartyYouTubeLib.getClass());
        enhancer.setCallbacks(new Callback[]{
                (MethodInterceptor) (obj, method, args, methodProxy) -> {
                    if (cachePopular.isEmpty()) {
                        cachePopular = (Map<String, Video>) methodProxy.invokeSuper(obj, args);
                    } else {
                        LOGGER.info("ä»ç¼“å­˜ä¸­ä¸‹è½½çƒ­é—¨è§†é¢‘");
                    }
                    return cachePopular;
                },
                (MethodInterceptor) (obj, method, args, methodProxy) -> {
                    String videoId = (String) args[0];
                    Video video = cacheAll.get(videoId);
                    if (video == null) {
                        video = (Video) methodProxy.invokeSuper(obj, args);
                        cacheAll.put(videoId, video);
                    } else {
                        LOGGER.info("ä»ç¼“å­˜ä¸­ä¸‹è½½ {} è§†é¢‘... ", videoId);
                    }
                    return video;
                }
        });
        enhancer.setCallbackFilter(method -> {
            if ("popularVideos".equals(method.getName())) {
                return 0;
            } else {
                return 1;
            }
        });
        return (ThirdPartyYouTubeLibClass) enhancer.create();
    }
}
```
å¢åŠ æ–°çš„æµ‹è¯•æ–¹æ³•ï¼Œä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç†çš„æ–¹å¼äº§ç”Ÿä»£ç†å¯¹è±¡
```java
@Test
public void test_02() {
    ThirdPartyYouTubeLibClass thirdPartyYouTubeLib = new ThirdPartyYouTubeLibClass();
    YouTubeDownloader naiveDownloader = new YouTubeDownloader(thirdPartyYouTubeLib);
    YouTubeDownloader smartDownloader =
        new YouTubeDownloader(new YouTubeCacheProxy3().bind(thirdPartyYouTubeLib));
    
    long naive = test(naiveDownloader);
    LOGGER.info(
        "--------------------------------------------------------------------------------\n");
    long smart = test(smartDownloader);
    LOGGER.info("é€šè¿‡ç¼“å­˜ä»£ç†å¯ä»¥èŠ‚çº¦ {} ms", (naive - smart));
}
```
åœ¨è¿è¡Œæµ‹è¯•æ–¹æ³•å‰ï¼Œéœ€è¦å¢åŠ å¦‚ä¸‹ VM é€‰é¡¹ï¼Œå¦åˆ™çš„è¯ä¼šæŠ›å‡º`module java.base does not â€œopens java.langâ€œ to unnamed module`å¼‚å¸¸ï¼
```
--add-opens java.base/java.lang=ALL-UNNAMED
```
å¯ä»¥å‘ç°æµ‹è¯•ç»“æœä¸ä½¿ç”¨é™æ€ä»£ç†æ—¶ä¸€è‡´ï¼

## è¿›é˜¶-æºç åˆ†æ

### JDK

#### æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç†ç±»

>[!NOTE]
>
>è¦æƒ³è¾“å‡ºåŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»çš„ `class` æ–‡ä»¶ï¼Œå¿…é¡»ä¿è¯å¦‚ä¸‹æ¡ä»¶ï¼š
>
>1. å¿…é¡»æ˜¯åœ¨ `main` æ–¹æ³•ä¸­ï¼Œåœ¨æµ‹è¯•æ–¹æ³•ä¸­æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼
>
>2. åœ¨ `main` æ–¹æ³•é¦–è¡Œæ·»åŠ  `System.setProperty("sun.misc.ProxyGenerator.saveGeneratedFiles", "true");` ä»£ç ï¼Œè¯¥å±æ€§ä¸ JDK ç‰ˆæœ¬æœ‰å…³ï¼ˆåœ¨ JDK11 ç‰ˆæœ¬ä¸­è¯¥å±æ€§ä¸º `jdk.proxy.ProxyGenerator.saveGeneratedFiles`ï¼‰ï¼Œä¸ç¡®å®šçš„è¯å¯ä»¥æŸ¥çœ‹ `ProxyGenerator` ç±»ä¸­çš„ `saveGeneratedFiles` å±æ€§è¿›è¡Œç¡®å®šï¼Œåªæœ‰å½“è¯¥å±æ€§å€¼ä¸º `true` æ—¶ï¼Œæ‰ä¼šè¾“å‡ºåŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»çš„ `class` æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br />![image-20230923211559838](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202309232115905.png)
>
>   å½“æ·»åŠ ä»¥ä¸Šä»£ç åå¹¶æ²¡æœ‰çœ‹åˆ°ç”Ÿæˆçš„ä»£ç†ç±»çš„ `class` æ–‡ä»¶ï¼Œåˆ™ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼šæ·»åŠ  JVM å‚æ•° `-Dsun.misc.ProxyGenerator.saveGeneratedFiles=true`<br />![image-20230923211916247](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202309232119302.png)

![image-20230923212126658](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202309232121694.png)

JDK åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»å¦‚ä¸‹æ‰€ç¤ºï¼šå¯ä»¥çœ‹åˆ°**ä»£ç†ç±»ç»§æ‰¿è‡ª `Proxy` å¹¶ä¸”å®ç°äº†ä¸è¢«ä»£ç†ç±»ç›¸åŒçš„æ¥å£**ã€‚

```java
public final class $Proxy2 extends Proxy implements ThirdPartyYouTubeLib {
    private static Method m1;
    private static Method m4;
    private static Method m3;
    private static Method m2;
    private static Method m0;

    public $Proxy2(InvocationHandler var1) throws  {
        super(var1);
    }

    public final boolean equals(Object var1) throws  {
        try {
            return (Boolean)super.h.invoke(this, m1, new Object[]{var1});
        } catch (RuntimeException | Error var3) {
            throw var3;
        } catch (Throwable var4) {
            throw new UndeclaredThrowableException(var4);
        }
    }

    public final Video getVideo(String var1) throws  {
        try {
            return (Video)super.h.invoke(this, m4, new Object[]{var1});
        } catch (RuntimeException | Error var3) {
            throw var3;
        } catch (Throwable var4) {
            throw new UndeclaredThrowableException(var4);
        }
    }

    public final Map popularVideos() throws  {
        try {
            return (Map)super.h.invoke(this, m3, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final String toString() throws  {
        try {
            return (String)super.h.invoke(this, m2, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final int hashCode() throws  {
        try {
            return (Integer)super.h.invoke(this, m0, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    static {
        try {
            m1 = Class.forName("java.lang.Object").getMethod("equals", Class.forName("java.lang.Object"));
            m4 = Class.forName("fun.xiaorang.designpattern.proxy.statics.ThirdPartyYouTubeLib").getMethod("getVideo", Class.forName("java.lang.String"));
            m3 = Class.forName("fun.xiaorang.designpattern.proxy.statics.ThirdPartyYouTubeLib").getMethod("popularVideos");
            m2 = Class.forName("java.lang.Object").getMethod("toString");
            m0 = Class.forName("java.lang.Object").getMethod("hashCode");
        } catch (NoSuchMethodException var2) {
            throw new NoSuchMethodError(var2.getMessage());
        } catch (ClassNotFoundException var3) {
            throw new NoClassDefFoundError(var3.getMessage());
        }
    }
}
```

#### ä»£ç†ç±»æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ

ä»ä¸Šé¢åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»æºç ä¸­çœ‹å‡ºï¼Œ**ç”Ÿæˆçš„ä»£ç†ç±»ç»§æ‰¿è‡ª `Proxy` ç±»å¹¶å®ç°ä¸è¢«ä»£ç†ç±»ç›¸åŒçš„æ¥å£**ã€‚

åœ¨ `Proxy` ç±»ä¸­ï¼Œå’±ä»¬æœ€ç†Ÿæ‚‰çš„ä¸€ä¸ªæ–¹æ³•å¯èƒ½å°±æ˜¯ `newProxyInstance()`ï¼Œ**ç”Ÿæˆå¹¶è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡**ã€‚åœ¨ `newProxyInstance()` æ–¹æ³•ä¸­æœ€ä¸ºå…³é”®çš„å‡ è¡Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public static Object newProxyInstance(ClassLoader loader, Class<?>[] interfaces, InvocationHandler h) throws IllegalArgumentException {
	...
	// ç”Ÿæˆä»£ç†ç±»
	Class<?> cl = getProxyClass0(loader, intfs);
	// æ ¹æ®ä»£ç†ç±»è·å–æ„é€ æ–¹æ³•
	final Constructor<?> cons = cl.getConstructor(InvocationHandler.class);
	// é€šè¿‡ä»£ç†ç±»çš„æ„é€ å™¨åˆ›å»ºä»£ç†å¯¹è±¡å¹¶è¿”å›ï¼Œä¼ å…¥ InvocationHandler å‚æ•°
	return cons.newInstance(new Object[]{h});  
	...
}
```

å…³äºåå°„æ˜¯å¦‚ä½•ä½¿ç”¨åœ¨æ­¤å¤„å°±ä¸å†èµ˜è¿°ã€‚æ­¤å¤„å…³é”®ç‚¹å°±åœ¨äº **`getProxyClass0()`** æ–¹æ³•æ˜¯å¦‚ä½•ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»çš„ï¼Ÿ 

```java
private static final WeakCache<ClassLoader, Class<?>[], Class<?>> proxyClassCache = new WeakCache<>(new KeyFactory(), new ProxyClassFactory());

private static Class<?> getProxyClass0(ClassLoader loader, Class<?>... interfaces) {   
	// å¦‚æœç¼“å­˜ä¸­å­˜åœ¨ç»™å®šç±»åŠ è½½å™¨å’Œæ¥å£çš„ä»£ç†ç±»ï¼ˆå”¯ä¸€æ ‡è¯†ï¼Œå¤šæ¬¡è°ƒç”¨æ—¶é‡å¤åˆ›å»ºç›¸åŒçš„ä»£ç†ç±»ï¼‰ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­å–ï¼›å¦åˆ™çš„è¯ï¼Œå°†é€šè¿‡ä»£ç†ç±»å·¥å‚ ProxyClassFactory åˆ›å»ºä»£ç†ç±»
	return proxyClassCache.get(loader, interfaces);  
}
```

æ¥åˆ° `WeakCache` ç±»çš„ `get()` æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public V get(K key, P parameter) {  
    Objects.requireNonNull(parameter);  
    expungeStaleEntries();  
    Object cacheKey = CacheKey.valueOf(key, refQueue);  
  
    // é€šè¿‡ç±»åŠ è½½å™¨,è·å–å·²åŠ è½½è¿‡çš„æ¥å£å…ƒæ•°æ®å’Œä»£ç†ç±»å·¥å‚(ProxyClassFactory)
    // å…¶ä¸­ï¼Œmap ä¸­çš„ key = æ¥å£å…ƒæ•°æ®ï¼Œvalue = ä»£ç†ç±»å·¥å‚(ä½œç”¨: åˆ›å»ºä»£ç†ç±»)
    ConcurrentMap<Object, Supplier<V>> valuesMap = map.get(cacheKey);
    // åˆå§‹åŒ–æ“ä½œï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç©ºçš„ Map  
    if (valuesMap == null) {  
        ConcurrentMap<Object, Supplier<V>> oldValuesMap  
            = map.putIfAbsent(cacheKey,  
                              valuesMap = new ConcurrentHashMap<>());  
        if (oldValuesMap != null) {  
            valuesMap = oldValuesMap;  
        }  
    }  
  
    // å°†æ‰€æœ‰æ¥å£è¿›è¡Œhashç”Ÿæˆå”¯ä¸€æ ‡è¯†   
    Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter)); 
    // é€šè¿‡å”¯ä¸€æ ‡è¯†å°è¯•æ€§è·å–ä»£ç†ç±»å·¥å‚(ProxyClassFactory) 
    Supplier<V> supplier = valuesMap.get(subKey);  
    Factory factory = null;  
  
    while (true) {
	    // ç¬¬ä¸€æ¬¡å¹¶ä¸å­˜åœ¨ä»£ç†ç±»å·¥å‚ï¼Œæ‰€ä»¥ä¸æ»¡è¶³æ¡ä»¶ï¼Œèµ°ä¸‹é¢çš„ä»£ç ç”Ÿæˆä»£ç†ç±»å·¥å‚ï¼Œç¬¬ä¸€æ¬¡å¾ªç¯ç»“æŸã€‚ç¬¬äºŒæ¬¡æ‰ä¼šæ»¡è¶³æ¡ä»¶  
        if (supplier != null) {  
            // ä»ä»£ç†ç±»å·¥å‚ä¸­è·å–ä»£ç†ç±»å¹¶è¿”å›
            V value = supplier.get();  
            if (value != null) {  
                return value;  
            }  
        }  
        // åˆ›å»ºä¸€ä¸ªä»£ç†ç±»å·¥å‚       
        if (factory == null) {  
            factory = new Factory(key, parameter, subKey, valuesMap);  
        }  
  
        if (supplier == null) {
	        // å°†ä»£ç†ç±»å·¥å‚æ”¾å…¥ç¼“å­˜ä¸­  
            supplier = valuesMap.putIfAbsent(subKey, factory);  
            if (supplier == null) {  
                // å·²ç»åˆ›å»ºå¥½ä»£ç†ç±»å·¥å‚ï¼Œä¸ºç¬¬äºŒæ¬¡å¾ªç¯åšå‡†å¤‡ï¼Œåœ¨ç¬¬äºŒæ¬¡å¾ªç¯æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»£ç†ç±»å·¥å‚è·å–ä»£ç†ç±» 
                supplier = factory;  
            }  
        } else {
	        // ä»£ç†ç±»å·¥å‚çš„é‡è¯•æœºåˆ¶
	        // å½“ä»ä»£ç†ç±»å·¥å‚ä¸­è·å–å‡ºçš„ä»£ç†ç±»ä¸ºç©ºæ—¶ï¼Œåˆ™ç”¨æ–°åˆ›å»ºçš„ä»£ç†ç±»å·¥å‚æ›¿æ¢æ‰ç¼“å­˜ä¸­æ—§çš„ä»£ç†ç±»å·¥å‚
	        // ç„¶åå†ç”¨æ–°çš„ä»£ç†ç±»å·¥å‚å»åˆ›å»ºä»£ç†ç±»
            if (valuesMap.replace(subKey, supplier, factory)) {  
                supplier = factory;  
            } else {  
                supplier = valuesMap.get(subKey);  
            }  
        }  
    }  
}
```

##### ç»†èŠ‚åˆ†æ 1ï¼šProxy.KeyFactory

ä½œç”¨ï¼šé€šè¿‡å¯¹æ‰€æœ‰çš„æ¥å£è¿›è¡Œ hash æ“ä½œç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼Œç”¨æ¥å¯¹åº”ä»£ç†ç±»å·¥å‚ã€‚

```java
private static final class KeyFactory implements BiFunction<ClassLoader, Class<?>[], Object> {  
    @Override  
    public Object apply(ClassLoader classLoader, Class<?>[] interfaces) {  
        switch (interfaces.length) {  
            case 1: return new Key1(interfaces[0]); // the most frequent  
            case 2: return new Key2(interfaces[0], interfaces[1]);  
            case 0: return key0;  
            default: return new KeyX(interfaces);  
        }  
    }  
}
```

##### ç»†èŠ‚åˆ†æ 2ï¼šProxy.ProxyClassFactory

ä½œç”¨ï¼šçœŸæ­£**ç”Ÿæˆä»£ç†ç±»**çš„åœ°æ–¹ã€‚

```java
private static final class ProxyClassFactory implements BiFunction<ClassLoader, Class<?>[], Class<?>> {  
    // æ‰€æœ‰ä»£ç†ç±»åç§°çš„å‰ç¼€ 
    private static final String proxyClassNamePrefix = "$Proxy";  
  
    // ç”¨äºç”Ÿæˆå”¯ä¸€ä»£ç†ç±»åç§°çš„ä¸‹ä¸€ä¸ªæ•°å­—  
    private static final AtomicLong nextUniqueNumber = new AtomicLong();
    
	@Override
	public Class<?> apply(ClassLoader loader, Class<?>[] interfaces) {
		// è¦ç”Ÿæˆçš„ä»£ç†ç±»çš„åç§°
	    long num = nextUniqueNumber.getAndIncrement();  
	    String proxyName = proxyPkg + proxyClassNamePrefix + num;
	    // ç”ŸæˆåŠ¨æ€ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶.å³$Proxy.class  
	    byte[] proxyClassFile = ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags);  
	    try { 
		    // å°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°JVMè™šæ‹Ÿæœºå†…å­˜ä¸­ï¼Œè¿”å›ç”Ÿæˆçš„ä»£ç†ç±» 
	        return defineClass0(loader, proxyName, proxyClassFile, 0, proxyClassFile.length);  
	    } catch (ClassFormatError e) {  
	        throw new IllegalArgumentException(e.toString());  
	    }  
	}
}
```

##### ç»†èŠ‚åˆ†æ 3ï¼šProxyGenerator

åœ¨è¯¥ç±»ä¸­æœ€é‡è¦çš„ä¸€ä¸ªæ–¹æ³• **`generateProxyClass`**ï¼Œ**ç”Ÿæˆå¹¶è¿”å›ä»£ç†ç±»çš„å­—èŠ‚ç ä¿¡æ¯**ã€‚å¦‚æœ `saveGeneratedFiles` æ ‡è¯†ä¸º `true`ï¼Œå³ JVM å‚æ•° `sun.misc.ProxyGenerator.saveGeneratedFiles` ä¸º `true` çš„è¯ï¼ˆè¿™ä¹Ÿå°±æ˜¯ä¸Šé¢æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç†ç±»ä¸­ä¸ºå•¥è¦åŠ è¯¥ JVM å‚æ•°çš„åŸå› ï¼‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ I/O æµå°†å­—èŠ‚ç ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ `$Proxy{num}.class` ä¸­ã€‚

```java
private static final boolean saveGeneratedFiles = (Boolean)AccessController.doPrivileged(new GetBooleanAction("sun.misc.ProxyGenerator.saveGeneratedFiles"));

public static byte[] generateProxyClass(final String var0, Class<?>[] var1, int var2) {  
    ProxyGenerator var3 = new ProxyGenerator(var0, var1, var2); 
    // ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œè¿”å›å­—èŠ‚æ•°ç»„
    final byte[] var4 = var3.generateClassFile();
    // å°†ç”Ÿæˆçš„å­—èŠ‚ç ,ä½¿ç”¨I/Oæµä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶  
    if (saveGeneratedFiles) {  
        AccessController.doPrivileged(new PrivilegedAction<Void>() {  
            public Void run() {  
                try {  
                    int var1 = var0.lastIndexOf(46);  
                    Path var2;  
                    if (var1 > 0) {  
                        Path var3 = Paths.get(var0.substring(0, var1).replace('.', File.separatorChar));  
                        Files.createDirectories(var3);  
                        var2 = var3.resolve(var0.substring(var1 + 1, var0.length()) + ".class");  
                    } else {  
                        var2 = Paths.get(var0 + ".class");  
                    }  
  
                    Files.write(var2, var4, new OpenOption[0]);  
                    return null;               
                } catch (IOException var4x) {  
                    throw new InternalError("I/O exception saving generated file: " + var4x);  
                }  
            }  
        });  
    }  
    return var4;  
}
```

#### ä»£ç†ç±»ä½¿ç”¨çš„æ•´ä½“æµç¨‹

ä»¥ `getVideo()` æ–¹æ³•ä¸ºä¾‹ï¼Œåœ¨ä¸Šé¢æ¡ˆä¾‹çš„æµ‹è¯•ç±»ä»£ç ä¸­ï¼Œä¼šè°ƒç”¨ä»£ç†ç±»ä¸­çš„ `getVideo()` æ–¹æ³•ï¼Œç°åœ¨è®©å’±ä»¬æ¥çœ‹çœ‹ä»£ç†ç±»ä¸­ `getVideo()` æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public final Video getVideo(String var1) throws  {
    try {
        return (Video)super.h.invoke(this, m4, new Object[]{var1});
    } catch (RuntimeException | Error var3) {
        throw var3;
    } catch (Throwable var4) {
        throw new UndeclaredThrowableException(var4);
    }
}
```

ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ**è°ƒç”¨äº†çˆ¶ç±» `Proxy` ä¸­ `InvocationHandler` æ¥å£æˆå‘˜å˜é‡çš„ `invoke()` æ–¹æ³•**ï¼ˆä¹Ÿå°±æ˜¯å’±ä»¬é‡å†™çš„ `invoke()` æ–¹æ³•ï¼‰ã€‚ä¼ å…¥çš„å‚æ•°ä¾æ¬¡æ˜¯ä»£ç†ç±»æœ¬èº«ï¼Œ`getVideo()` æ–¹æ³•æ‰€å¯¹åº”çš„ `Method` å¯¹è±¡ï¼Œ`getVideo()` æ–¹æ³•çš„å…¥å‚ã€‚ 

å…¶ä¸­ï¼Œæœ‰ä¸€ä¸ªå…³é”®çš„ç‚¹åœ¨äºå’±ä»¬ä½¿ç”¨ Proxy ç±»ä¸­çš„ `newProxyInstance()` æ–¹æ³•æ—¶ï¼Œåˆ©ç”¨ä»£ç†ç±»çš„æ„é€ å™¨åˆ›å»ºä»£ç†ç±»å¯¹è±¡æ—¶ï¼Œæ„é€ å™¨ä¼ å…¥çš„å‚æ•°ä¸º `InvocationHandler` å®ç°ã€‚

```java
public $Proxy2(InvocationHandler var1) throws  {
    super(var1);
}
```

åœ¨ä»£ç†ç±»çš„æ„é€ å™¨ä¸­ï¼Œåˆè°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ï¼Œå°† `InvocationHandler` å®ç°ä¼ ç»™çˆ¶ç±»ï¼Œè®©çˆ¶ç±» `Proxy` ä¸­çš„çš„æˆå‘˜å˜é‡ `h` æ¥æ”¶ï¼Œæ‰€ä»¥ä»£ç†ç±»çš„ `getVideo()` æ‰å¯ä»¥ç›´æ¥æ‰§è¡Œçˆ¶ç±»ä¸­æˆå‘˜å˜é‡ `h` çš„ `invoke()` æ–¹æ³•ã€‚  

ä»¥ä¸Šå°±æ˜¯ä»£ç†ç±»ä½¿ç”¨çš„æ•´ä¸ªæµç¨‹ï¼Œä»ç”Ÿæˆä»£ç†ç±» â¡ï¸ æ‰§è¡Œä»£ç†ç±»ä¸­çš„æ–¹æ³•ã€‚

### CGLIB

#### æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç†ç±»

åœ¨æµ‹è¯•ç±»çš„ `main` æ–¹æ³•ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç å³å¯ï¼Œè‡³äºåŸå› åœ¨åé¢çš„æºç åˆ†æä¸­ä¼šè¯´ã€‚

```java
System.setProperty(DEBUG_LOCATION_PROPERTY, new File("").getAbsolutePath() + "/cglib");
```

ç‚¹å‡»è¿è¡Œå°±å¯ä»¥åœ¨å½“å‰é¡¹ç›®ç›®å½•ä¸‹çš„ cglib ç›®å½•ä¸­æ‰¾åˆ°åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»çš„ class æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br />![image-20230924020930758](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202309240209815.png)

å¯ä»¥çœ‹åˆ°ä¸ JDK ç”Ÿæˆçš„ä»£ç†ç±»ä¸åŒçš„æ˜¯ï¼ŒCglib ç”Ÿæˆçš„ class æ–‡ä»¶æœ‰ä¸‰ä¸ªï¼Œä¾æ¬¡å¾€ä¸‹åˆ†åˆ«æ˜¯**ä»£ç†ç±»**ã€**ä»£ç†ç±»çš„ FastClass ç±»**å’Œ**è¢«ä»£ç†ç±»çš„ FastClass ç±»**ã€‚

Cglib åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»å¦‚ä¸‹æ‰€ç¤º (ä»…æˆªå–éƒ¨åˆ†é‡è¦çš„ä»£ç )ï¼šå¯ä»¥çœ‹åˆ°**ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯ç»§æ‰¿è‡ªè¢«ä»£ç†ç±»**çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ğŸ’¡ï¼š**è¢« `final` ä¿®é¥°çš„ç±»æˆ–æ–¹æ³•æ˜¯æ— æ³•è¢«ä»£ç†çš„**ã€‚

```java
public class ThirdPartyYouTubeLibClass$$EnhancerByCGLIB$$682a47a2 extends ThirdPartyYouTubeLibClass implements ThirdPartyYouTubeLib, Factory {
    private boolean CGLIB$BOUND;
    public static Object CGLIB$FACTORY_DATA;
    private static final ThreadLocal CGLIB$THREAD_CALLBACKS;
    private static final Callback[] CGLIB$STATIC_CALLBACKS;
    private MethodInterceptor CGLIB$CALLBACK_0;
    private MethodInterceptor CGLIB$CALLBACK_1;
    private static Object CGLIB$CALLBACK_FILTER;
    private static final Method CGLIB$getVideo$0$Method;
    private static final MethodProxy CGLIB$getVideo$0$Proxy;
    private static final Object[] CGLIB$emptyArgs;
    private static final Method CGLIB$popularVideos$1$Method;
    private static final MethodProxy CGLIB$popularVideos$1$Proxy;

    
    static void CGLIB$STATICHOOK1() {
        CGLIB$THREAD_CALLBACKS = new ThreadLocal();
        CGLIB$emptyArgs = new Object[0];
        // var0 = ä»£ç†ç±»  
        Class var0 = Class.forName("fun.xiaorang.designpattern.proxy.statics.ThirdPartyYouTubeLibClass$$EnhancerByCGLIB$$682a47a2");
        // var1 = è¢«ä»£ç†ç±»  
        Class var1;
        Method[] var10000  = ReflectUtils.findMethods(new String[]{"getVideo", "(Ljava/lang/String;)Lfun/xiaorang/designpattern/proxy/statics/Video;", "popularVideos", "()Ljava/util/Map;"}, (var1 = Class.forName("fun.xiaorang.designpattern.proxy.statics.ThirdPartyYouTubeLibClass")).getDeclaredMethods());
        CGLIB$getVideo$0$Method = var10000[0];
        CGLIB$getVideo$0$Proxy = MethodProxy.create(var1, var0, "(Ljava/lang/String;)Lfun/xiaorang/designpattern/proxy/statics/Video;", "getVideo", "CGLIB$getVideo$0");
        CGLIB$popularVideos$1$Method = var10000[1];
        CGLIB$popularVideos$1$Proxy = MethodProxy.create(var1, var0, "()Ljava/util/Map;", "popularVideos", "CGLIB$popularVideos$1");
    }
    
    final Video CGLIB$getVideo$0(String var1) {
        return super.getVideo(var1);
    }

    public final Video getVideo(String var1) {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_1;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_1;
        }
        return var10000 != null ? (Video)var10000.intercept(this, CGLIB$getVideo$0$Method, new Object[]{var1}, CGLIB$getVideo$0$Proxy) : super.getVideo(var1);
    }

    final Map CGLIB$popularVideos$1() {
        return super.popularVideos();
    }

    public final Map popularVideos() {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }
        return var10000 != null ? (Map)var10000.intercept(this, CGLIB$popularVideos$1$Method, CGLIB$emptyArgs, CGLIB$popularVideos$1$Proxy) : super.popularVideos();
    }
    
    public static MethodProxy CGLIB$findMethodProxy(Signature var0) {
        String var10000 = var0.toString();
        switch (var10000.hashCode()) {
            case -508378822:
                if (var10000.equals("clone()Ljava/lang/Object;")) {
                    return CGLIB$clone$5$Proxy;
                }
                break;
            case 149185808:
                if (var10000.equals("getVideo(Ljava/lang/String;)Lfun/xiaorang/designpattern/proxy/statics/Video;")) {
                    return CGLIB$getVideo$0$Proxy;
                }
                break;
            case 472997241:
                if (var10000.equals("popularVideos()Ljava/util/Map;")) {
                    return CGLIB$popularVideos$1$Proxy;
                }
                break;
            case 1826985398:
                if (var10000.equals("equals(Ljava/lang/Object;)Z")) {
                    return CGLIB$equals$2$Proxy;
                }
                break;
            case 1913648695:
                if (var10000.equals("toString()Ljava/lang/String;")) {
                    return CGLIB$toString$3$Proxy;
                }
                break;
            case 1984935277:
                if (var10000.equals("hashCode()I")) {
                    return CGLIB$hashCode$4$Proxy;
                }
        }
        return null;
    }
    
    // ä»£ç†ç±»çš„æ„é€ æ–¹æ³•
    public ThirdPartyYouTubeLibClass$$EnhancerByCGLIB$$682a47a2() {
        CGLIB$BIND_CALLBACKS(this);
    }

    public static void CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) {
        CGLIB$THREAD_CALLBACKS.set(var0);
    }

    public static void CGLIB$SET_STATIC_CALLBACKS(Callback[] var0) {
        CGLIB$STATIC_CALLBACKS = var0;
    }

    private static final void CGLIB$BIND_CALLBACKS(Object var0) {
        ThirdPartyYouTubeLibClass$$EnhancerByCGLIB$$682a47a2 var1 = (ThirdPartyYouTubeLibClass$$EnhancerByCGLIB$$682a47a2)var0;
        // åˆå§‹åŒ–æ“ä½œï¼Œåªæ‰§è¡Œä¸€æ¬¡
        if (!var1.CGLIB$BOUND) {
            var1.CGLIB$BOUND = true;
             // ä» ThreadLocal ä¸­è·å– CALLBACKS
            Object var10000 = CGLIB$THREAD_CALLBACKS.get();
            if (var10000 == null) {
                // å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™ä½¿ç”¨ CGLIB$STATIC_CALLBACKS  
                var10000 = CGLIB$STATIC_CALLBACKS;
                if (var10000 == null) {
                    return;
                }
            }
            Callback[] var10001 = (Callback[])var10000;
            var1.CGLIB$CALLBACK_1 = (MethodInterceptor)((Callback[])var10000)[1];
            // CALLBACKSä¸­çš„ç¬¬ä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨èµ‹å€¼ç»™ CGLIB$CALLBACK_0
            var1.CGLIB$CALLBACK_0 = (MethodInterceptor)var10001[0];
        }
    }
    
    static {
        CGLIB$STATICHOOK1();
    }
}
```

<span style="background-color: rgb(251, 228, 231);">TODO</span>

### Cglib ä¸ JDK åŠ¨æ€ä»£ç†å¯¹æ¯”

1. **JDK åŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä»£ç†ç±»å®ç°äº†ä¸è¢«ä»£ç†ç±»ç›¸åŒçš„æ¥å£ï¼Œè€Œ Cglib ä»£ç†ç”Ÿæˆçš„ä»£ç†ç±»åˆ™ç»§æ‰¿è‡ªè¢«ä»£ç†ç±»**ã€‚
2. JDK åŠ¨æ€ä»£ç†ä¸ Cglib åŠ¨æ€ä»£ç†éƒ½æ˜¯åœ¨è¿è¡ŒæœŸç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼ŒJDK åŠ¨æ€ä»£ç†ç›´æ¥å†™ Class å­—èŠ‚ç ï¼ŒCglib åŠ¨æ€ä»£ç†ä½¿ç”¨ ASM æ¡†æ¶å†™ Class å­—èŠ‚ç ï¼ŒCglib åŠ¨æ€ä»£ç†å®ç°æ›´å¤æ‚ï¼Œç”Ÿæˆä»£ç†ç±»æ¯” JDK åŠ¨æ€ä»£ç†æ•ˆç‡ä½ã€‚
3. **JDK åŠ¨æ€ä»£ç†è°ƒç”¨ä»£ç†æ–¹æ³•æ˜¯é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨çš„**ï¼Œ**Cglib ä»£ç†æ˜¯é€šè¿‡ FastClass æœºåˆ¶ç›´æ¥è°ƒç”¨æ–¹æ³•çš„**ã€‚åœ¨ JDK8 ç‰ˆæœ¬ä¹‹åï¼ŒJDK åŠ¨æ€ä»£ç†çš„æ•ˆç‡æ˜¯é«˜äº Cglib çš„ï¼Œéšç€æ¯ä¸€æ¬¡ JDK ç‰ˆæœ¬å‡çº§ï¼ŒJDK åŠ¨æ€ä»£ç†æ•ˆç‡éƒ½æœ‰æ‰€æå‡ï¼Œè€Œ Cglib åˆ™æœ‰ç‚¹è·Ÿä¸ä¸Šæ­¥ä¼äº†ã€‚
