# å•ä¾‹æ¨¡å¼(Singleton)

**å•ä¾‹æ¨¡å¼**æ˜¯ä¸€ç§<span style="background-color: rgb(251, 228, 231);">åˆ›å»ºå‹</span>è®¾è®¡æ¨¡å¼ï¼Œç”¨äºç¡®ä¿**ä¸€ä¸ªç±»ä»»ä½•æƒ…å†µä¸‹éƒ½ç»å¯¹åªæœ‰ä¸€ä¸ªå®ä¾‹**ï¼Œå¹¶æä¾›**ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹**ã€‚

## ç±»å›¾

```plantuml
@startuml

class Client {
	- void {static} main(args: String[])
}

class Singleton {
    - Singleton {static} INTANCE 
    - void Signleton() 
    + Signleton {static} getInstance()
}
note right of Singleton::getInstance
if (INTANCE == null) {
\t// åŒé‡æ£€æŸ¥é”ï¼ˆDCLï¼‰
\t synchronized (Singleton.class) {  
\t\t if (INTANCE == null) {  
\t\t\t INTANCE = new Singleton();  
\t\t}  
\t}  
}  
return INTANCE;
end note

Client ..> Singleton

@enduml
```

## å®ç°æ–¹å¼

### é¥¿æ±‰å¼

æ‰€æœ‰å•ä¾‹çš„å®ç°éƒ½åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªç›¸åŒçš„æ­¥éª¤ï¼š

- **å°†é»˜è®¤æ„é€ å‡½æ•°è®¾ä¸ºç§æœ‰**ï¼Œé˜²æ­¢å…¶ä»–å¯¹è±¡ä½¿ç”¨å•ä¾‹ç±»çš„`new`è¿ç®—ç¬¦ï¼›
- **æ–°å»ºä¸€ä¸ªé™æ€æ–¹æ³•ä½œä¸ºå…¨å±€è®¿é—®ç‚¹**ï¼Œè¯¥é™æ€æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªè¢«<u>`final`</u>ä¿®é¥°çš„**é™æ€æˆå‘˜å˜é‡**ï¼ˆå½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼‰ï¼›

ç‰¹ç‚¹ï¼šé¥¿æ±‰å¼å•ä¾‹æ¨¡å¼åœ¨**ç±»åŠ è½½**çš„æ—¶å€™å°±ä¼š**åˆ›å»º**ä¸€ä¸ªå•ä¾‹å¯¹è±¡å¹¶ä¿å­˜åœ¨ä¸€ä¸ªé™æ€æˆå‘˜å˜é‡ä¸­ï¼Œæ‰€ä»¥å®ƒç»å¯¹**çº¿ç¨‹å®‰å…¨**ã€‚<br />ä¼˜ç¼ºç‚¹ï¼š

- ä¼˜ç‚¹ï¼šæ²¡æœ‰åŠ ä»»ä½•é”ï¼Œæ‰§è¡Œæ•ˆç‡æ¯”è¾ƒé«˜ï¼Œç”¨æˆ·ä½“éªŒæ¯”[æ‡’æ±‰å¼](#æ‡’æ±‰å¼)å•ä¾‹æ¨¡å¼æ›´å¥½ï¼›
- ç¼ºç‚¹ï¼šç±»åŠ è½½çš„æ—¶å€™å°±ä¼šåˆå§‹åŒ–ï¼Œä¸ç®¡ç”¨ä¸ç”¨éƒ½ä¼šå ç”¨ç©ºé—´ï¼Œæµªè´¹å†…å­˜ï¼›

ä»£ç å®ç°ï¼š

1. åˆ›å»ºä¸€ä¸ªç®€å•çš„å®ä½“ç±» HungrySingleton

```java
public class HungrySingleton {
    private static final HungrySingleton INSTANCE = new HungrySingleton();

    private HungrySingleton() {
        // ç§æœ‰æ„é€ å‡½æ•°
    }

    public static HungrySingleton getInstance() {
        return INSTANCE;
    }
}
```

2. åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±» ApiTest

```java
class ApiTest {
    private static final Logger LOGGER = LoggerFactory.getLogger(ApiTest.class);

    @Test
    public void test_00() {
        HungrySingleton hungrySingleton1 = HungrySingleton.getInstance();
        HungrySingleton hungrySingleton2 = HungrySingleton.getInstance();
        LOGGER.info("{}", hungrySingleton1);
        LOGGER.info("{}", hungrySingleton2);
    }
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242228922.png" alt="image.png" style="zoom:80%;" /><br />åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ

- ä½¿ç”¨ä¸€ä¸ªç§æœ‰çš„æ„é€ å‡½æ•°æ¥é™åˆ¶ HungrySingleton ç±»è¢«å®ä¾‹åŒ–ï¼›
- å®šä¹‰ä¸€ä¸ªè¢« final ä¿®é¥°çš„é™æ€æˆå‘˜å˜é‡ INSTANCEï¼Œè¯¥é™æ€æˆå‘˜å˜é‡åªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½ HungrySingleton ç±»æ—¶æ‰è¢«åˆå§‹åŒ–ï¼Œè€Œä¸”åœ¨ä¹‹åéƒ½ä¸ä¼šè¢«ä¿®æ”¹ï¼›
- é™æ€æ–¹æ³• getInstance() ç›´æ¥è¿”å›é™æ€å˜é‡ INSTANCEï¼Œç”¨äºä¿è¯è¯¥ç±»åªä¼šå­˜åœ¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼›

### æ‡’æ±‰å¼

ç‰¹ç‚¹ï¼šç­‰åˆ°ç¬¬ä¸€æ¬¡è¢«å¤–éƒ¨ç±»è°ƒç”¨çš„æ—¶å€™æ‰ä¼šå»åˆ›å»ºå®ä¾‹ï¼Œä¹Ÿå°±æ˜¯åœ¨`getInstance()`æ–¹æ³•é‡Œé¢å»åˆ¤æ–­å’Œåˆ›å»ºã€‚

```java
public class LazySingleton {
    private static LazySingleton INSTANCE;

    private LazySingleton() {
        // ç§æœ‰æ„é€ å‡½æ•°
    }

    public static LazySingleton getInstance() {
        if (INSTANCE == null) {
            INSTANCE = new LazySingleton();
        }
        return INSTANCE;
    }
}
```

åœ¨æµ‹è¯•ç±» ApiTest ä¸­å¢åŠ å¦‚ä¸‹æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test
public void test_01() {
    Runnable runnable = () -> {
        LazySingleton instance = LazySingleton.getInstance();
        LOGGER.info("{}ï¼š{}", Thread.currentThread().getName(), instance);
    };
    Thread t1 = new Thread(runnable);
    Thread t2 = new Thread(runnable);
    t1.start();
    t2.start();
}
```

åœ¨è¿›è¡Œå¤šæ¬¡æµ‹è¯•çš„æ—¶å€™å‘ç°ä¸¤ä¸ªçº¿ç¨‹ä¸­çš„ LazySingleton å®ä¾‹å¯¹è±¡å¹¶**ä¸ç›¸ç­‰**ï¼Œä¹Ÿå°±æ„å‘³ç€ä½¿ç”¨æ‡’æ±‰å¼å®ç°çš„å•ä¾‹æ¨¡å¼å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå³**çº¿ç¨‹ä¸å®‰å…¨**ã€‚<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242228041.png" alt="image.png" style="zoom:80%;" />

### åŒé‡æ£€æŸ¥é”

ğŸ¤” é‰´äºæ‡’æ±‰å¼å•ä¾‹æ¨¡å¼**çº¿ç¨‹ä¸å®‰å…¨**ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•ä¼˜åŒ–ä»£ç ï¼Ÿä½¿å¾—æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨å‘¢ï¼<br />ğŸ¤“ ç»™`getInstance()`æ–¹æ³•åŠ ä¸Š`synchronized`å…³é”®å­—ï¼Œä½¿è¯¥æ–¹æ³•å˜æˆçº¿ç¨‹åŒæ­¥æ–¹æ³•ã€‚

```java
public class LazySyncSingleton {
    private static LazySyncSingleton INSTANCE;

    private LazySyncSingleton() {
        // ç§æœ‰æ„é€ å‡½æ•°
    }

    public synchronized static LazySyncSingleton getInstance() {
        if (INSTANCE == null) {
            INSTANCE = new LazySyncSingleton();
        }
        return INSTANCE;
    }
}
```

åœ¨æµ‹è¯•ç±» ApiTest ä¸­å¢åŠ å¦‚ä¸‹æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test
public void test_02() {
    Runnable runnable = () -> {
        LazySyncSingleton instance = LazySyncSingleton.getInstance();
        LOGGER.info("{}ï¼š{}", Thread.currentThread().getName(), instance);
    };
    Thread t1 = new Thread(runnable);
    Thread t2 = new Thread(runnable);
    t1.start();
    t2.start();
}
```

ä»¥ DEBUG çš„æ–¹å¼è¿è¡Œæµ‹è¯•æ–¹æ³•ï¼Œå½“æ‰§è¡Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹å¹¶è°ƒç”¨`getInstance()`æ–¹æ³•æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å†è°ƒç”¨`getInstance()`æ–¹æ³•ï¼Œçº¿ç¨‹çš„çŠ¶æ€ç”±`RUNNING` => `MONITOR`ï¼Œå‡ºç°é˜»å¡ã€‚ç›´åˆ°ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œï¼Œç¬¬äºŒä¸ªçº¿ç¨‹æ‰æ¢å¤åˆ°`RUNNING`çŠ¶æ€å¹¶ç»§ç»­è°ƒç”¨`getInstance()`æ–¹æ³•ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242228189.png" alt="image.png" style="zoom:80%;" /><br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242228380.png" alt="image.png" style="zoom:80%;" /><br />ä¸Šå›¾å®Œç¾åœ°å±•ç°äº†`synchronized`ç›‘è§†é”çš„è¿è¡ŒçŠ¶æ€ï¼Œçº¿ç¨‹çš„å®‰å…¨é—®é¢˜è§£å†³äº†ã€‚ä½†æ˜¯ï¼Œç”¨`synchronized`åŠ é”æ—¶ï¼Œåœ¨çº¿ç¨‹æ•°é‡æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œå¦‚æœ CPU åˆ†é…å‹åŠ›ä¸Šå‡ï¼Œåˆ™ä¼šå¯¼è‡´å¤§æ‰¹çº¿ç¨‹é˜»å¡ï¼Œä»è€Œå¯¼è‡´ç¨‹åºæ€§èƒ½å¤§å¹…ä¸‹é™ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ›´å¥½çš„æ–¹å¼å‘¢ï¼Ÿæ—¢èƒ½å…¼é¡¾çº¿ç¨‹å®‰å…¨åˆèƒ½æå‡ç¨‹åºæ€§èƒ½å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œä½¿ç”¨**åŒé‡æ£€æŸ¥é”ï¼ˆDCLï¼‰**çš„æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼ï¼š

```java
public class LazyDoubleCheckSingleton {
    private static volatile LazyDoubleCheckSingleton INSTANCE;

    private LazyDoubleCheckSingleton() {
        // ç§æœ‰æ„é€ å‡½æ•°
    }

    public static LazyDoubleCheckSingleton getInstance() {
        if (INSTANCE == null) {
            synchronized (LazyDoubleCheckSingleton.class) {
                if (INSTANCE == null) {
                    INSTANCE = new LazyDoubleCheckSingleton();
                }
            }
        }
        return INSTANCE;
    }
}
```

> [!IMPORTANT]
>
> åŒé‡æ£€æŸ¥é”çš„å®ç°ä¼šä½¿ç”¨ä¸€ä¸ªå…³é”®å­— `volatile`ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼šè¢« `volatile` ä¿®é¥°çš„å˜é‡çš„å€¼ï¼Œå°†ä¸ä¼šè¢«æœ¬åœ°çº¿ç¨‹ç¼“å­˜ï¼Œæ‰€æœ‰å¯¹è¯¥å˜é‡çš„è¯»å†™éƒ½æ˜¯ç›´æ¥æ“ä½œå…±äº«å†…å­˜ï¼Œä»è€Œç¡®ä¿å¤šä¸ªçº¿ç¨‹èƒ½æ­£ç¡®çš„å¤„ç†è¯¥å˜é‡ã€‚
>
> ç”±äº `volatile` å…³é”®å­—å¯èƒ½ä¼šå±è”½è™šæ‹Ÿæœºä¸­ä¸€äº›å¿…è¦çš„ä»£ç ä¼˜åŒ–ï¼Œæ‰€ä»¥è¿è¡Œæ•ˆç‡å¹¶ä¸æ˜¯å¾ˆé«˜ã€‚å› æ­¤ä¸€èˆ¬å»ºè®®ï¼Œæ²¡æœ‰ç‰¹åˆ«çš„éœ€è¦ï¼Œä¸è¦ä½¿ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶å¯ä»¥ä½¿ç”¨åŒé‡æ£€æŸ¥é”æœºåˆ¶æ¥å®ç°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹ï¼Œä½†å¹¶ä¸å»ºè®®å¤§é‡é‡‡ç”¨ï¼Œå¯ä»¥æ ¹æ®æƒ…å†µæ¥é€‰ç”¨ã€‚

åœ¨æµ‹è¯•ç±» ApiTest ä¸­å¢åŠ å¦‚ä¸‹æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test
public void test_03() {
    Runnable runnable = () -> {
        LazyDoubleCheckSingleton instance = LazyDoubleCheckSingleton.getInstance();
        LOGGER.info("{}ï¼š{}", Thread.currentThread().getName(), instance);
    };
    Thread t1 = new Thread(runnable);
    Thread t2 = new Thread(runnable);
    t1.start();
    t2.start();
}
```

å‘ç°ä¸ç®¡è¿è¡Œå¤šå°‘æ¬¡ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¸­çš„ LazyDoubleCheckSingleton å®ä¾‹å¯¹è±¡æ€»æ˜¯åŒä¸€ä¸ªï¼Œè¯´æ˜ä½¿ç”¨**åŒé‡æ£€æŸ¥é”ï¼ˆDCLï¼‰**çš„æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼å¯ä»¥ä¿éšœ**çº¿ç¨‹å®‰å…¨**ã€‚<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242228498.png" alt="image.png" style="zoom:80%;" />

### é™æ€å†…éƒ¨ç±»

> [!NOTE|label:ç›¸åº”çš„åŸºç¡€çŸ¥è¯†]
>
> 1. ç±»çº§å†…éƒ¨ç±»ï¼š
>    1. ä»€ä¹ˆæ˜¯ç±»çº§å†…éƒ¨ç±»ï¼Ÿç®€å•ç‚¹è¯´ï¼Œç±»çº§å†…éƒ¨ç±»æŒ‡çš„æ˜¯ï¼Œç”±`static`ä¿®é¥°çš„æˆå‘˜å†…éƒ¨ç±»ã€‚å¦‚æœæ²¡æœ‰`static`ä¿®é¥°çš„æˆå‘˜å†…éƒ¨ç±»è¢«ç§°ä¸ºå¯¹è±¡çº§å†…éƒ¨ç±»ï¼›
>    2. ç±»çº§å†…éƒ¨ç±»ç›¸å½“äºå…¶å¤–éƒ¨ç±»çš„`static`æˆåˆ†ï¼Œå®ƒçš„å¯¹è±¡ä¸å¤–éƒ¨ç±»å¯¹è±¡é—´ä¸å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åˆ›å»ºã€‚è€Œå¯¹è±¡çº§å†…éƒ¨ç±»çš„å®ä¾‹ï¼Œæ˜¯ç»‘å®šåœ¨å¤–éƒ¨å¯¹è±¡å®ä¾‹ä¸­çš„ã€‚
>    3. ç±»çº§å†…éƒ¨ç±»ä¸­ï¼Œå¯ä»¥å®šä¹‰é™æ€çš„æ–¹æ³•ã€‚åœ¨é™æ€æ–¹æ³•ä¸­åªèƒ½å¤Ÿå¼•ç”¨å¤–éƒ¨ç±»ä¸­çš„é™æ€æˆå‘˜æ–¹æ³•æˆ–è€…æˆå‘˜å˜é‡ï¼›
>    4. ç±»çº§å†…éƒ¨ç±»ç›¸å½“äºå…¶å¤–éƒ¨ç±»çš„æˆå‘˜ï¼Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡è¢«ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šè¢«è£…è½½ï¼›
> 2. å¤šçº¿ç¨‹ç¼ºçœåŒæ­¥é”ï¼šå¤§å®¶éƒ½çŸ¥é“ï¼Œåœ¨å¤šçº¿ç¨‹å¼€å‘ä¸­ï¼Œä¸ºäº†è§£å†³å¹¶å‘é—®é¢˜ï¼Œä¸»è¦æ˜¯é€šè¿‡ä½¿ç”¨`synchronized`å…³é”®å­—æ¥åŠ äº’æ–¥é”è¿›è¡ŒåŒæ­¥æ§åˆ¶ã€‚ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒJVM å·²ç»éšå«åœ°ä¸ºä½ æ‰§è¡Œäº†åŒæ­¥ï¼Œè¿™äº›æƒ…å†µå°±ä¸ç”¨è‡ªå·±å†æ¥è¿›è¡ŒåŒæ­¥æ§åˆ¶ã€‚åŒ…æ‹¬ï¼š
>    1. ç”±é™æ€åˆå§‹åŒ–å™¨ï¼ˆåœ¨é™æ€å­—æ®µä¸Šæˆ–`static`ä»£ç å—ä¸­çš„åˆå§‹åŒ–å™¨ï¼‰åˆå§‹åŒ–æ•°æ®æ—¶ï¼›
>    2. è®¿é—®`final`å­—æ®µæ—¶
>    3. åœ¨åˆ›å»ºçº¿ç¨‹ä¹‹å‰åˆ›å»ºå¯¹è±¡æ—¶
>    4. çº¿ç¨‹å¯ä»¥çœ‹è§å®ƒå°†è¦å¤„ç†çš„å¯¹è±¡æ—¶

> [!IMPORTANT|label:è§£å†³æ–¹æ¡ˆæ€è·¯]
>
> è¦æƒ³ç®€å•åœ°å®ç°çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥é‡‡ç”¨é™æ€åˆå§‹åŒ–å™¨çš„æ–¹å¼ï¼Œå®ƒå¯ä»¥ç”± JVM æ¥ä¿è¯çº¿ç¨‹çš„å®‰å…¨æ€§ï¼Œæ¯”å¦‚å‰é¢çš„é¥¿æ±‰å¼å®ç°æ–¹å¼ã€‚ä½†æ˜¯è¿™æ ·ä¸€æ¥ï¼Œä¸æ˜¯ä¼šæµªè´¹ä¸€å®šçš„ç©ºé—´å—ï¼Ÿå› ä¸ºè¿™ç§å®ç°æ–¹å¼ï¼Œä¼šåœ¨ç±»åŠ è½½çš„æ—¶å€™å°±åˆå§‹åŒ–å¯¹è±¡ï¼Œä¸ç®¡ä½ éœ€ä¸éœ€è¦ã€‚å¦‚æœç°åœ¨æœ‰ä¸€ç§æ–¹æ³•èƒ½å¤Ÿè®©ç±»åŠ è½½çš„æ—¶å€™ä¸å»åˆå§‹åŒ–å¯¹è±¡ï¼Œé‚£ä¸å°±è§£å†³é—®é¢˜äº†ï¼Ÿä¸€ç§å¯è¡Œçš„æ–¹å¼å°±æ˜¯é‡‡ç”¨ç±»çº§å†…éƒ¨ç±»ï¼Œåœ¨è¿™ä¸ªç±»çº§å†…éƒ¨ç±»é‡Œé¢å»åˆ›å»ºå¯¹è±¡å®ä¾‹ã€‚è¿™æ ·ä¸€æ¥ï¼Œåªè¦ä¸ä½¿ç”¨åˆ°è¿™ä¸ªç±»çº§å†…éƒ¨ç±»ï¼Œé‚£å°±ä¸ä¼šåˆ›å»ºå¯¹è±¡å®ä¾‹ï¼Œä»è€ŒåŒæ—¶å®ç°**å»¶è¿ŸåŠ è½½**å’Œ**çº¿ç¨‹å®‰å…¨**ã€‚

ç»†å¿ƒçš„å°ä¼™ä¼´å¯èƒ½ä¼šå‘ç°ï¼Œå½“æˆ‘ä»¬æŠŠé¼ æ ‡æ”¾åœ¨**åŒé‡æ£€æŸ¥é”**çš„ç¬¬ä¸€ä¸ª if ä¸Šæ—¶ï¼Œä¼šå‡ºç°å¦‚ä¸‹æç¤ºï¼Œç‚¹å‡»ä¹‹åä»£ç ä¼šè‡ªåŠ¨å˜æˆ**é™æ€å†…éƒ¨ç±»**çš„è¿™ç§æ–¹å¼ã€‚<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242229597.png" alt="154d3753-9f35-481a-bf76-c06b2385cc46" style="zoom:80%;" /><br />ä½¿ç”¨**é™æ€å†…éƒ¨ç±»**å®ç°å•ä¾‹æ¨¡å¼è¿™ç§æ–¹å¼ï¼Œå…¼é¡¾äº†**é¥¿æ±‰å¼æµªè´¹å†…å­˜**å’Œ`synchronized`**çš„æ€§èƒ½é—®é¢˜**ï¼Œå®Œç¾åœ°å±è”½äº†è¿™ä¸¤ä¸ªç¼ºç‚¹ã€‚<br />å†…éƒ¨ç±»ä¸€å®šä¼šåœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰è¿›è¡Œåˆå§‹åŒ–çš„ï¼Œç”¨ä¸€ç§éå¸¸å·§å¦™çš„æ–¹å¼é¿å…äº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼

```java
public class LazyStaticInnerSingleton implements Serializable {
    private LazyStaticInnerSingleton() {
        // ç§æœ‰æ„é€ å‡½æ•°
    }

    /**
     * static å…³é”®å­—æ˜¯ä¸ºäº†ä½¿å•ä¾‹çš„ç©ºé—´å…±äº«ï¼Œä¿è¯è¿™ä¸ªæ–¹æ³•ä¸ä¼šè¢«é‡å†™ã€é‡è½½
     *
     * @return LazyStaticInnerSingleton å®ä¾‹å¯¹è±¡
     */
    public static LazyStaticInnerSingleton getInstance() {
        // åœ¨ç»“æœè¿”å›ä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆåŠ è½½å†…éƒ¨ç±»
        return SingletonHolder.INSTANCE;
    }

    /**
     * é™æ€å†…éƒ¨ç±»ï¼Œé»˜è®¤ä¸åŠ è½½
     */
    private static class SingletonHolder {
        private static final LazyStaticInnerSingleton INSTANCE = new LazyStaticInnerSingleton();
    }
}
```

åœ¨æµ‹è¯•ç±» ApiTest ä¸­å¢åŠ å¦‚ä¸‹æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test
public void test_04() {
    Runnable runnable = () -> {
        LazyStaticInnerSingleton instance = LazyStaticInnerSingleton.getInstance();
        LOGGER.info("{}ï¼š{}", Thread.currentThread().getName(), instance);
    };
    Thread t1 = new Thread(runnable);
    Thread t2 = new Thread(runnable);
    t1.start();
    t2.start();
}
```

å‘ç°ä¸ç®¡è¿è¡Œå¤šå°‘æ¬¡ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¸­çš„ LazyStaticInnerSingleton å®ä¾‹å¯¹è±¡æ€»æ˜¯åŒä¸€ä¸ªï¼Œè¯´æ˜ä½¿ç”¨**é™æ€å†…éƒ¨ç±»**çš„æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼å¯ä»¥ä¿éšœ**çº¿ç¨‹å®‰å…¨**ã€‚<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242229208.png" alt="image.png" style="zoom:80%;" />

### åå°„ç ´åå•ä¾‹

ä¸Šé¢ä»‹ç»çš„æ‰€æœ‰å•ä¾‹æ¨¡å¼ä¸­çš„æ„é€ æ–¹æ³•é™¤äº†åŠ ä¸Š`private`å…³é”®å­—ï¼Œå¹¶æ²¡æœ‰åšå…¶ä»–ä»»ä½•å¤„ç†ï¼å¯¼è‡´é€šè¿‡**åå°„**çš„æ–¹å¼è·å–å…¶ç§æœ‰æ„é€ æ–¹æ³•æ¥åˆ›å»ºå‡ºçš„å®ä¾‹å¯¹è±¡ä¸è°ƒç”¨`getInstance()`é™æ€æ–¹æ³•è·å–çš„å®ä¾‹å¯¹è±¡å¹¶ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼æµ‹è¯•æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@Test
public void test_05() {
    // æµ‹è¯•åå°„ç ´åå•ä¾‹
    Class<LazyStaticInnerSingleton> clazz = LazyStaticInnerSingleton.class;
    try {
        // é€šè¿‡åå°„çš„æ–¹å¼è·å–ç§æœ‰çš„æ„é€ æ–¹æ³•
        Constructor<LazyStaticInnerSingleton> constructor = clazz.getDeclaredConstructor();
        // å¼ºåˆ¶è®¿é—®
        constructor.setAccessible(true);
        // æš´åŠ›åˆå§‹åŒ–
        LazyStaticInnerSingleton o1 = constructor.newInstance();
        LOGGER.info("{}", o1);

        LazyStaticInnerSingleton o2 = LazyStaticInnerSingleton.getInstance();
        LOGGER.info("{}", o2);
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}
```

å¯ä»¥å‘ç°ï¼Œçš„ç¡®åˆ›å»ºå‡ºäº†ä¸¤ä¸ªä¸åŒçš„å®ä¾‹å¯¹è±¡ï¼<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242229846.png" alt="image.png" style="zoom:80%;" /><br />é‚£ä¹ˆè¯¥å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿåœ¨ç§æœ‰çš„æ„é€ æ–¹æ³•ä¸­åšä¸€äº›é™åˆ¶ï¼Œå‘ç°ä¸€æ—¦é€šè¿‡åå°„çš„æ–¹å¼è°ƒç”¨è¯¥ç§æœ‰çš„æ„é€ æ–¹æ³•æ¥åˆ›å»ºå®ä¾‹å¯¹è±¡çš„è¯ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class LazyStaticInnerSingleton implements Serializable {
    private LazyStaticInnerSingleton() {
        if (SingletonHolder.INSTANCE != null) {
            throw new RuntimeException("å®ä¾‹å·²ç»å­˜åœ¨ï¼Œè¯·é€šè¿‡ getInstance() æ–¹æ³•è·å–å®ä¾‹å¯¹è±¡ï¼");
        }
    }

    /**
     * static å…³é”®å­—æ˜¯ä¸ºäº†ä½¿å•ä¾‹çš„ç©ºé—´å…±äº«ï¼Œä¿è¯è¿™ä¸ªæ–¹æ³•ä¸ä¼šè¢«é‡å†™ã€é‡è½½
     *
     * @return LazyStaticInnerSingleton å®ä¾‹å¯¹è±¡
     */
    public static LazyStaticInnerSingleton getInstance() {
        // åœ¨ç»“æœè¿”å›ä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆåŠ è½½å†…éƒ¨ç±»
        return SingletonHolder.INSTANCE;
    }

    /**
     * é™æ€å†…éƒ¨ç±»ï¼Œé»˜è®¤ä¸åŠ è½½
     */
    private static class SingletonHolder {
        private static final LazyStaticInnerSingleton INSTANCE = new LazyStaticInnerSingleton();
    }
}
```

å†æ¬¡è¿è¡Œæµ‹è¯•æ–¹æ³•ï¼Œå‘ç°ä¼šç›´æ¥æŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸ï¼è¿™æ ·åšå¯ä»¥é˜²æ­¢ç”¨æˆ·é€šè¿‡åå°„çš„æ–¹å¼æ¥ç ´åå•ä¾‹ï¼<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242229205.png" alt="image.png" style="zoom:80%;" />

### åºåˆ—åŒ–ç ´åå•ä¾‹

æœ‰æ—¶åœ¨ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºå¥½ä¹‹åï¼Œéœ€è¦å°†è¯¥å¯¹è±¡åºåˆ—åŒ–ä¹‹åå†™å…¥ç£ç›˜ä¸­ï¼Œä¸‹æ¬¡ä½¿ç”¨æ—¶å†ä»ç£ç›˜ä¸­è¯»å–å¯¹è±¡å¹¶è¿›è¡Œååºåˆ—åŒ–ï¼Œå°†å…¶è½¬åŒ–ä¸ºå†…å­˜å¯¹è±¡ã€‚ååºåˆ—åŒ–åçš„å¯¹è±¡ä¼šé‡æ–°åˆ†é…å†…å­˜ï¼Œå³é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚å¦‚æœåºåˆ—åŒ–çš„ç›®æ ‡å¯¹è±¡ä¸ºä¸€ä¸ªå•ä¾‹å¯¹è±¡çš„è¯ï¼Œå°±è¿èƒŒäº†å•ä¾‹æ¨¡å¼çš„åˆè¡·ï¼Œç›¸å½“äºç ´åäº†å•ä¾‹ã€‚

- **åºåˆ—åŒ–**ï¼šå°±æ˜¯æŠŠå†…å­˜ä¸­çš„çŠ¶æ€é€šè¿‡è½¬æ¢æˆå­—èŠ‚ç çš„å½¢å¼ï¼Œä»è€Œè½¬æ¢æˆä¸€ä¸ª I/O æµï¼Œå†™å…¥å…¶ä»–åœ°æ–¹ï¼ˆå¯ä»¥æ˜¯ç£ç›˜ã€ç½‘ç»œ I/Oï¼‰ï¼Œå†…å­˜ä¸­çš„çŠ¶æ€å°±ä¼šè¢«æ°¸ä¹…ä¿å­˜ä¸‹æ¥ï¼›
- **ååºåˆ—åŒ–**ï¼šå°±æ˜¯å°†å·²ç»æŒä¹…åŒ–çš„å­—èŠ‚ç å†…å®¹è½¬æ¢ä¸º I/O æµï¼Œé€šè¿‡è¯»å– I/O æµï¼Œè¿›è€Œå°†è¯»å–çš„å†…å®¹è½¬æ¢ä¸º Java å¯¹è±¡ï¼Œåœ¨è½¬æ¢çš„è¿‡ç¨‹ä¸­ä¼š**é‡æ–°åˆ›å»ºå¯¹è±¡**ï¼ˆnewï¼‰ï¼›

æ¼”ç¤ºæµ‹è¯•æ¡ˆä¾‹ä¹‹å‰å…ˆè®©ä½¿ç”¨**é™æ€å†…éƒ¨ç±»**å•ä¾‹æ¨¡å¼çš„`LazyStaticInnerSingleton`ç±»å®ç°åºåˆ—åŒ–`Serializable`æ¥å£ï¼Œå¦åˆ™çš„è¯åœ¨è¿›è¡Œåºåˆ—åŒ–æ—¶ä¼šæŠ›å‡º NotSerializableException å¼‚å¸¸ï¼è¿™ä¸€æ­¥æ“ä½œåªæ˜¯ä¸ºäº†è®©åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œèƒ½å¤Ÿæ­£å¸¸è¿›è¡Œï¼Œå¦‚æœä¸æƒ³è®©å•ä¾‹è¢«åºåˆ—åŒ–ç ´åçš„è¯ï¼Œåˆ™æ²¡å¿…è¦å®ç°åºåˆ—åŒ–`Serializable`æ¥å£ã€‚<br />åœ¨æµ‹è¯•ç±» ApiTest ä¸­å¢åŠ å¦‚ä¸‹æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test
public void test_06() {
    LazyStaticInnerSingleton o1 = LazyStaticInnerSingleton.getInstance();
    LOGGER.info("{}", o1);
    try (FileOutputStream fos = new FileOutputStream("LazyStaticInnerSingleton.obj");
         ObjectOutputStream oos = new ObjectOutputStream(fos)) {
        oos.writeObject(o1);
        oos.flush();
        try (FileInputStream fis = new FileInputStream("LazyStaticInnerSingleton.obj");
             ObjectInputStream ois = new ObjectInputStream(fis)) {
            LazyStaticInnerSingleton o2 = (LazyStaticInnerSingleton) ois.readObject();
            LOGGER.info("{}", o2);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242230111.png" alt="image.png" style="zoom: 80%;" /><br />å¯ä»¥å‘ç°ååºåˆ—åŒ–åçš„å®ä¾‹å¯¹è±¡ä¸è°ƒç”¨`getInstance()`é™æ€æ–¹æ³•è·å–çš„å®ä¾‹å¯¹è±¡å¹¶ä¸ä¸€è‡´ï¼è¿™æ ·çš„è¯å°±è¿èƒŒäº†å•ä¾‹æ¨¡å¼çš„è®¾è®¡åˆè¡·ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•åœ¨åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„æƒ…å†µä¸‹ä¹Ÿèƒ½å¤Ÿä¿è¯å•ä¾‹å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ç±»ä¸­å¢åŠ ä¸€ä¸ª`readResolve()`æ–¹æ³•å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class LazyStaticInnerSingleton implements Serializable {
    private LazyStaticInnerSingleton() {
        if (SingletonHolder.INSTANCE != null) {
            throw new RuntimeException("å®ä¾‹å·²ç»å­˜åœ¨ï¼Œè¯·é€šè¿‡ getInstance() æ–¹æ³•è·å–å®ä¾‹å¯¹è±¡ï¼");
        }
    }

    /**
     * static å…³é”®å­—æ˜¯ä¸ºäº†ä½¿å•ä¾‹çš„ç©ºé—´å…±äº«ï¼Œä¿è¯è¿™ä¸ªæ–¹æ³•ä¸ä¼šè¢«é‡å†™ã€é‡è½½
     *
     * @return LazyStaticInnerSingleton å®ä¾‹å¯¹è±¡
     */
    public static LazyStaticInnerSingleton getInstance() {
        // åœ¨ç»“æœè¿”å›ä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆåŠ è½½å†…éƒ¨ç±»
        return SingletonHolder.INSTANCE;
    }

    private Object readResolve() {
        return SingletonHolder.INSTANCE;
    }

    /**
     * é™æ€å†…éƒ¨ç±»ï¼Œé»˜è®¤ä¸åŠ è½½
     */
    private static class SingletonHolder {
        private static final LazyStaticInnerSingleton INSTANCE = new LazyStaticInnerSingleton();
    }
}
```

é€šè¿‡ JDk æºç åˆ†æï¼Œå‘ç°è™½ç„¶é€šè¿‡å¢åŠ `readResolve()`æ–¹æ³•çš„æ–¹å¼è§£å†³äº†å•ä¾‹æ¨¡å¼è¢«ç ´åçš„é—®é¢˜ï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜æ˜¯å®ä¾‹åŒ–äº†ä¸¤æ¬¡ï¼Œåªä¸è¿‡æ–°åˆ›å»ºçš„å¯¹è±¡æ²¡æœ‰è¢«è¿”å›è€Œå·²ï¼å¦‚æœåˆ›å»ºå¯¹è±¡çš„åŠ¨ä½œå‘ç”Ÿé¢‘ç‡åŠ å¿«ï¼Œå°±æ„å‘³ç€å†…å­˜åˆ†é…å¼€é”€ä¹Ÿä¼šéšä¹‹å¢å¤§ã€‚éš¾é“çœŸçš„å°±æ²¡åŠæ³•ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜å—ï¼Ÿæœ‰çš„ï¼Œè¯·çœ‹ä¸‹é¢çš„æ³¨å†Œå¼å•ä¾‹æ¨¡å¼ã€‚

### æšä¸¾å¼å•ä¾‹æ¨¡å¼

> [!IMPORTANT]
> å•å…ƒç´ çš„æšä¸¾ç±»å‹å·²ç»æˆä¸ºå®ç°å•ä¾‹æ¨¡å¼çš„æœ€ä½³æ–¹å¼ï¼å‡ºè‡ªã€ŠEffective Javaã€‹
>
> - Java çš„æšä¸¾ç±»å‹å®è´¨ä¸Šæ˜¯åŠŸèƒ½é½å…¨çš„ç±»ï¼Œå› ä¸ºå¯ä»¥æœ‰è‡ªå·±çš„å±æ€§å’Œæ–¹æ³•ï¼›
> - Java æšä¸¾ç±»å‹çš„åŸºæœ¬æ€æƒ³æ˜¯é€šè¿‡å…¬æœ‰çš„é™æ€`final`åŸŸä¸ºæ¯ä¸ªæšä¸¾å¸¸é‡å¯¼å‡ºå®ä¾‹çš„ç±»ï¼›
> - ä»æŸä¸ªè§’åº¦è®²ï¼Œæšä¸¾æ˜¯å•ä¾‹çš„æ³›å‹åŒ–ï¼Œæœ¬è´¨ä¸Šæ˜¯å•å…ƒç´ çš„æšä¸¾ï¼›
>
> ä½¿ç”¨æšä¸¾æ¥å®ç°å•ä¾‹æ§åˆ¶ä¼šæ›´åŠ ç®€æ´ï¼Œè€Œä¸”æ— å¿åœ°æä¾›äº†åºåˆ—åŒ–çš„æœºåˆ¶ï¼Œå¹¶ç”± JVM ä»æ ¹æœ¬ä¸Šæä¾›ä¿éšœï¼Œç»å¯¹é˜²æ­¢å¤šæ¬¡å®ä¾‹åŒ–ï¼Œæ˜¯æ›´ç®€æ´ã€é«˜æ•ˆã€å®‰å…¨çš„å®ç°å•ä¾‹çš„æ–¹å¼ã€‚

```java
public enum EnumSingleton {
    /**
     * å•ä¾‹å¯¹è±¡
     */
    INSTANCE;

    private Object data;

    public Object getData() {
        return data;
    }

    public void setData(Object data) {
        this.data = data;
    }
}
```

å’±ä»¬å…ˆæµ‹è¯•ä¸€ä¸‹èƒ½å¦é€šè¿‡åå°„çš„æ–¹å¼ç ´åå•ä¾‹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯**ä¸èƒ½**ã€‚åœ¨æµ‹è¯•ç±» ApiTest ä¸­å¢åŠ å¦‚ä¸‹æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test
public void test_07() {
    Class<EnumSingleton> clazz = EnumSingleton.class;
    try {
        Constructor<EnumSingleton> constructor = clazz.getConstructor();
        constructor.setAccessible(true);
        EnumSingleton o1 = constructor.newInstance();
        EnumSingleton o2 = constructor.newInstance();
        LOGGER.info("{}", o1);
        LOGGER.info("{}", o2);
        LOGGER.info("{}", o1 == o2);
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼šæŠ›å‡º NoSuchMethodException å¼‚å¸¸ï¼Œè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°æ— å‚çš„æ„é€ æ–¹æ³•ã€‚<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242230324.png" alt="image.png" style="zoom:80%;" /><br />æ­¤æ—¶ï¼ŒæŸ¥çœ‹ Enum ç±»ä¸­çš„æ„é€ æ–¹æ³•ï¼Œå‘ç°åªæœ‰ä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
protected Enum(String name, int ordinal) {
    this.name = name;
    this.ordinal = ordinal;
}
```

ä¿®æ”¹ ApiTest æµ‹è¯•ç±»ä¸­çš„æµ‹è¯•æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@Test
public void test_07() {
    Class<EnumSingleton> clazz = EnumSingleton.class;
    try {
        Constructor<EnumSingleton> constructor = clazz.getDeclaredConstructor(String.class, int.class);
        constructor.setAccessible(true);
        EnumSingleton o1 = constructor.newInstance("instance", 1);
        EnumSingleton o2 = constructor.newInstance("instance", 2);
        LOGGER.info("{}", o1);
        LOGGER.info("{}", o2);
        LOGGER.info("{}", o1 == o2);
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}
```

å†æ¬¡è¿è¡Œï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼šæŠ›å‡º IllegalArgumentException å¼‚å¸¸ï¼Œæ— æ³•é€šè¿‡åå°„çš„æ–¹å¼åˆ›å»ºæšä¸¾å¯¹è±¡ï¼<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242230242.png" alt="image.png" style="zoom:80%;" /><br />è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå’±ä»¬å¯ä»¥åœ¨ Constructor ç±»ä¸­çš„`newInstance()`æ–¹æ³•ä¸­æ‰¾åˆ°å¯¹åº”çš„ç­”æ¡ˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼šå¦‚æœæ˜¯æšä¸¾ç±»çš„è¯ï¼Œåˆ™ç›´æ¥æŠ›å‡º IllegalArgumentException å¼‚å¸¸ï¼<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242232550.png" alt="image" style="zoom:80%;" /><br />ç°åœ¨æ¥æµ‹è¯•ä¸€ä¸‹èƒ½å¦é€šè¿‡åºåˆ—åŒ–çš„æ–¹å¼ç ´åå•ä¾‹å‘¢ï¼Ÿç­”æ¡ˆä¾æ—§æ˜¯**ä¸èƒ½**ã€‚åœ¨æµ‹è¯•ç±» ApiTest ä¸­å¢åŠ å¦‚ä¸‹æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test
public void test_08() {
    Object obj = new Object();
    EnumSingleton o1 = EnumSingleton.INSTANCE;
    o1.setData(obj);
    try (FileOutputStream fos = new FileOutputStream("EnumSingleton.obj");
         ObjectOutputStream oos = new ObjectOutputStream(fos)) {
        oos.writeObject(o1);
        oos.flush();
        try (FileInputStream fis = new FileInputStream("EnumSingleton.obj");
             ObjectInputStream ois = new ObjectInputStream(fis)) {
            EnumSingleton o2 = (EnumSingleton) ois.readObject();

            LOGGER.info("{}", o1.getData());
            LOGGER.info("{}", o2.getData());
            LOGGER.info("{}", o1.getData() == o2.getData());
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242233610.png" alt="image.png" style="zoom:80%;" /><br />è¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå’±ä»¬æ¥çœ‹ä¸‹ ObjectInputStream è¾“å…¥æµä¸­çš„`readObject()`æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242233631.png" alt="image.png" style="zoom:80%;" /><br />åç¼–è¯‘ EnumSingleton æšä¸¾ç±»ä½¿ç”¨ Java åç¼–è¯‘å·¥å…· Jad => EnumSingleton.Jad æ–‡ä»¶ï¼š

```java
static {
	INSTANCE = new EnumSingleton("INSTANCE", 0);
	$VALUES = (new EnumSingleton[] {INSTANCE});
}
```

åŸæ¥ï¼Œæšä¸¾å¼å•ä¾‹æ¨¡å¼åœ¨é™æ€ä»£ç å—ä¸­å°±ç»™ INSTANCE è¿›è¡Œäº†èµ‹å€¼ï¼Œå±äºé¥¿æ±‰å¼å•ä¾‹æ¨¡å¼çš„å®ç°ã€‚<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242233727.png" alt="image.png" style="zoom:80%;" />

### çº¿ç¨‹å•ä¾‹å®ç° ThreadLocal

```java
public class ThreadLocalSingleton {
    private static final ThreadLocal<ThreadLocalSingleton> TL = ThreadLocal.withInitial(ThreadLocalSingleton::new);

    private ThreadLocalSingleton() {
        // ç§æœ‰æ„é€ å‡½æ•°
    }

    public static ThreadLocalSingleton getInstance() {
        return TL.get();
    }
}
```

åœ¨æµ‹è¯•ç±» ApiTest ä¸­å¢åŠ å¦‚ä¸‹æµ‹è¯•æ–¹æ³•ï¼š

```java
 @Test
public void test_09() {
    LOGGER.info("{}", ThreadLocalSingleton.getInstance());
    LOGGER.info("{}", ThreadLocalSingleton.getInstance());
    Runnable runnable = () -> {
        ThreadLocalSingleton instance = ThreadLocalSingleton.getInstance();
        LOGGER.info("{}ï¼š{}", Thread.currentThread().getName(), instance);
    };
    Thread t1 = new Thread(runnable);
    Thread t2 = new Thread(runnable);
    t1.start();
    t2.start();
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ï¼Œè·å–åˆ°çš„å®ä¾‹éƒ½æ˜¯åŒä¸€ä¸ªï¼Œåœ¨ä¸¤ä¸ªå­çº¿ç¨‹ä¸­åˆ†åˆ«è·å–åˆ°äº†ä¸åŒçš„å®ä¾‹ã€‚<br /><img src="https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202307242233530.png" alt="image.png" style="zoom:80%;" /><br />ThreadLocal ä¸èƒ½ä¿è¯å…¶åˆ›å»ºçš„å¯¹è±¡æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œä½†æ˜¯èƒ½ä¿è¯åœ¨å•ä¸ªçº¿ç¨‹ä¸­æ˜¯å”¯ä¸€çš„ï¼Œå¤©ç”Ÿå°±æ˜¯**çº¿ç¨‹å®‰å…¨**çš„ã€‚è¿™æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼ŸThreadLocal é’ˆå¯¹æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ª ThreadLocalMap é›†åˆï¼Œç„¶åä¼šå°†å®ä¾‹åŒ–åçš„å¯¹è±¡å­˜åˆ°å½“å‰çº¿ç¨‹æ‰€ç»´æŠ¤çš„é›†åˆä¸­ã€‚

## å‚è€ƒèµ„æ–™

- [ã€Šç ”ç£¨è®¾è®¡æ¨¡å¼ã€‹](https://book.douban.com/subject/5343318/)
- [ã€Šæ·±å…¥è®¾è®¡æ¨¡å¼ã€‹](https://refactoringguru.cn/)
- [Java Singleton Design Pattern Best Practices with Examples | DigitalOcean](https://www.digitalocean.com/community/tutorials/java-singleton-design-pattern-best-practices-examples#8-serialization-and-singleton)
