# MySQL 面试题

## InnoDB 与 MyISAM 存储引擎的区别

- InnoDB 支持事务，MyISAM 不支持事务；
- InnoDB 支持外键，MyISAM 不支持外键；
- InnDB 使用聚簇索引，MyISAM 使用非聚簇索引；
- InnoDB 支持行级锁，MyISAM 支持表级锁；
- InnoDB 表对应两个文件，一个 `.frm`表结构文件，一个`.ibd`数据文件。MyISAM 表对应三个文件，一个 `.frm`表结构文件，一个`.myd`数据文件，一个`.myi`索引文件；

## 索引

### 什么是索引

索引是用来快速查找记录的一种数据结构。在 MySQL 默认的存储引擎 InnoDB 中使用 B+ 树来存储索引，B+ 树是一颗多路平衡查找树，它的特点是非叶子节点只存储索引，数据存放在叶子节点，这样可以相比于 B 树可以减少层高，从而降低磁盘 I/O 读写次数，提高数据的检索效率。而且叶子节点按照索引列递增的顺序使用双向链表进行连接，因此通过索引对数据进行排序、分组和范围查询都非常方便。

### 索引创建原则

- 针对于数量较大，且查询比较频繁的表建立索引；
- 针对于常作为查询条件（where）、排序（order by）、分组（group by）的字段建立索引；
- 尽量选择区分度高的列作为索引，区分度越高，使用索引的效率就越高；
- 尽量使用联合索引，减少单列索引，这样在查询的时候，联合索引可以用到索引覆盖，避免回表，提高查询效率，而且一个联合索引比多个单列索引更加节省空间；
- 要控制索引的数量，索引并不是越多越好，索引越多，维护索引结构的代价也就越大，会影响增删改的效率；

### 什么情况下不建索引

- 表的数据量太小，即使没有索引，查询速度也比较快，此时建索引的话，反而会增加维护的成本和查询时间；
- 频繁变更的表，需要经常更新、删除或插入记录，维护索引的开销将会很大；
- 数据离散度不高的列，可能会导致遍历整棵 B+ 树，比如说性别这样的列；
- 参与计算的列；

### 索引分类

- 按数据结构划分：

- - B+ 树索引：索引结构是一个多路平衡树，B+ 树是一颗多路平衡查找树，它的特点是**非叶子节点只存储索引，数据存放在叶子节点**，这样可以相较于 B 树来说可以减少层高，从而降低磁盘 I/O 的读写次数，提高数据的检索效率；而且**叶子节点按照索引列递增的顺序使用双向链表进行连接**，因此通过索引对数据进行排序和范围查询都非常方便；
  - Hash 索引：索引结构和 HashMap 的结构有点类似，采用 Hash 进行检索的效率比较高，基本上一次检索就可以找到对应的数据。适合等值查询，不适合排序，范围查询，模糊查询和联合索引的最左前缀原则。

- 按物理存储划分：区分聚簇索引与非聚簇索引只要判断数据和索引是否在一起。

- - 聚簇索引：又称之为聚集索引或者一级索引；

- - - 在 InnoDB 存储引擎中，数据和索引全部存放在`.ibd`的文件中，因此 InnoDB 存储引擎中既有聚簇索引也有非聚簇索引；
    - **在 InnoDB 存储引擎中要求每张表必须<u>有且仅有</u>一个聚簇索引**，**默认情况会在<u>主键</u>字段上建立聚簇索引**，如果表中没有主键字段，则表中第一个非空（NOT NULL）且唯一（UNIQUE）的列将作为聚簇索引，如果以上条件都不满足的话，则会创建一个隐藏的自增的 6 个字节的 row_id 列作为聚簇索引；
    - 聚簇索引中的**非叶子节点记录的是聚簇索引所在列（通常为主键）的值，<u>叶子节点记录的是完整的行数据**</u>，叶子节点之间按照主键列递增连接，叶子节点所在的数据页之间使用双向链表进行连接，因此可以很方便的进行范围查询；

- - 非聚簇索引：又称之为辅助索引或者二级索引；

- - - 在 MyISAM 存储引擎中的数据存放在`.myd`文件中，索引存储在`.myi`文件中，所以 MyISAM 存储引擎中的索引都是非聚簇索引；
    - **非聚簇索引中的<u>叶子节点记录的是聚簇索引（通常为主键）的值**</u>；
    - 由于二级索引中的叶子节点记录的是主键而不是完整的行数据，所以使用二级索引作为查询条件时，需要扫描两次 B+ 树，第一次通过二级索引找到对应的主键值，然后再通过主键值找到聚簇索引中所对应的行数据，这个过程就是**回表**；
    - **覆盖索引**是指查询时使用到了索引，并且需要返回的列可以在该索引中全部找到，就不再需要进行回表；可以使用 Explain 命令查看 SQL 语句的执行计划，如果执行中的 Extra 字段出现了 Using Index 的话，表示触发了索引覆盖；=> 应该尽量避免使用 SELECT *；

- - 按使用层面划分：

- - - 主键索引：一张表中只能有一个主键，值必须唯一且非空；
    - 唯一索引：值必须唯一但允许有空值；
    - 普通索引：是最基本的索引，没有什么限制；
    - 联合索引：使用多个字段一起创建的索引，相较于单列索引来说，实际开发中推荐使用联合索引，使用时注意遵循最左前缀原则；

### 最左前缀原则

如果创建的是一个联合索引，就需要遵循最左前缀原则。在使用索引时，where 条件需要从索引的最左前列开始使用，并且不能跳过索引中的列进行使用。因为 MySQL 在创建联合索引时是先对最左边的列进行排序，在此基础上再对第二列进行排序，依此类推。

### 索引失效场景

- 在使用索引的时候没有遵循最左前缀原则；
- 模糊查询，如果以 "%" 开头也会导致索引失效；
- 对索引字段进行了运算、函数操作或者类型转换也会导致索引失效；
- 使用联合索引进行查询时，中间使用了范围查询，此时右边的列无法使用索引；

### 索引下推

联合索引先执行过滤条件再进行回表操作，可用于减少回表次数。
