# Java åŸºç¡€é¢è¯•é¢˜ï¼ˆä¸‹ï¼‰

## Integer a1 = 100ï¼ŒInteger a2 = 100ï¼ŒInteger a3 = 128ï¼ŒInteger a4 = 128ï¼Œint a5 = 128ï¼Œæè¿° a1 == a2 ã€a3 == a4 ä»¥åŠ a3 == a5 çš„è¿è¡Œç»“æœä»¥åŠåŸå› 

ğŸ¤“ï¼šè¿è¡Œç»“æœä¸º **true**ã€**false**ã€**true**ï¼ŒåŸå› è§å¦‚ä¸‹åˆ†æè¿‡ç¨‹ã€‚

æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

```java
public class Test1 {  
    private static final Logger LOGGER = LoggerFactory.getLogger(Test1.class);  
  
    public static void main(String[] args) {  
        Integer a1 = 100;  
        Integer a2 = 100;  
        Integer a3 = 128;  
        Integer a4 = 128;  
        int a5 = 128;  
        LOGGER.debug("a1 == a2ï¼Ÿ{}", a1 == a2);  
        LOGGER.debug("a3 == a4ï¼Ÿ{}", a3 == a4);  
        LOGGER.debug("a3 == a5ï¼Ÿ{}", a3 == a5);  
    }  
}
```

è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
2022-10-14 15:55:56.375 DEBUG Test1:22 - a1 == a2ï¼Ÿtrue
2022-10-14 15:55:56.376 DEBUG Test1:23 - a3 == a4ï¼Ÿfalse
2022-10-14 15:55:56.376 DEBUG Test1:24 - a3 == a5ï¼Ÿtrue
```

### åŸç†

#### == æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨åœ°å€

ç”¨ == æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨åœ°å€ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨åœ°å€ç›¸åŒï¼Œåˆ™ == æ¯”è¾ƒåè¿”å›çš„ç»“æœä¸º trueï¼›å¦‚æœä¸åŒçš„è¯ï¼Œåˆ™æ¯”è¾ƒåçš„ç»“æœä¸º falseã€‚  

#### Integer å¯¹è±¡çš„è‡ªåŠ¨æ‹†è£…ç®±æ“ä½œ

è‡ªåŠ¨è£…ç®±ï¼šå°±æ˜¯å°†åŸºæœ¬æ•°æ®ç±»å‹è‡ªåŠ¨è½¬æ¢æˆå¯¹åº”çš„åŒ…è£…ç±»ï¼›è‡ªåŠ¨æ‹†ç®±ï¼šå°±æ˜¯å°†åŒ…è£…ç±»è‡ªåŠ¨è½¬æ¢æˆå¯¹åº”çš„åŸºæœ¬ç±»å‹æ•°æ®ã€‚

```java
Integer i = 10; // è‡ªåŠ¨è£…ç®±
int b = i; // è‡ªåŠ¨æ‹†ç®±
```

å¯¹ä»¥ä¸Šä»£ç è¿›è¡Œåç¼–è¯‘åå¯ä»¥å¾—åˆ°å¦‚ä¸‹ä»£ç ï¼š

```java
Integer i = Integer.valueOf(10);  
int b = i.intValue();
```

ä»ä¸Šé¢åç¼–è¯‘åçš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ`int` çš„è‡ªåŠ¨è£…ç®±æ˜¯é€šè¿‡ `Integer` ç±»ä¸­çš„ `valueOf()` æ–¹æ³•æ¥å®ç°çš„ï¼Œè€Œ `Integer` è‡ªåŠ¨æ‹†ç®±éƒ½æ˜¯é€šè¿‡ `intValue()` æ–¹æ³•æ¥å®ç°çš„ã€‚æ„Ÿå…´è¶£çš„å°ä¼™ä¼´ï¼Œå¯ä»¥è¯•ç€å°†å…«ç§åŸºæœ¬æ•°æ®ç±»å‹éƒ½ç…§è¿™æ ·åç¼–è¯‘ä¸€éï¼Œä½ å°±ä¼šå‘ç°ä¸€ä¸ªè§„å¾‹ï¼š**è‡ªåŠ¨è£…ç®±éƒ½æ˜¯é€šè¿‡åŒ…è£…ç±»çš„ `valueOf()` æ–¹æ³•æ¥å®ç°çš„ï¼Œè‡ªåŠ¨æ‹†ç®±éƒ½æ˜¯é€šè¿‡åŒ…è£…ç±»çš„ `xxxValue()` æ–¹æ³•æ¥å®ç°çš„**ã€‚

#### Integer å¯¹è±¡çš„ valueOf æ–¹æ³•

>`Integer` å¯¹è±¡ä¸­çš„ `valueOf()` æ–¹æ³•ç”¨åˆ°äº† **äº«å…ƒè®¾è®¡æ¨¡å¼**ï¼Œå¦‚ä½•åˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº«å…ƒæ¨¡å¼å‘¢ï¼Ÿå®ƒä¼šå…ˆè¿”å›ç¼“å­˜å¯¹è±¡è€Œä¸æ˜¯åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚å¯¹äº **äº«å…ƒè®¾è®¡æ¨¡å¼** ä¸æ¸…æ¥šçš„å°ä¼™ä¼´å¯ä»¥æŸ¥çœ‹ [äº«å…ƒæ¨¡å¼](../../ç ”ç£¨è®¾è®¡æ¨¡å¼/äº«å…ƒæ¨¡å¼.md) è¿™ä¸€ç¯‡æ–‡ç« ï¼Œæ–‡ç« ä¸­è¯¦ç»†åœ°ä»‹ç»äº†ä½¿ç”¨äº«å…ƒæ¨¡å¼çš„ç›®çš„ä»¥åŠå¦‚ä½•å®ç°äº«å…ƒæ¨¡å¼ã€‚  

```java
public static Integer valueOf(int i) {  
    if (i >= IntegerCache.low && i <= IntegerCache.high)  
        return IntegerCache.cache[i + (-IntegerCache.low)];  
    return new Integer(i);  
}
```

åœ¨ `Integer` åŒ…è£…ç±»ä¸­æœ‰ä¸€ä¸ªç§æœ‰çš„é™æ€å†…éƒ¨ç±» `IntegerCache`ï¼Œåœ¨è¿™ä¸ªç±»ä¸­ç¼“å­˜äº†ä» [-128, 127] ä¹‹é—´çš„æ‰€æœ‰çš„ `Integer` å¯¹è±¡ï¼Œå¹¶å°†å…¶å­˜æ”¾åœ¨ `cache` æ•°ç»„ä¸­ã€‚

```java
private static class IntegerCache {  
    static final int low = -128;  
    static final int high;  
    static final Integer[] cache;  
    static Integer[] archivedCache;  
  
    static {  
        // high value may be configured by property  
        int h = 127;  
        String integerCacheHighPropValue =  
            VM.getSavedProperty("java.lang.Integer.IntegerCache.high");  
        if (integerCacheHighPropValue != null) {  
            try {  
                h = Math.max(parseInt(integerCacheHighPropValue), 127);  
                // Maximum array size is Integer.MAX_VALUE  
                h = Math.min(h, Integer.MAX_VALUE - (-low) -1);  
            } catch( NumberFormatException nfe) {  
                // If the property cannot be parsed into an int, ignore it.  
            }  
        }  
        high = h;  
  
        // Load IntegerCache.archivedCache from archive, if possible  
        CDS.initializeFromArchive(IntegerCache.class);  
        int size = (high - low) + 1;  
  
        // Use the archived cache if it exists and is large enough  
        if (archivedCache == null || size > archivedCache.length) {  
            Integer[] c = new Integer[size];  
            int j = low;  
            for(int i = 0; i < c.length; i++) {  
                c[i] = new Integer(j++);  
            }  
            archivedCache = c;  
        }  
        cache = archivedCache;  
        // range [-128, 127] must be interned (JLS7 5.1.7)  
        assert IntegerCache.high >= 127;  
    }  
  
    private IntegerCache() {}  
}
```

![|502](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061428623.png)  
é€šè¿‡ä¸Šè¿°æºç ä¸éš¾å‘ç°ï¼Œåœ¨ `Integer` çš„ `valueOf()` æ–¹æ³•ä¸­ï¼Œå¦‚æœæ•°å€¼åœ¨ [-128, 127] èŒƒå›´çš„æ—¶å€™ï¼Œå°±ä¼šå» `IntegerCache` ç±»ä¸­çš„ `cache` æ•°ç»„ä¸­æŸ¥æ‰¾å¯¹åº” `Integer` å¯¹è±¡çš„å¼•ç”¨å¹¶è¿”å›ï¼›å¦‚æœæ•°å€¼è¶…è¿‡äº†è§„å®šçš„èŒƒå›´ï¼Œåˆ™ä¼šæ–°å»ºä¸€ä¸ª `Integer` å¯¹è±¡è¿”å›ã€‚  

### åˆ†æ

a1 å’Œ a2 ä¼šå…ˆå„è‡ªè°ƒç”¨ `Integer` ä¸­çš„ `valueOf()` è¿›è¡Œè£…ç®±æ“ä½œï¼Œå› ä¸º a1 å’Œ a2 çš„æ•°å€¼éƒ½åœ¨ [-128, 127] ä¹‹é—´ï¼Œæ‰€ä»¥ä¼šä»äº‹å…ˆå·²ç»åˆå§‹åŒ–å¥½çš„ `cache` æ•°ç»„ä¸­ç›´æ¥è·å–ï¼Œç”±äºå˜é‡ a1 å’Œ a2 çš„æ•°å€¼ä¸€æ ·ï¼Œæ‰€ä»¥ä»æ•°ç»„ä¸­å–å‡ºçš„æ˜¯åŒä¸€ä¸ª `Integer` å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒä¿©ç”¨ == æ¯”è¾ƒè¿”å›çš„ç»“æœæ˜¯ trueã€‚  

---

a2 å’Œ a3 ä¹Ÿä¼šå…ˆè°ƒç”¨ `Integer` ä¸­çš„ `valueOf()` è¿›è¡Œè£…ç®±æ“ä½œï¼Œä½†æ˜¯å€¼å´ä¸åœ¨ [-128, 127] ä¹‹é—´ï¼Œå› æ­¤ä¸æ˜¯ä»æ•°ç»„ä¸­è·å–ï¼Œè€Œæ˜¯å„è‡ªå®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„ `Integer` å¯¹è±¡è¿”å›ï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨åœ°å€è‚¯å®šä¸åŒï¼Œæ‰€ä»¥å®ƒä¿©ç”¨ == æ¯”è¾ƒè¿”å›çš„ç»“æœæ˜¯ falseã€‚  
a3 å’Œ a5 æ¯”è¾ƒçš„æ—¶å€™

---

æ‰§è¡Œåç¼–è¯‘ä¹‹åå¯ä»¥å‘ç°ï¼Œæ‰§è¡Œ a3 == a5 çš„æ—¶å€™ï¼Œä¼šå…ˆæ‰§è¡Œ a3 çš„è‡ªåŠ¨æ‹†ç®±æ“ä½œï¼Œè°ƒç”¨ `Integer` çš„ `intValue()`ï¼Œç”±äºæ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªåŸºæœ¬æ•°æ®ç±»å‹å¹¶ä¸”æ•°å€¼åˆç›¸ç­‰ï¼Œæ‰€ä»¥å®ƒä¿©ç”¨ == æ¯”è¾ƒè¿”å›çš„ç»“æœæ˜¯ trueã€‚

```java
public class Test1 {  
  private static final Logger LOGGER = LoggerFactory.getLogger(Test1.class);  
    
  public static void main(String[] args) {  
    Integer a1 = Integer.valueOf(100);  
    Integer a2 = Integer.valueOf(100);  
    Integer a3 = Integer.valueOf(128);  
    Integer a4 = Integer.valueOf(128);  
    int a5 = 128;  
    LOGGER.debug("a1 == a2ï¼Ÿ{}", Boolean.valueOf((a1 == a2)));  
    LOGGER.debug("a3 == a4ï¼Ÿ{}", Boolean.valueOf((a3 == a4)));  
    LOGGER.debug("a3 == a5ï¼Ÿ{}", Boolean.valueOf((a3.intValue() == a5)));  
  }  
}
```

### æ‰©å±•

å¦‚æœå°†ä¸Šé¢çš„åŒ…è£…ç±»å‹æ¢æˆ `Double` ç±»å‹ï¼Œ

```java
public class Test1 {  
    private static final Logger LOGGER = LoggerFactory.getLogger(Test1.class);  
  
    public static void main(String[] args) {  
        Double a1 = 100.0;  
        Double a2 = 100.0;  
        Double a3 = 128.0;  
        Double a4 = 128.0;  
        int a5 = 128;  
        LOGGER.debug("a1 == a2ï¼Ÿ{}", a1 == a2);  
        LOGGER.debug("a3 == a4ï¼Ÿ{}", a3 == a4);  
        LOGGER.debug("a3 == a5ï¼Ÿ{}", a3 == a5);  
    }  
}
```

è¿è¡Œç»“æœä¼šæ˜¯æ€æ ·å‘¢ï¼Ÿå¦‚ä¸‹æ‰€ç¤ºï¼š

```
2022-10-14 16:48:56.684 DEBUG Test1:22 - a1 == a2ï¼Ÿfalse
2022-10-14 16:48:56.685 DEBUG Test1:23 - a3 == a4ï¼Ÿfalse
2022-10-14 16:48:56.685 DEBUG Test1:24 - a3 == a5ï¼Ÿtrue
```

ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿå’±ä»¬çœ‹ä¸‹ `Double` ç±»ä¸­çš„ `valueOf()` æ–¹æ³•çš„æºç å°±ä¸éš¾å‘ç°åŸå› ã€‚

```java
public static Double valueOf(double d) {  
    return new Double(d);  
}
```

å¯ä»¥çœ‹åˆ°ï¼Œ`Double` å¹¶æ²¡æœ‰ `Integer` çš„ç¼“å­˜æœºåˆ¶ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›äº†ä¸€ä¸ªæ–°çš„ `Double` å¯¹è±¡ï¼Œæ‰€ä»¥å¦‚æœç”¨ == æ¯”è¾ƒçš„è¯ï¼Œä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨åœ°å€ä¸ä¸€æ ·ï¼Œè‡ªç„¶è¿”å› falseã€‚  
ä¸ºä»€ä¹ˆ `Double` ç±»ä¸­çš„ `valueOf()` æ–¹æ³•ä¼šé‡‡ç”¨ä¸ `Integer` ç±»ä¸­çš„ `valueOf()` æ–¹æ³•ä¸åŒçš„å®ç°å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œåœ¨æŸä¸ªèŒƒå›´å†…çš„æ•´æ•°å‹æ•°å€¼çš„ä¸ªæ•°æ˜¯æœ‰é™çš„ï¼Œè€Œæµ®ç‚¹æ•°å´ä¸æ˜¯ã€‚  
æŸ¥çœ‹äº†ä¸€ä¸‹å…¶ä»–å‡ ç§æ•°æ®ç±»å‹çš„ `valueOf()` æºç ï¼Œå…¶ä¸­ï¼Œ`Double` å’Œ `Float` æ²¡æœ‰ç¼“å­˜æœºåˆ¶ï¼Œéƒ½æ˜¯ç›´æ¥è¿”å›æ–°çš„å¯¹è±¡ï¼›`Integer`ã€`Short`ã€`Byte`ã€`Character` éƒ½æœ‰ç¼“å­˜æœºåˆ¶ã€‚  è‡³äº `Boolean` ç±»å‹ï¼Œå®ƒçš„ `valueOf()` æ–¹æ³•å¦‚ä¸‹ï¼š

```java
public static Boolean valueOf(boolean b) {  
    return (b ? TRUE : FALSE);  
}
```

å…¶ä¸­çš„ `TRUE` å’Œ `FALSE`ï¼Œä»£è¡¨ä¸¤ä¸ªé™æ€æˆå‘˜å±æ€§ã€‚

```java
/**
 * The {@code Boolean} object corresponding to the primitive
 * value {@code true}.
 */
public static final Boolean TRUE = new Boolean(true);

/**
 * The {@code Boolean} object corresponding to the primitive
 * value {@code false}.
 */
public static final Boolean FALSE = new Boolean(false);
```

èªæ˜çš„å°ä¼™ä¼´è‚¯å®šå·²ç»çŸ¥é“ï¼Œç”¨ == æ¯”è¾ƒä¸¤ä¸ª `Boolean` ç±»å‹çš„å¯¹è±¡æ—¶ï¼Œåªè¦å€¼ç›¸ç­‰ï¼Œé‚£ä¹ˆè¿”å›çš„ç»“æœå°±æ˜¯ trueï¼›å€¼å¦‚æœä¸ç›¸ç­‰çš„è¯ï¼Œè¿”å›çš„ç»“æœå°±æ˜¯ falseã€‚

## é‡å†™ equals() æ–¹æ³•ä¸ºä»€ä¹ˆå¿…é¡»é‡å†™ hashCode() æ–¹æ³•ï¼Ÿ

### equals() æ–¹æ³•

`Object` ç±»ä¸­çš„ `equals()` æ–¹æ³•çš„æºç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public boolean equals(Object obj) {
    return (this == obj);
}
```

ä»ä»¥ä¸Šæºç ä¸­å¯ä»¥å¾—çŸ¥ï¼Œå¦‚æœä¸€ä¸ªç±»æœªé‡å†™ `equals()` æ–¹æ³•ï¼Œé‚£ä¹ˆæœ¬è´¨ä¸Šä¸ `==` æ¯”è¾ƒçš„æ•ˆæœä¸€æ ·ï¼Œæ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€æ˜¯å¦ç›¸åŒã€‚å¦‚æœé‡å†™äº† `equals()` æ–¹æ³•çš„è¯ï¼Œåˆ™æŒ‰ç…§å…¶éœ€è¦è¿›è¡Œæ¯”è¾ƒï¼Œæ¯”å¦‚åœ¨ `Integer` ä¸­é‡å†™äº† `equals()` æ–¹æ³•ï¼Œæ¯”è¾ƒçš„å°±ä¸å†æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€æ˜¯å¦ç›¸ç­‰ï¼Œè€Œæ˜¯æ¯”è¾ƒçš„ä¸¤ä¸ª `Integer` å¯¹è±¡çš„å€¼æ˜¯å¦ç›¸ç­‰ã€‚

Java è¯­è¨€è§„èŒƒè¦æ±‚ `equals()` æ–¹æ³•å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

- è‡ªåæ€§ï¼šå¯¹äºä»»ä½•éç©ºå¼•ç”¨å€¼ `x`ï¼Œ`x.equals(x)` åº”è¿”å› trueã€‚
- å¯¹ç§°æ€§ï¼šå¯¹äºä»»ä½•éç©ºå¼•ç”¨å€¼ `x` å’Œ `y`ï¼Œå½“ä¸”ä»…å½“ `x.equals(y)` æ˜¯ true æ—¶ï¼Œ`y.equals(x)` ä¹Ÿæ˜¯ trueã€‚
- ä¼ é€’æ€§ï¼šå¯¹äºä»»ä½•éç©ºå¼•ç”¨å€¼ `x` å’Œ `y` å’Œ `z`ï¼Œå¦‚æœ `x.equals(y)` æ˜¯ trueï¼ŒåŒæ—¶ `y.equals(z)` ä¹Ÿæ˜¯ trueï¼Œé‚£ä¹ˆ `x.equals(z)` ä¹Ÿæ˜¯ trueã€‚
- ä¸€è‡´æ€§ï¼šå¯¹äºä»»ä½•éç©ºçš„å¼•ç”¨å€¼ `x` å’Œ `y` ï¼Œå¦‚æœç”¨äº `equals()` æ–¹æ³•æ¯”è¾ƒçš„å¯¹è±¡ä¿¡æ¯æ²¡æœ‰è¢«ä¿®æ”¹çš„è¯ï¼Œå¤šæ¬¡è°ƒç”¨ `x.equals(y)` ä¸€è‡´è¿”å› true æˆ–è€… falseã€‚
- å¯¹äºä»»ä½•éç©ºå¼•ç”¨å€¼ `x` çš„ `x.equals(null)` åº”è¿”å› falseã€‚

åœ¨ `equals()` æ–¹æ³•ä¸Šæœ‰è¿™æ ·ä¸€æ®µæ³¨é‡Šï¼š

> It is generally necessary to override the hashCode method whenever this method is overridden, so as to maintain the general contract for the hashCode method, which states that equal objects must have equal hash codes.

å¤§è‡´æ„æ€å°±æ˜¯ï¼Œé‡å†™ `equals()` æ–¹æ³•çš„æ—¶å€™éœ€è¦é‡å†™ `hashCode()` æ–¹æ³•ï¼Œè¿™æ ·åšæ‰èƒ½ä¸è¿èƒŒ `hashCode()` ä¸­â€œ**ç›¸åŒå¯¹è±¡å¿…é¡»æœ‰ç›¸åŒå“ˆå¸Œå€¼**â€çš„çº¦å®šã€‚

### hashCode() æ–¹æ³•

`Object` ç±»ä¸­çš„ `hashCode()` æ–¹æ³•çš„æºç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public native int hashCode();
```

è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯è¿”å›ä¸€ä¸ª `int` ç±»å‹çš„å“ˆå¸Œç ï¼Œä¹Ÿæˆä¸ºæ•£åˆ—ç ã€‚è¿™ä¸ªå€¼ä¸ºä»»æ„æ•´æ•°ï¼Œå¯èƒ½æ˜¯æ­£æ•°ä¹Ÿå¯èƒ½æ˜¯è´Ÿæ•°ã€‚

#### hashCode() æ–¹æ³•çš„çº¦å®š

å…³äº `hashCode()` æ–¹æ³•çš„çº¦å®šå¤§è‡´æœ‰ä»¥ä¸‹ä¸‰æ¡ï¼š

1. å¦‚æœç”¨äº `equals()` æ–¹æ³•æ¯”è¾ƒçš„å¯¹è±¡ä¿¡æ¯æ²¡æœ‰è¢«ä¿®æ”¹çš„è¯ï¼Œé‚£ä¹ˆåœ¨åŒä¸€å¯¹è±¡ä¸Šå¤šæ¬¡è°ƒç”¨ `hashCode()` æ–¹æ³•è¿”å›çš„å“ˆå¸Œå€¼å¿…é¡»ç›¸åŒã€‚
2. **å¦‚æœä¸¤ä¸ªå¯¹è±¡é€šè¿‡ `equals()` æ–¹æ³•æ¯”è¾ƒæ˜¯ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆè¦æ±‚è¿™ä¸¤ä¸ªå¯¹è±¡è°ƒç”¨ `hashCode()` æ–¹æ³•è¿”å›çš„å“ˆå¸Œå€¼ä¹Ÿå¿…é¡»ç›¸ç­‰**ã€‚å› æ­¤å¯ä»¥æ¨å¯¼å‡ºï¼Œ**å½“ä¸¤ä¸ªå¯¹è±¡è°ƒç”¨ `hashCode()` æ–¹æ³•è¿”å›çš„å“ˆå¸Œå€¼ä¸ç›¸ç­‰æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå¯¹è±¡é€šè¿‡ `equals()` æ–¹æ³•æ¯”è¾ƒä¹Ÿæ˜¯ä¸ç›¸ç­‰çš„**ã€‚
3. å¦‚æœä¸¤ä¸ªå¯¹è±¡é€šè¿‡ `equals()` æ¯”è¾ƒä¸ç›¸ç­‰ï¼Œ**ä¸è¦æ±‚** è¿™ä¸¤ä¸ªå¯¹è±¡è°ƒç”¨ `hashCode()` æ–¹æ³•è¿”å›çš„å“ˆå¸Œå€¼å¿…é¡»ä¸ç›¸ç­‰ã€‚ä½†æ˜¯å’±ä»¬åº”è¯¥çŸ¥é“ï¼Œå¯¹äºä¸åŒå¯¹è±¡ç”Ÿæˆä¸åŒçš„å“ˆå¸Œå€¼å¯èƒ½ä¼šæé«˜å“ˆå¸Œè¡¨çš„æ€§èƒ½ã€‚

#### hashCode() æ–¹æ³•çš„åº”ç”¨åœºæ™¯

`HashSet` é›†åˆè¦æ±‚æ·»åŠ çš„å…ƒç´ ä¸èƒ½é‡å¤ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä½¿ç”¨è¿­ä»£çš„æ–¹å¼ï¼Œä¾æ¬¡å¯¹æ¯ä¸ªå…ƒç´ ä½¿ç”¨ `equals()` æ–¹æ³•æ¯”å¯¹ä¸¤ä¸ªå…ƒç´ æ˜¯å¦ç›¸ç­‰çš„è¯ï¼Œæ•°æ®é‡å°çš„è¯è¿˜å¯ä»¥æ¥å—ï¼Œä½†æ˜¯åœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™æ•ˆç‡æ˜¾ç„¶æ˜¯éå¸¸ä½çš„ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå…ˆä½¿ç”¨ `HashCode()` æ–¹æ³•è¿”å›çš„å“ˆå¸Œå€¼è¿›è¡Œåˆ¤æ–­ï¼Œç›¸ç­‰çš„è¯å†ä½¿ç”¨ `equals()` æ–¹æ³•æ¥åšè¿›ä¸€æ­¥åˆ¤æ–­ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘è°ƒç”¨ `equals()` æ–¹æ³•çš„æ¬¡æ•°ã€‚

`HashSet` åº•å±‚ä½¿ç”¨çš„å…¶å®æ˜¯ `HashMap`ï¼Œç»´æŠ¤äº†ä¸€ä¸ª `HashMap` ç±»å‹çš„å±æ€§ï¼Œæ·»åŠ å…ƒç´ éƒ½æ˜¯å­˜æ”¾åœ¨è¯¥ `HashMap` ä¸­ã€‚

```java
public class HashSet<E>
    extends AbstractSet<E>
    implements Set<E>, Cloneable, java.io.Serializable
{
    private transient HashMap<E,Object> map;
    
    // Dummy value to associate with an Object in the backing Map
    private static final Object PRESENT = new Object();

    public boolean add(E e) {
        return map.put(e, PRESENT)==null;
    }
}
```

ç†Ÿæ‚‰ `HashMap` çš„å°ä¼™ä¼´å¯èƒ½çŸ¥é“ï¼Œåœ¨ `HashMap` æ·»åŠ çš„å…ƒç´ çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šé€šè¿‡ä¸€ä¸ª `hash()` æ‰°åŠ¨å‡½æ•° `(key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16)` è·å–ä¸€ä¸ª `hash` å€¼ï¼Œå…¶ä¸­åˆ©ç”¨çš„å°±æ˜¯å¯¹è±¡ `hashCode()` æ–¹æ³•è¿”å›çš„å“ˆå¸Œå€¼ï¼Œå†é€šè¿‡æ‰°åŠ¨å‡½æ•°è¿”å›çš„ `hash` å€¼å»å®šä½å…ƒç´ åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ä¸‹æ ‡ä½ç½® `i = (n - 1) & hash`ã€‚å¦‚æœç´¢å¼•ä¸‹æ ‡ä½ç½®å·²ç»å­˜åœ¨å…ƒç´ ï¼Œåˆ™è¯´æ˜ä¸¤ä¸ªå¯¹è±¡çš„å“ˆå¸Œå€¼ç›¸ç­‰ï¼Œè¿™æ—¶æ‰ä¼šè°ƒç”¨ `equals()` æ–¹æ³•æ¥è¿›ä¸€æ­¥åˆ¤æ–­ä¸¤ä¸ªå…ƒç´ æ˜¯å¦çœŸçš„ç›¸ç­‰ï¼Œå³æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœ `equals()` æ–¹æ³•æ¯”è¾ƒç›¸ç­‰ï¼Œåˆ™è¯´æ˜ä¸¤ä¸ªå…ƒç´ æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ–°å…ƒç´ çš„å€¼æ›¿æ¢æ‰å·²æœ‰å…ƒç´ çš„å€¼ï¼›å¦‚æœ `euqals()` æ–¹æ³•æ¯”è¾ƒä¸ç›¸ç­‰çš„è¯ï¼Œåˆ™è¯´æ˜ä¸¤ä¸ªå…ƒç´ å¹¶ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå°†æ–°å…ƒç´ æŒ‚åœ¨å·²æœ‰å…ƒç´ çš„åé¢å½¢æˆé“¾è¡¨ç»“æ„ã€‚å¦‚æœç´¢å¼•ä¸‹æ ‡ä½ç½®æ²¡æœ‰å…ƒç´ ï¼Œåˆ™è¯´æ˜æ–°å…ƒç´ çš„å“ˆå¸Œå€¼ä¸é›†åˆä¸­å…¶ä»–å…ƒç´ çš„å“ˆå¸Œå€¼éƒ½ä¸ç›¸ç­‰ï¼Œç›´æ¥æ·»åŠ å³å¯ã€‚

### é‡å†™ equals() æ–¹æ³•ä¸ºä»€ä¹ˆå¿…é¡»é‡å†™ hashCode() æ–¹æ³•ï¼Ÿ

ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ä¸ºä»€ä¹ˆé‡å†™ equals() æ–¹æ³•æ—¶å¿…é¡»é‡å†™ hashCode() æ–¹æ³•ã€‚

#### Set é›†åˆçš„â€œå¼‚å¸¸â€

å½“åªé‡å†™ `equals()` æ–¹æ³•æ—¶ï¼Œæœ‰è¶£çš„äº‹æƒ…å°±å‘ç”Ÿäº†ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š

```java
public class Test3 {
    private static final Logger LOGGER = LoggerFactory.getLogger(Test3.class);

    public static void main(String[] args) {
        Set<Person> s = new HashSet<>();
        s.add(new Person("xiaorang", 18));
        s.add(new Person("xiaorang", 18));
        s.forEach(System.out::println);
    }
}

@Data
@AllArgsConstructor
class Person {
    private String name;
    private Integer age;

    @Override
    public boolean equals(Object o) {
        if (this == o) {
            return true;
        }
        if (o == null || getClass() != o.getClass()) {
            return false;
        }
        Person person = (Person) o;
        return Objects.equals(name, person.name) && Objects.equals(age, person.age);
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
Person(name=xiaorang, age=18)
Person(name=xiaorang, age=18)
```

ä»ä¸Šè¿°ç»“æœçœ‹åˆ°ï¼Œå³ä½¿ä¸¤ä¸ªå¯¹è±¡æ˜¯ç›¸ç­‰çš„ï¼Œ`Set` é›†åˆå¹¶æ²¡æœ‰å»é‡ï¼Œé›†åˆä¸­å­˜åœ¨é‡å¤çš„å…ƒç´ ã€‚è¿™ä¹Ÿå°±æ˜¯åªé‡å†™ `equals()` æ–¹æ³•ä¸é‡å†™ `hashCode()` æ–¹æ³•çš„é—®é¢˜æ‰€åœ¨ã€‚

#### è§£å†³â€œå¼‚å¸¸â€

ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œåœ¨é‡å†™ `equals()` æ–¹æ³•çš„æ—¶å€™ä¹Ÿé‡å†™ `hashCode()` æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```java
@Data
@AllArgsConstructor
class Person {
    private String name;
    private Integer age;

    @Override
    public boolean equals(Object o) {
        if (this == o) {
            return true;
        }
        if (o == null || getClass() != o.getClass()) {
            return false;
        }
        Person person = (Person) o;
        return Objects.equals(name, person.name) && Objects.equals(age, person.age);
    }

    @Override
    public int hashCode() {
        return Objects.hash(name, age);
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
Person(name=xiaorang, age=18)
```

ä»ä¸Šè¿°ç»“æœçœ‹åˆ°ï¼Œä¸¤ä¸ªç›¸ç­‰çš„å¯¹è±¡æ·»åŠ åˆ° `Set` é›†åˆä¸­æ—¶åªä¼šä¿ç•™ä¸€æ¡è®°å½•ã€‚

#### åŸå› åˆ†æ

åœ¨ `HashSet` æ·»åŠ å…ƒç´ æ—¶é¦–å…ˆä¼šåˆ¤æ–­æ–°å…ƒç´ çš„å“ˆå¸Œå€¼æ˜¯å¦ä¸é›†åˆä¸­å·²æœ‰å…ƒç´ çš„å“ˆå¸Œå€¼æ˜¯å¦ç›¸ç­‰ï¼Œå“ˆå¸Œå€¼ç›¸ç­‰çš„è¯æ‰ä¼šè°ƒç”¨ `euqals()` æ–¹æ³•è¿›ä¸€æ­¥åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦çœŸçš„ç›¸ç­‰ã€‚å¦‚æœå¯¹è±¡åªé‡å†™äº† `equals()` æ–¹æ³•ï¼Œæ²¡æœ‰é‡å†™ `hashCode()` æ–¹æ³•çš„è¯ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨ `Object` ä¸­çš„ `hashCode()` æ–¹æ³•ï¼Œå…¶é»˜è®¤è¡Œä¸ºæ˜¯å¯¹å †ä¸Šçš„å¯¹è±¡äº§ç”Ÿç‹¬ç‰¹å€¼ï¼Œç›¸åŒç±»å‹çš„ä¸¤ä¸ªå¯¹è±¡æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šç›¸ç­‰ï¼Œæ‰€ä»¥ç»“æœä¸º falseï¼Œ`equals()` æ–¹æ³•ä¹Ÿå°±ä¸ä¼šè¢«è°ƒç”¨ï¼Œç›´æ¥æ·»åŠ å…ƒç´ åˆ°é›†åˆä¸­ï¼Œé‚£ä¹ˆæ­¤æ—¶ `HashSet` é›†åˆä¸­å°±ä¼šå‡ºç°ä¸¤ä¸ªç›¸ç­‰çš„å…ƒç´ ï¼Œè¿èƒŒäº† `HashSet` é›†åˆä¸èƒ½å­˜åœ¨ç›¸åŒå…ƒç´ çš„å‰ææ¡ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿä¸€äº›ä¸å¯é¢„çŸ¥çš„é”™è¯¯ã€‚ä½†æ˜¯å¦‚æœåœ¨é‡å†™ `equals()` æ–¹æ³•çš„æ—¶å€™ä¹Ÿé‡å†™äº† `hashCode()` æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨å“ˆå¸Œå€¼ç›¸ç­‰çš„æƒ…å†µä¸‹ä¼šè¿›ä¸€æ­¥è°ƒç”¨ `equals()` æ–¹æ³•åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦çœŸçš„ç›¸ç­‰ï¼Œä¹Ÿå°±ä¿è¯ `HashSet` é›†åˆä¸­ä¸ä¼šå­˜åœ¨é‡å¤çš„å…ƒç´ ã€‚

### æ€»ç»“

`hashCode()` å’Œ `equals()` ä¸¤ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥ååŒåˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰çš„ï¼Œé‡‡ç”¨è¿™ç§æ–¹å¼çš„åŸå› æ˜¯å¯ä»¥æé«˜æ’å…¥å’ŒæŸ¥è¯¢çš„é€Ÿåº¦ã€‚å¦‚æœåªé‡å†™ `equals()` æ–¹æ³•ï¼Œä¸é‡å†™ `hashCode()` æ–¹æ³•ï¼Œå°±ä¼šå¯¼è‡´åœ¨æŸäº›åœºæ™¯ä¸‹å‡ºç°å¼‚å¸¸ï¼Œå¦‚å¯¼è‡´ä¸¤ä¸ªç›¸ç­‰çš„å¯¹è±¡å­˜å‚¨åœ¨ `HashSet` é›†åˆä¸­ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯ç¨‹åºçš„æ­£å¸¸è¿è¡Œï¼Œåœ¨é‡å†™ `euqals()` æ–¹æ³•çš„æ—¶å€™ï¼Œå¿…é¡»é‡å†™ `hashCode()` æ–¹æ³•ã€‚

## String s = new String("abc") åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡ï¼Ÿ

ğŸ¤“ï¼šåˆ›å»ºäº† **ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå¯¹è±¡**ã€‚

> å‚è€ƒé“¾æ¥ï¼š[æµç¨‹å›¾è¯¦è§£ new String("abc") åˆ›å»ºäº†å‡ ä¸ªå­—ç¬¦ä¸²å¯¹è±¡](https://www.bilibili.com/video/BV1tL4y1F7UH/?spm_id_from=333.337.search-card.all.click&vd_source=bf3d4320498e90d36e1361cc18b45e48)

### æŸ¥çœ‹å­—èŠ‚ç 

#### javap å‘½ä»¤

```shell
javap -verbose Test2
```

è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š  

![image-20221123101334919](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061428539.png)  

#### jclassib Bytecode Viewer æ’ä»¶

IDEA å®‰è£… `jclassib Bytecode Viewer` æ’ä»¶ï¼Œä½¿ç”¨ `shift + shift` å¿«æ·é”®æœç´¢å…³é”®å­— `jclassib`ï¼Œæ‰“å¼€æ’ä»¶ç•Œé¢ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š  
![|1132](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061428765.png)  
åœ¨æ’ä»¶ç•Œé¢ä¸­æ‰¾åˆ°ä½ æ­¤æ—¶æ­£åœ¨è¿è¡Œçš„ç±»ä¸­å¯¹åº”çš„æ–¹æ³•å³å¯ã€‚  

![image-20221123101633333](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061428493.png)

### åˆ†æ

#### ä¸¤ä¸ªæ¦‚å¿µ

å¼•ç”¨å˜é‡å’Œå¯¹è±¡ï¼Œå¯¹è±¡ä¸€èˆ¬é€šè¿‡ `new` å…³é”®å­—åœ¨å †ä¸­åˆ›å»ºï¼Œ`s` åªæ˜¯ä¸€ä¸ªå¼•ç”¨å˜é‡ã€‚

#### å­—ç¬¦ä¸²å¸¸é‡æ± 

`JVM` ä¸ºäº†æå‡æ€§èƒ½å’Œå‡å°‘å†…å­˜å¼€é”€ï¼Œé¿å…å­—ç¬¦çš„é‡å¤åˆ›å»ºï¼Œå…¶ç»´æŠ¤äº†ä¸€å—ç‰¹æ®Šçš„å†…å­˜ç©ºé—´ï¼Œå³å­—ç¬¦ä¸²å¸¸é‡æ± ã€‚å½“éœ€è¦ä½¿ç”¨å­—ç¬¦ä¸²æ—¶ï¼Œå…ˆå»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥çœ‹è¯¥å­—ç¬¦ä¸²æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆå§‹åŒ–ä¹‹åå°†è¯¥å­—ç¬¦ä¸²æ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚

å­—ç¬¦ä¸²å¸¸é‡æ± çš„ä½ç½®ä¹Ÿæ˜¯éšç€ `JDK` ç‰ˆæœ¬çš„ä¸åŒè€Œä½ç½®ä¸åŒã€‚åœ¨ `JDK6` ä¸­ï¼Œå¸¸é‡æ± çš„ä½ç½®åœ¨æ°¸ä¹…ä»£ï¼ˆæ–¹æ³•åŒºï¼‰ä¸­ï¼Œæ­¤æ—¶å¸¸é‡æ± ä¸­å­˜å‚¨çš„æ˜¯ **å¯¹è±¡**ã€‚åœ¨ `JDK7` ä¸­ï¼Œå¸¸é‡æ± çš„ä½ç½®åœ¨å †ä¸­ï¼Œæ­¤æ—¶ï¼Œå¸¸é‡æ± ä¸­å­˜å‚¨çš„å°±æ˜¯ **å¼•ç”¨**ã€‚åœ¨ `JDK8` ä¸­ï¼Œæ°¸ä¹…ä»£è¢«å…ƒç©ºé—´æ‰€å–ä»£ã€‚

#### intern() æ–¹æ³•

`intern()` æ–¹æ³•çš„ä½œç”¨æ˜¯å°†å¯¹åº”çš„å­—ç¬¦ä¸²å¸¸é‡è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œåœ¨ `JDK6` ä¹‹å‰å’Œ `JDK7` ä¹‹åæœ‰ä¸åŒçš„å¤„ç†ï¼š

- åœ¨ `JDK6` ä¸­ï¼Œ`intern()` æ–¹æ³•çš„å¤„ç†æ˜¯å…ˆåˆ¤æ–­å­—ç¬¦ä¸²å¸¸é‡æ˜¯å¦å­˜åœ¨äºå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥å¸¸é‡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å°†è¯¥å­—ç¬¦ä¸²å¸¸é‡åŠ å…¥åˆ°è¯¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå³åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å»ºç«‹è¯¥å­—ç¬¦ä¸²å¸¸é‡ã€‚
- åœ¨ `JDK7` ä¸­ï¼Œ`intern()` æ–¹æ³•çš„å¤„ç†æ˜¯å…ˆåˆ¤æ–­å­—ç¬¦ä¸²å¸¸é‡æ˜¯å¦å­˜åœ¨äºå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›å­—ç¬¦ä¸²å¸¸é‡åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¼•ç”¨ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œè¯´æ˜è¯¥å­—ç¬¦ä¸²å¸¸é‡åªå­˜äºå †ä¸­ï¼Œåˆ™å¤„ç†æ˜¯æŠŠå †ä¸­è¯¥å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œä»¥ååˆ«äººæ‹¿åˆ°çš„å°±æ˜¯è¯¥å­—ç¬¦ä¸²å¸¸é‡çš„å¼•ç”¨ï¼Œå®é™…ä¸Šå¯¹è±¡è¿˜æ˜¯å­˜åœ¨äºå †ä¸­çš„ã€‚

#### ä¸ºä»€ä¹ˆè¯´åˆ›å»ºäº†ä¸€ä¸ªæˆ–ä¸¤ä¸ªå¯¹è±¡ï¼Ÿ

`String s = new String("abc")` ä¼šåœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªå­˜å‚¨ "abc" çš„å­—ç¬¦ä¸²å¯¹è±¡ (StringObject)ï¼Œç„¶åå°†å…¶å¼•ç”¨èµ‹å€¼ç»™å˜é‡ `s` ä¿å­˜ã€‚åœ¨æ„é€ æ–¹æ³•ä¸­ä¼ é€’äº†ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ "abc"ï¼Œåœ¨é¦–æ¬¡æ„å»ºè¿™ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œ`JVM` ä¼šå…ˆæ£€ç´¢å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯å¦å­˜åœ¨ "abc"ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›å…¶å¯¹åº”çš„å¯¹è±¡å¼•ç”¨ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ª "abc" å¯¹è±¡ï¼Œå¹¶å°†å…¶å¼•ç”¨ä¿å­˜åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œç„¶åè¿”å›ã€‚æ‰€ä»¥ç­”æ¡ˆä¸ºåˆ›å»ºä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå¯¹è±¡ã€‚

### å‡çº§åŠ ç 

ä»¥ä¸‹å®ä¾‹å’±ä»¬æš‚ä¸”ä¸è€ƒè™‘å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”å­—ç¬¦ä¸²çš„é—®é¢˜ï¼Œå‡è®¾éƒ½ä¸å­˜åœ¨å¯¹åº”çš„å­—ç¬¦ä¸²ã€‚

è¯·é—®ä»¥ä¸‹ä»£ç ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿ

```java
String s1 = "abc" + "def";
```

å½“ä¸€ä¸ªå­—ç¬¦ä¸²ç”±å¤šä¸ªå­—ç¬¦ä¸²å¸¸é‡æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œå®ƒè‡ªå·±ä¹Ÿè‚¯å®šæ˜¯å­—ç¬¦ä¸²å¸¸é‡ã€‚å­—ç¬¦ä¸²å¸¸é‡çš„ "+" å·è¿æ¥ï¼Œ`JVM` ä¼šåœ¨ç¨‹åºç¼–è¯‘æœŸå°†å…¶ä¼˜åŒ–ä¸ºè¿æ¥åçš„å€¼ã€‚å°±ä¸Šé¢çš„ç¤ºä¾‹è€Œè¨€ï¼Œåœ¨ç¼–è¯‘æ—¶å·²ç»è¢«åˆå¹¶æˆäº† "abcdef" å­—ç¬¦ä¸²ï¼Œå› æ­¤ï¼Œåªä¼šåˆ›å»º **ä¸€ä¸ªå¯¹è±¡**ã€‚å¹¶æ²¡æœ‰åˆ›å»ºä¸´æ—¶å­—ç¬¦ä¸²å¯¹è±¡ "abc" å’Œ "def"ï¼Œè¿™æ ·å‡è½»äº† `GC` çš„å‹åŠ›ã€‚

é€šè¿‡å­—èŠ‚ç ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡æŒ‡ä»¤ `ldc` ä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è·å– "abcdef" å­—ç¬¦ä¸²ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20221123115039204](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061428826.png)

é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œå’±ä»¬å†æ¬¡å‡çº§ä¸€ä¸‹ï¼Œä¸‹é¢çš„ä»£ç ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿ

```java
String s2 = new String("abc") + new String("def");
```

![image-20221123121358288](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061428744.png)

ä»ä¸Šé¢çš„å­—èŠ‚ç ä¸éš¾å‘ç°ï¼Œåˆ›å»ºäº†ä¸€ä¸ª `StringBuilder` å¯¹è±¡ï¼Œä¸€ä¸ª `new String("abc")` å¯¹è±¡ï¼Œç„¶åç”¨æŒ‡ä»¤ `ldc` ä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è·å– "abc" å­—ç¬¦ä¸²ï¼Œæ¥ç€åˆ›å»ºäº†ä¸€ä¸ª `new String("def")` å¯¹è±¡ï¼Œç„¶åæ¥ç€ç”¨æŒ‡ä»¤ `ldc` ä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è·å– "def" å­—ç¬¦ä¸²ï¼Œæœ€åè°ƒç”¨ `StringBuilder` ä¸­çš„ `toString()` æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¯¹è±¡è¿”å›ã€‚æ‰€ä»¥è¿™ä¸€è¡Œä»£ç æ€»å…±åˆ›å»ºäº† **6 ä¸ªå¯¹è±¡**ã€‚

æŸ¥çœ‹ `StringBuilder` ä¸­çš„ `toString()` æ–¹æ³•ï¼š

```java
@Override
public String toString() {
    // Create a copy, don't share the array
    return new String(value, 0, count);
}
```

æ­¤å¤„è™½ç„¶ä½¿ç”¨ `new` å…³é”®å­—åˆ›å»ºäº†ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œä½†æ˜¯å¹¶ä¸ä¼šå°† "abcdef" å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨å­˜æ”¾åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œå˜é‡ `s2` å…¶å®æŒ‡å‘çš„æ˜¯ `new String("abcdef")` åœ¨å †ç©ºé—´ä¸­çš„å¼•ç”¨åœ°å€ã€‚ä¸ä¿¡å’±ä»¬å¯ä»¥éªŒè¯ä¸€ä¸‹ï¼Œå°†ä»£ç å˜æˆå¦‚ä¸‹å½¢å¼ï¼š

```java
String s2 = new String("abc") + new String("def");
String s3 = "abcdef";
LOGGER.debug("s2 == s3ï¼Ÿ{}", s2 == s3);
```

å¦‚æœè¯´è¾“å‡ºç»“æœä¸º `true`ï¼Œåˆ™è¯´æ˜ä¼šå°† "abcdef" å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨å­˜æ”¾åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œåœ¨åˆ›å»ºå­—ç¬¦ä¸² `s3` çš„æ—¶å€™ç›´æ¥å°±ä¼šä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è·å–ï¼Œè€Œä¸ç”¨é‡æ–°åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå³ `s2` å’Œ `s3` æŒ‡å‘çš„éƒ½æ˜¯å †ä¸­çš„åŒä¸€ä¸ªå¯¹è±¡ã€‚åä¹‹ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè‡ªç„¶ `s2` çš„å¼•ç”¨åœ°å€ä¹Ÿå°±ä¸ä¼šç­‰äº `s3` çš„å¼•ç”¨åœ°å€ã€‚è¿è¡Œä¸€ä¸‹ä»£ç ï¼Œå¯çŸ¥ï¼Œè¾“å‡ºç»“æœä¸º `false`ï¼Œè¯´æ˜å¹¶ä¸ä¼šå°† "abcdef" å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨å­˜æ”¾åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚

é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•è®© `s2` å’Œ `s3` æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡å‘¢ï¼ŸåŠæ³•æ˜¯æœ‰çš„ï¼Œè¿˜è®°å¾—å’±ä»¬ä¸Šé¢æåˆ°çš„ `intern()` æ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨ `s2.intern()` æ–¹æ³•å°† `s2` çš„å¼•ç”¨åœ°å€ä¿å­˜åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œä¹‹ååœ¨åˆ›å»ºå­—ç¬¦ä¸² `s3` çš„æ—¶å€™ï¼Œå‘ç°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨ "abcdef"ï¼Œåˆ™ä¸ä¼šå†åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨è¯¥å¼•ç”¨ï¼Œå³ `s2` å’Œ `s3` ä¼šæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œ`s2 == s3` çš„è¾“å‡ºç»“æœä¹Ÿå°±ä¼šå˜æˆ `true`ã€‚

## ä¸ºä»€ä¹ˆ String æ˜¯ä¸å¯å˜ç±»ï¼Ÿä»¥åŠä¸ºä»€ä¹ˆè®¾è®¡æˆä¸å¯å˜ç±»ï¼Ÿ

### ä»€ä¹ˆæ˜¯ä¸å¯å˜ç±»ï¼Ÿ

ä¸€ä¸ªç±»çš„å¯¹è±¡åœ¨é€šè¿‡æ„é€ æ–¹æ³•åˆ›å»ºä¹‹åå¦‚æœçŠ¶æ€ä¸ä¼šå†è¢«æ”¹å˜ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªä¸å¯å˜ï¼ˆimmutableï¼‰ç±»ã€‚å®ƒçš„æ‰€æœ‰æˆå‘˜å˜é‡çš„èµ‹å€¼ä»…åœ¨æ„é€ æ–¹æ³•ä¸­å®Œæˆï¼Œä¸ä¼šæä¾›ä»»ä½• `setter()` æ–¹æ³•ä¾›å¤–éƒ¨ç±»å»ä¿®æ”¹ã€‚

è‡ªä»æœ‰äº†å¤šçº¿ç¨‹ï¼Œç”Ÿäº§åŠ›å°±è¢«æ— é™æ”¾å¤§äº†ï¼Œæ‰€æœ‰çš„ç¨‹åºå‘˜éƒ½çˆ±å®ƒï¼Œå› ä¸ºå¼ºå¤§çš„ç¡¬ä»¶èƒ½åŠ›è¢«å……åˆ†åœ°åˆ©ç”¨äº†ã€‚ä½†ä¸æ­¤åŒæ—¶ï¼Œæ‰€æœ‰çš„ç¨‹åºå‘˜éƒ½å¯¹å®ƒå¿ƒç”Ÿå¿Œæƒ®ï¼Œå› ä¸ºä¸€ä¸å°å¿ƒï¼Œå¤šçº¿ç¨‹å°±ä¼šæŠŠå¯¹è±¡çš„çŠ¶æ€å˜å¾—æ··ä¹±ä¸å ªã€‚

ä¸ºäº†ä¿è¯çŠ¶æ€çš„åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§ï¼Œç¨‹åºå‘˜å¯ä»¥è¯´æ˜¯ç«­å°½æ‰€èƒ½ã€‚å…¶ä¸­ï¼Œ`synchronized`ï¼ˆåŒæ­¥ï¼‰å…³é”®å­—æ˜¯æœ€ç®€å•æœ€å…¥é—¨çš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚

å‡å¦‚è¯´ç±»æ˜¯ä¸å¯å˜çš„ï¼Œé‚£ä¹ˆå¯¹è±¡çš„çŠ¶æ€ä¹Ÿå°±æ˜¯ä¸å¯å˜çš„ã€‚è¿™æ ·çš„è¯ï¼Œæ¯æ¬¡ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„å¯¹è±¡ä¾›ä¸åŒçš„çº¿ç¨‹ä½¿ç”¨ï¼Œç¨‹åºå‘˜å°±ä¸å¿…å†æ‹…å¿ƒå¹¶å‘é—®é¢˜äº†ã€‚

```java
public void testFinal() {
    String str = "abc";
    str = "def";
}
```

![image-20221124060547175](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061428477.png)

### String ä¸ºä»€ä¹ˆä¸å¯å˜ï¼Ÿ

1. `String` ç±»ä¸­çš„ `value` å±æ€§æ˜¯ä¸€ä¸ª `char` ç±»å‹çš„æ•°ç»„ï¼Œè¢« `final` ä¿®é¥°ï¼Œä¿è¯è¯¥æ•°ç»„ä¸€æ—¦è¢«åˆå§‹åŒ–ä¹‹åï¼Œå°±ä¸èƒ½å†æ”¹å˜å…¶å¼•ç”¨äº†ã€‚
2. æˆå‘˜å˜é‡çš„è®¿é—®æƒé™ä¸º `private`ï¼ŒåŒæ—¶æ²¡æœ‰æä¾›æ–¹æ³•å°†å­—æ®µæš´éœ²å‡ºæ¥ã€‚
3. `String` ç±»ä¸­çš„æ–¹æ³•ä¸ä¼šå»æ”¹åŠ¨ `value` å±æ€§çš„å€¼ï¼Œéœ€è¦çš„è¯éƒ½æ˜¯ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ `String` å¯¹è±¡å¹¶è¿”å›ã€‚
4. `String` ç±»è¢« `final` ä¿®é¥°ï¼Œè¡¨ç¤ºè¯¥ç±»ä¸å¯è¢«ç»§æ‰¿ã€‚

### String ä¸ºä»€ä¹ˆè¢«è®¾è®¡æˆä¸å¯å˜ç±»ï¼Ÿ

> å‚è€ƒé“¾æ¥ï¼š[Why String is immutable in Java? (programcreek.com)](https://www.programcreek.com/2013/04/why-string-is-immutable-in-java/)

1. å­—ç¬¦ä¸²å¸¸é‡æ± çš„éœ€è¦ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯ Java å †å†…å­˜ä¸­ä¸€ä¸ªç‰¹æ®Šçš„å­˜å‚¨åŒºåŸŸï¼Œå½“åˆ›å»ºä¸€ä¸ª `String` å¯¹è±¡æ—¶ï¼Œå¦‚æœè¯¥å­—ç¬¦ä¸²å·²ç»å­˜åœ¨äºæ± ä¸­ï¼Œå°†è¿”å›ç°æœ‰å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè¿™æ ·çš„è¯å¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´ï¼Œæé«˜æ•ˆç‡ã€‚

   ![](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061428093.jpeg)

2. hashCode çš„éœ€è¦ï¼šå› ä¸ºå­—ç¬¦ä¸²æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€ä»¥åœ¨å®ƒç¬¬ä¸€æ¬¡è°ƒç”¨ `hashCode()` æ–¹æ³•çš„æ—¶å€™ï¼Œå…¶ `hash` å€¼å°±å·²ç»è¢«ç¼“å­˜äº†ï¼Œå› æ­¤éå¸¸é€‚åˆä½œä¸ºå“ˆå¸Œå€¼ï¼ˆæ¯”å¦‚è¯´ä½œä¸º `HashMap` çš„é”®ï¼‰ï¼Œå¤šæ¬¡è°ƒç”¨è¿”å›çš„æ˜¯åŒä¸€ä¸ªå€¼ï¼Œæ¥æé«˜æ•ˆç‡ã€‚

   ```java
   public int hashCode() {
       int h = hash;
       if (h == 0 && !hashIsZero) {
           h = isLatin1() ? StringLatin1.hashCode(value)
               : StringUTF16.hashCode(value);
           if (h == 0) {
               hashIsZero = true;
           } else {
               hash = h;
           }
       }
       return h;
   }
   ```

3. `String` ç»å¸¸ä½œä¸ºå‚æ•°ï¼Œ`String` ä¸å¯å˜æ€§å¯ä»¥ä¿è¯å‚æ•°ä¸å¯å˜ã€‚ä¾‹å¦‚åœ¨ä½œä¸ºç½‘ç»œè¿æ¥å‚æ•°çš„æƒ…å†µä¸‹å¦‚æœ `String` æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆåœ¨ç½‘ç»œè¿æ¥è¿‡ç¨‹ä¸­ï¼Œ`String` è¢«æ”¹å˜ï¼Œæ”¹å˜ `String` å¯¹è±¡çš„é‚£ä¸€æ–¹ä»¥ä¸ºç°åœ¨è¿æ¥çš„æ˜¯å…¶å®ƒä¸»æœºï¼Œè€Œå®é™…æƒ…å†µå´ä¸ä¸€å®šæ˜¯ã€‚

   ```java
   boolean connect(string s){
       if (!isSecure(s)) { 
       	throw new SecurityException(); 
   	}
       //here will cause problem, if s is changed before this by using other references.    
       causeProblem(s);
   }
   ```

4. çº¿ç¨‹å®‰å…¨ï¼šå› ä¸ºä¸å¯å˜çš„å¯¹è±¡ä¸èƒ½è¢«æ”¹å˜ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´è‡ªç”±å…±äº«ã€‚

## å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªä¸å¯å˜ç±»ï¼Ÿ

è¦è‡ªå®šä¹‰ä¸ªä¸å¯å˜ç±»ï¼Œéœ€è¦éµå¾ªä»¥ä¸‹ 4 ä¸ªåŸåˆ™:

1. ç¡®ä¿ç±»è¢« `final` æ‰€ä¿®é¥°ï¼Œä¸å…è®¸è¢«å…¶ä»–ç±»ç»§æ‰¿ã€‚
2. ç¡®ä¿ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜å˜é‡æ˜¯ `final` çš„ã€‚
3. ä¸è¦å¯¹å¤–æä¾›æ–¹æ³•å»ä¿®æ”¹æˆå‘˜å˜é‡ï¼ˆå¦‚ `setter()` æ–¹æ³•ï¼‰
4. ä¸å¯å˜å¯¹è±¡çš„çŠ¶æ€åœ¨åˆ›å»ºä¹‹åå°±ä¸èƒ½åœ¨æ”¹å˜ï¼Œä»»ä½•å¯¹å®ƒçš„æ”¹å˜éƒ½åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚å¦‚æœ **ç±»ä¸­åŒ…å«å¯å˜ç±»å¯¹è±¡æ—¶**ï¼Œä½ åªéœ€è°¨æ…ä¸€ç‚¹ï¼Œ**ä¸è¦å…±äº«å¯å˜å¯¹è±¡çš„å¼•ç”¨** å³å¯ï¼Œå¦‚æœéœ€è¦å˜åŒ–æ—¶ï¼Œå°± **è¿”å›åŸå¯¹è±¡çš„ä¸€ä¸ªæ‹·è´**ï¼Œåˆ«æ˜¯å¯¹è±¡æœ¬èº«ã€‚

## Stringï¼ŒStringBufferï¼ŒStringBuilder çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- å¯å˜æ€§
  - `String` æ˜¯ä¸€ä¸ªä¸å¯å˜ç±»ï¼Œå†…éƒ¨çš„ `value` å±æ€§è¢« final ä¿®é¥°ã€‚å› æ­¤ï¼Œæ¯æ¬¡å¯¹ `String` çš„æ“ä½œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚
  - `StringBuffer` å’Œ `StringBuiler` æ˜¯å¯å˜ç±»ï¼Œå®ƒä»¬åœ¨å­—ç¬¦ä¸²å˜æ›´çš„æ—¶å€™ï¼Œä¸ä¼šäº§ç”Ÿæ–°çš„å¯¹è±¡ã€‚
- çº¿ç¨‹å®‰å…¨ï¼š
  - `String` æ˜¯ä¸å¯å˜ç±»ï¼Œæ‰€ä»¥å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
  - `StringBuffer` æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒçš„æ¯ä¸ªæ“ä½œæ–¹æ³•éƒ½åŠ äº† `synchronzied` åŒæ­¥å…³é”®å­—ã€‚
  - `StringBuilder` ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
- æ€§èƒ½ï¼š
  - `String` çš„æ€§èƒ½æ˜¯æœ€ä½çš„ï¼Œå› ä¸ºå®ƒæ˜¯ä¸å¯å˜ç±»ï¼Œæ„å‘³ç€åœ¨åšå­—ç¬¦ä¸²æ‹¼æ¥å’Œä¿®æ”¹çš„æ—¶å€™ï¼Œéœ€è¦åå¤åœ°é‡æ–°åˆ›å»ºæ–°çš„å¯¹è±¡å’Œåˆ†é…å†…å­˜ã€‚
  - å…¶æ¬¡æ˜¯ `StringBuffer`ï¼Œå®ƒè¦æ¯” `String` æ€§èƒ½é«˜ï¼Œå› ä¸ºå®ƒçš„å¯å˜æ€§ä½¿å¾—å­—ç¬¦ä¸²å¯ä»¥ç›´æ¥è¢«ä¿®æ”¹ã€‚
  - æ€§èƒ½æœ€é«˜çš„æ˜¯ `StringBuilder`ï¼Œå› ä¸º `StringBuffer` åŠ äº†åŒæ­¥é”ï¼Œè€Œ `StringBuilder` æ˜¯éé˜»å¡çš„ã€‚

æœ€åå†è¡¥å……ä¸€ä¸‹ï¼Œ`StringBuilder` å’Œ `StringBuffer` éƒ½ç»§æ‰¿è‡ª `AbstractStringBuilder` æŠ½è±¡ç±»ã€‚

## ä¸ºä»€ä¹ˆè¯´ Java ä¸­åªæœ‰å€¼ä¼ é€’ï¼Ÿ

å¼€å§‹ä¹‹å‰ï¼Œå’±ä»¬å…ˆæ¥ææ‡‚ä¸‹é¢è¿™ä¸¤ä¸ªæ¦‚å¿µï¼š

- å½¢å‚&å®å‚
- å€¼ä¼ é€’&å¼•ç”¨ä¼ é€’

###  å½¢å‚&å®å‚

æ–¹æ³•çš„å®šä¹‰å¯èƒ½ä¼šç”¨åˆ° **å‚æ•°**ï¼ˆæœ‰å‚çš„æ–¹æ³•ï¼‰ï¼Œå‚æ•°åœ¨ç¨‹åºè¯­è¨€ä¸­åˆ†ä¸ºï¼š

- **å®å‚**ï¼ˆå®é™…å‚æ•°ï¼ŒArgumentsï¼‰ï¼šåœ¨è°ƒç”¨æœ‰å‚æ–¹æ³•æ—¶ä¼ å…¥çš„å‚æ•°ï¼Œå¿…é¡»æœ‰ç¡®å®šçš„å€¼ã€‚
- **å½¢å‚**ï¼ˆå½¢å¼å‚æ•°ï¼ŒParametersï¼‰ï¼šç”¨äºå®šä¹‰æ–¹æ³•ï¼Œæ¥æ”¶å®å‚ï¼Œä¸éœ€è¦æœ‰ç¡®å®šçš„å€¼ã€‚

```java
public static void main(String[] args) {
    String hello = "Hello!";
    // helloä¸ºå®å‚
	sayHello(hello);
}

// strä¸ºå½¢å‚
public sayHello(String str) {
    System.out.println(str);
}
```

### å€¼ä¼ é€’&å¼•ç”¨ä¼ é€’

ç¨‹åºè®¾è®¡è¯­è¨€å°†å®å‚ä¼ é€’ç»™æ–¹æ³•çš„æ–¹å¼åˆ†ä¸ºä¸¤ç§ï¼š

- **å€¼ä¼ é€’**ï¼šæ–¹æ³•æ¥æ”¶çš„æ˜¯ **å®å‚å€¼çš„æ‹·è´**ï¼Œä¼šåˆ›å»ºå‰¯æœ¬ã€‚
- **å¼•ç”¨ä¼ é€’**ï¼šæ–¹æ³•æ¥æ”¶çš„æ˜¯ **å®å‚æ‰€å¼•ç”¨çš„å¯¹è±¡åœ¨å †ä¸­çš„åœ°å€**ï¼Œä¸ä¼šåˆ›å»ºå‰¯æœ¬ï¼Œ**å¯¹å½¢å‚çš„ä¿®æ”¹å°†å½±å“åˆ°å®å‚**ã€‚

å¾ˆå¤šè®¾è®¡è¯­è¨€ï¼ˆå¦‚ `C`ã€`C++`ï¼‰æä¾›äº†ä¸¤ç§å‚æ•°ä¼ é€’çš„æ–¹æ³•ï¼Œä¸è¿‡ï¼Œ**åœ¨ Java ä¸­åªæœ‰å€¼ä¼ é€’**ã€‚

### åŸºæœ¬ç±»å‹æ˜¯å€¼ä¼ é€’çš„

Java ä¸­çš„æ•°æ®ç±»å‹å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯åŸºæœ¬ç±»å‹ï¼Œä¸€ç§æ˜¯å¼•ç”¨ç±»å‹ã€‚æˆ‘ç›¸ä¿¡å°ä¼™ä¼´è¿˜æ²¡çœ‹åˆ°è¿™ä¹‹å‰ï¼Œå°±èƒ½å¤Ÿè¾¾æˆè¿™æ ·ä¸€ä¸ªå…±è¯†ï¼šåŸºæœ¬ç±»å‹æ˜¯å€¼ä¼ é€’çš„ã€‚è¿™ä¸€ç‚¹æ¯«æ— ç–‘é—®ã€‚

```java
public static void main(String[] args) {
    int num1 = 10;
    int num2 = 20;
    swap(num1, num2);
    System.out.println("num1 = " + num1);
    System.out.println("num2 = " + num2);
}

public static void swap(int a, int b) {
    int temp = a;
    a = b;
    b = temp;
    System.out.println("a = " + a);
    System.out.println("b = " + b);
}
```

è¾“å‡ºç»“æœä¸ºï¼š

```text
a = 20
b = 10
num1 = 10
num2 = 20
```

åœ¨ `swap()` æ–¹æ³•ä¸­ï¼Œå°† `a`ã€`b` çš„å€¼è¿›è¡Œäº¤æ¢ï¼Œå¹¶ä¸ä¼šå½±å“ `num1` å’Œ `num2`ã€‚å› ä¸ºï¼Œ`a` å’Œ `b` çš„å€¼åªæ˜¯ä» `num1` å’Œ `num2` æ‹·è´è¿‡æ¥çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`a` å’Œ `b` ç›¸å½“äº `num1` å’Œ `num2` çš„å‰¯æœ¬ï¼Œå‰¯æœ¬çš„å†…å®¹æ— è®ºæ€ä¹ˆä¿®æ”¹ï¼Œéƒ½ä¸ä¼šå½±å“åˆ°åŸä»¶çš„å€¼ã€‚

### å¼•ç”¨ç±»å‹æ˜¯å€¼ä¼ é€’å—ï¼Ÿ

å°ä¼™ä¼´ä»¬ä¹‹æ‰€ä»¥ä¸ç¡®å®š Java æ˜¯å€¼ä¼ é€’è¿˜æ˜¯å¼•ç”¨ä¼ é€’çš„ï¼ŒåŸå› å°±å‡ºåœ¨è¿™ä¸ªå¼•ç”¨ç±»å‹ä¸Šé¢ã€‚å•ä»å­—é¢çš„æ„æ€ä¸Šå°±å®¹æ˜“æ··æ·†ï¼šå¼•ç”¨ç±»å‹ä¸æ˜¯å¼•ç”¨ä¼ é€’å—ï¼Ÿéš¾é“è¿˜æ˜¯å€¼ä¼ é€’å—ï¼Ÿ

```java
public static void main(String[] args) {
    int[] arr = { 1, 2, 3, 4, 5 };
    System.out.println(arr[0]);
    change(arr);
    System.out.println(arr[0]);
}

public static void change(int[] array) {
    // å°†æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å˜ä¸º0
    array[0] = 0;
}
```

è¾“å‡ºç»“æœä¸ºï¼š

```text
1
0
```

å¾ˆå¤šçœ‹äº†è¿™ä¸ªæ¡ˆä¾‹çš„å°ä¼™ä¼´è‚¯å®šä¼šè§‰å¾— Java å¯¹å¼•ç”¨ç±»å‹çš„å‚æ•°é‡‡ç”¨çš„å¼•ç”¨ä¼ é€’ã€‚å®é™…ä¸Šï¼Œå¹¶ä¸æ˜¯çš„ï¼Œè¿™é‡Œä¼ é€’çš„è¿˜æ˜¯å€¼ï¼Œåªä¸è¿‡è¿™ä¸ªå€¼æ˜¯**å®å‚çš„åœ°å€**ï¼ä¹Ÿå°±æ˜¯è¯´ `change()` æ–¹æ³•çš„ `array` å½¢å‚æ‹·è´çš„æ˜¯å®å‚ `arr` çš„åœ°å€ï¼Œå› æ­¤ï¼Œ**å®ƒå’Œ `arr` æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªæ•°ç»„å¯¹è±¡**ï¼Œè¿™ä¹Ÿå°±è¯´æ˜äº†ä¸ºä»€ä¹ˆæ–¹æ³•å†…éƒ¨å¯¹å½¢å‚çš„ä¿®æ”¹ä¼šå½±å“åˆ°å®å‚ã€‚

ä¸ºäº†æ›´å¼ºæœ‰åŠ›åœ°åé©³ Java å¯¹å¼•ç”¨ç±»å‹çš„å‚æ•°é‡‡ç”¨çš„ä¸æ˜¯å¼•ç”¨ä¼ é€’ï¼Œå’±ä»¬å†æ¥çœ‹ä¸‹ä¸‹é¢è¿™ä¸ªæ¡ˆä¾‹ï¼

```java
public class Person {
    private String name;
   // çœç•¥æ„é€ å‡½æ•°ã€Getter&Setteræ–¹æ³•
}

public static void main(String[] args) {
    Person xiaoZhang = new Person("å°å¼ ");
    Person xiaoLi = new Person("å°æ");
    swap(xiaoZhang, xiaoLi);
    System.out.println("xiaoZhang:" + xiaoZhang.getName());
    System.out.println("xiaoLi:" + xiaoLi.getName());
}

public static void swap(Person person1, Person person2) {
    Person temp = person1;
    person1 = person2;
    person2 = temp;
    System.out.println("person1:" + person1.getName());
    System.out.println("person2:" + person2.getName());
}
```

è¾“å‡ºç»“æœä¸ºï¼š

```text
person1:å°æ
person2:å°å¼ 
xiaoZhang:å°å¼ 
xiaoLi:å°æ
```

`swap()` æ–¹æ³•çš„å‚æ•° `person1` å’Œ `person2` æ‹·è´çš„åªæ˜¯å®å‚ `xiaoZhang` å’Œ `xiaoLi` çš„åœ°å€ã€‚å› æ­¤ï¼Œ `person1` å’Œ `person2` çš„äº’æ¢åªæ˜¯æ‹·è´çš„ä¸¤ä¸ªåœ°å€è¿›è¡Œäº’æ¢ç½¢äº†ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å®å‚ `xiaoZhang` å’Œ `xiaoLi` ã€‚

å’±ä»¬é€šè¿‡ä¸€å¼ å›¾å°±èƒ½éå¸¸æ¸…æ™°è¿™ä¸ªè¿‡ç¨‹ã€‚

![image-20221125061322645](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061428812.png)

åœ¨è¿›è¡Œäº¤æ¢å‰ï¼Œ`person1` å’Œ `xiaoZhang` æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼ˆ`å°å¼ `ï¼‰ï¼Œ`person2` å’Œ `xiaoLi` æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼ˆ`å°æ`ï¼‰ï¼Œäº¤æ¢ä¹‹åï¼Œåªæ˜¯è®© `person1` æŒ‡å‘ `å°æ` å¯¹è±¡ï¼Œ`person2` æŒ‡å‘ `å°å¼ ` å¯¹è±¡ï¼Œè€Œ `xiaoZhang` å’Œ `xiaoLi` æŒ‡å‘çš„è¿˜æ˜¯åŸæ¥çš„å¯¹è±¡ï¼Œå¹¶æœªæ”¹å˜ï¼Œæ‰€ä»¥è¾“å‡ºçš„ç»“æœå¦‚ä¸Šæ‰€ç¤ºã€‚

## æµ…æ‹·è´å’Œæ·±æ‹·è´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå®ƒçš„å®ç°æ–¹å¼æœ‰å“ªäº›ï¼Ÿ

### æµ…æ‹·è´

#### å®šä¹‰

æµ…æ‹·è´ï¼ˆ`Shadow Clone`ï¼‰ï¼ŒæŠŠåŸå¯¹è±¡ä¸­å€¼ç±»å‹çš„æˆå‘˜å˜é‡ä¸ºå’Œå¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡çš„å¼•ç”¨åœ°å€å¤åˆ¶ç»™å…‹éš†å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**åŸå¯¹è±¡å’Œå…‹éš†å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡æŒ‡å‘çš„æ˜¯å †å†…å­˜ä¸­çš„åŒä¸€ä¸ªå¯¹è±¡**ã€‚

![](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061429904.png)

#### å®ç°æ–¹å¼

éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ç‚¹è¦æ±‚ï¼š

1. ç±»éœ€è¦ **å®ç° `Cloneable` æ¥å£**ã€‚å¦‚æœæ²¡æœ‰å®ç° `Cloneable` æ¥å£å°±è°ƒç”¨ `clone()` æ–¹æ³•åˆ™ä¼šæŠ›å‡º `CloneNotSupportedException` å¼‚å¸¸ã€‚
2. **é‡å†™ `Object` ç±»ä¸­çš„ `clone()` æ–¹æ³•**ã€‚`Object` ç±»ä¸­çš„ `clone()` æ–¹æ³•æºç å¦‚ä¸‹æ‰€ç¤ºï¼š

   ```java
   protected native Object clone() throws CloneNotSupportedException;
   ```

   æ–¹æ³•è¢« `protected` æ‰€ä¿®é¥°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªç±»ä¸æ˜¾å¼åœ°å»é‡å†™ `clone()` æ–¹æ³•ï¼Œå…¶ä»–ç±»æ˜¯æ— æ³•è°ƒç”¨è¯¥ç±»å®ä¾‹çš„ `clone()` æ–¹æ³•çš„ã€‚
   
   åœ¨è¯¥æ–¹æ³•çš„æ³¨é‡Šä¸Šå¯ä»¥å‘ç° `clone()` æ–¹æ³•æœ‰ä»¥ä¸‹çº¦å®šï¼š
   
   - å¯¹äºæ‰€æœ‰å¯¹è±¡æ¥è¯´ï¼Œ`x.clone() != x` åº”å½“è¿”å› trueï¼Œå› ä¸º **å…‹éš†å¯¹è±¡ä¸åŸå¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡**ã€‚
   - å¯¹äºæ‰€æœ‰å¯¹è±¡æ¥è¯´ï¼Œ`x.clone().getClass() == x.getClass()` åº”å½“è¿”å› trueï¼Œå› ä¸º **å…‹éš†å¯¹è±¡ä¸åŸå¯¹è±¡çš„ç±»å‹æ˜¯ä¸€æ ·çš„**ã€‚
   - å¯¹äºæ‰€æœ‰å¯¹è±¡æ¥è¯´ï¼Œ`x.clone().equals(x)` åº”å½“è¿”å› trueï¼Œå› ä¸ºä½¿ç”¨ `equals()` æ–¹æ³•è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œ**å…‹éš†å¯¹è±¡ä¸åŸå¯¹è±¡çš„çš„å€¼éƒ½æ˜¯ç›¸åŒçš„**ã€‚

ä¸¾ä¸ªä¾‹å­æ¼”ç¤ºä¸€ä¸‹ï¼š

```java
public class Test4 {
    private static final Logger LOGGER = LoggerFactory.getLogger(Test4.class);

    public static void main(String[] args) throws CloneNotSupportedException {
        Address address = new Address(1, "changsha");
        People p1 = new People(1, "xiaorang", address);
        People p2 = p1.clone();

        LOGGER.info("p1 == p2 ? {}", p1 == p2);
        p1.getAddress().setCity("shenzhen");
        LOGGER.info("p2.getAddress().getCity() = {}", p2.getAddress().getCity());
    }
}

@Data
@AllArgsConstructor
class People implements Cloneable {
    private Integer id;
    private String name;
    private Address address;

    @Override
    protected People clone() throws CloneNotSupportedException {
        return (People) super.clone();
    }
}

@Data
@AllArgsConstructor
class Address {
    private Integer id;
    private String city;
}
```

è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
2022-11-30 12:17:21.310 [main] INFO  t.x.i.j.Test4:23 - p1 == p2 ? false
2022-11-30 12:17:21.317 [main] INFO  t.x.i.j.Test4:25 - p2.getAddress().getCity() = shenzhen
```

åˆ†æï¼š`p1 != p2`ï¼Œè¯´æ˜ **åŸå¯¹è±¡å’Œå…‹éš†å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡**ã€‚`p1.getAddress().setCity("shenzhen");` å½“ä¿®æ”¹åŸå‹å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡ä¸­çš„å±æ€§æ—¶ï¼Œå…‹éš†å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡ä¸­çš„å±æ€§ä¹Ÿä¼šè·Ÿç€ä¸€æ ·æ”¹å˜ `p2.getAddress().getCity() = shenzhen`ï¼Œè¯´æ˜ **åŸå¯¹è±¡å’Œå…‹éš†å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡æŒ‡å‘çš„æ˜¯å †å†…å­˜ä¸­çš„åŒä¸€ä¸ªå¯¹è±¡**ã€‚

### æ·±æ‹·è´

#### å®šä¹‰

æ·±æ‹·è´ï¼ˆ`Deep Clone`ï¼‰ï¼Œå°†åŸå¯¹è±¡ä¸­æ‰€æœ‰ç±»å‹ï¼ˆæ— è®ºæ˜¯å€¼ç±»å‹è¿˜æ˜¯å¼•ç”¨ç±»å‹ï¼‰çš„æˆå‘˜å˜é‡éƒ½å¤åˆ¶ä¸€ä»½ç»™å…‹éš†å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**åŸå¯¹è±¡å’Œå…‹éš†å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡æŒ‡å‘çš„æ˜¯å †å†…å­˜ä¸­ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡**ã€‚

![](https://fastly.jsdelivr.net/gh/xihuanxiaorang/img/202311061429411.png)

#### å®ç°æ–¹å¼

##### å…‹éš†åµŒå¥—

```java
@Data
@AllArgsConstructor
class People implements Cloneable {
    private Integer id;
    private String name;
    private Address address;

    @Override
    protected People clone() throws CloneNotSupportedException {
        People people = (People) super.clone();
        people.setAddress(this.address.clone());
        return people;
    }
}

@Data
@AllArgsConstructor
class Address implements Cloneable {
    private Integer id;
    private String city;

    @Override
    protected Address clone() throws CloneNotSupportedException {
        return (Address) super.clone();
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
2022-11-30 13:02:28.377 [main] INFO  t.x.i.j.Test4:23 - p1 == p2 ? false
2022-11-30 13:02:28.381 [main] INFO  t.x.i.j.Test4:25 - p2.getAddress().getCity() = changsha
```

åˆ†æï¼š`p1 != p2`ï¼Œè¯´æ˜ **åŸå¯¹è±¡å’Œå…‹éš†å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡**ã€‚`p1.getAddress().setCity("shenzhen");` å½“ä¿®æ”¹åŸå‹å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡ä¸­çš„å±æ€§æ—¶ï¼Œå…‹éš†å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡ä¸­çš„å±æ€§å¹¶ä¸ä¼šè·Ÿç€æ”¹å˜ `p2.getAddress().getCity() = changsha`ï¼Œè¯´æ˜ **åŸå¯¹è±¡å’Œå…‹éš†å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡æŒ‡å‘çš„æ˜¯å †å†…å­˜ä¸­ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡**ã€‚

##### é€šè¿‡æ„é€ æ–¹æ³•

Effective Java ä¸­æ¨èçš„æ–¹å¼ã€‚

```java
public class Test4 {
    private static final Logger LOGGER = LoggerFactory.getLogger(Test4.class);

    public static void main(String[] args) throws CloneNotSupportedException {
        Address address = new Address(1, "changsha");
        People p1 = new People(1, "xiaorang", address);
        People p2 = new People(p1);

        LOGGER.info("p1 == p2 ? {}", p1 == p2);
        p1.getAddress().setCity("shenzhen");
        LOGGER.info("p2.getAddress().getCity() = {}", p2.getAddress().getCity());
    }
}

@Data
@AllArgsConstructor
class People {
    private Integer id;
    private String name;
    private Address address;

    public People(People original) {
        this.id = original.id;
        this.name = original.name;
        this.address = new Address(original.address);
    }
}

@Data
@AllArgsConstructor
class Address {
    private Integer id;
    private String city;

    public Address(Address original) {
        this.id = original.id;
        this.city = original.city;
    }
}
```

##### é€šè¿‡ JDK è‡ªå¸¦çš„å­—èŠ‚æµ

```java
public class Test4 {
    private static final Logger LOGGER = LoggerFactory.getLogger(Test4.class);

    public static void main(String[] args) {
        Address address = new Address(1, "changsha");
        People p1 = new People(1, "xiaorang", address);
        People p2 = StreamClone.clone(p1);

        LOGGER.info("p1 == p2 ? {}", p1 == p2);
        p1.getAddress().setCity("shenzhen");
        LOGGER.info("p2.getAddress().getCity() = {}", p2.getAddress().getCity());
    }
}

@Data
@AllArgsConstructor
class People implements Serializable {
    private Integer id;
    private String name;
    private Address address;
}

@Data
@AllArgsConstructor
class Address implements Serializable {
    private Integer id;
    private String city;
}
```

å…¶ä¸­ï¼Œ`StreamClone` ä¸ºè‡ªå®šä¹‰çš„ä¸€ä¸ªä½¿ç”¨ JDK è‡ªå¸¦çš„å­—èŠ‚æµå®ç°çš„æ·±åº¦å…‹éš†å·¥å…·ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
public class StreamClone {
    public static <T extends Serializable> T clone(T obj) {
        T cloneObj;
        try (
                ByteArrayOutputStream bos = new ByteArrayOutputStream();
                ObjectOutputStream oos = new ObjectOutputStream(bos);
        ) {
            oos.writeObject(obj);
            try (
                    ByteArrayInputStream bis = new ByteArrayInputStream(bos.toByteArray());
                    ObjectInputStream ois = new ObjectInputStream(bis);
            ) {
                cloneObj = (T) ois.readObject();
            } catch (ClassNotFoundException e) {
                throw new RuntimeException(e);
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
        return cloneObj;
    }
}
```

##### ä½¿ç”¨ JSON å·¥å…·ç±»

ä½¿ç”¨ JSON å·¥å…·ç±»å®ç°æ·±æ‹·è´ï¼Œå¦‚ Gson æˆ–è€… FastJson ç­‰ã€‚

å¼•å…¥ Gson ä¾èµ–ï¼š

```xml
<dependency>
   <groupId>com.google.code.gson</groupId>
   <artifactId>gson</artifactId>
   <version>2.8.7</version>
</dependency>
```

```java
public class Test4 {
    private static final Logger LOGGER = LoggerFactory.getLogger(Test4.class);

    public static void main(String[] args) {
        Address address = new Address(1, "changsha");
        People p1 = new People(1, "xiaorang", address);
        Gson gson = new Gson();
        People p2 = gson.fromJson(gson.toJson(p1), People.class);

        LOGGER.info("p1 == p2 ? {}", p1 == p2);
        p1.getAddress().setCity("shenzhen");
        LOGGER.info("p2.getAddress().getCity() = {}", p2.getAddress().getCity());
    }
}

@Data
@AllArgsConstructor
class People implements Serializable {
    private Integer id;
    private String name;
    private Address address;
}

@Data
@AllArgsConstructor
class Address implements Serializable {
    private Integer id;
    private String city;
}
```

